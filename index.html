<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Contable Modular</title>
    <!-- Carga de Tailwind CSS para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Configuraciones básicas para la tipografía */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Estilo para el botón de la pestaña activa */
        .tab-active {
            background-color: #10b981; /* Esmeralda 500 */
            color: white;
            font-weight: 600;
            border-left: 4px solid #059669; /* Esmeralda 600 */
        }
        .tab-group-title {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            margin-top: 1rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para el bloque de egreso que se oculta/muestra por JS */
        .egreso-fields {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 700px; /* Suficiente para contener todos los campos */
            opacity: 1;
            overflow: hidden;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        /* Clase para ocultar el bloque con transición */
        .egreso-fields.hidden-manual {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            margin-top: 0 !important;
            border-top: none !important;
        }
    </style>
</head>
<body>

    <!-- 0. Login Modal Overlay -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 flex items-center justify-center transition-opacity duration-300">
        <!-- Contenido del Modal de Login -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Iniciar Sesión</h2>
            <div id="login-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
            <!-- El valor está vacío, usa Dulce para la demo -->
            <input type="text" id="login-username" placeholder="Nombre de usuario" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-4">

            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
            <!-- El valor está vacío, usa 1234 para la demo -->
            <input type="password" id="login-password" placeholder="Contraseña" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-6" onkeyup="if(event.key === 'Enter') handleLogin()">

            <button onclick="handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-lg transition-colors duration-200 shadow-lg transform hover:scale-[1.01]">
                Acceder
            </button>

            <!-- Se mantiene la información de las credenciales de demo para el usuario -->
            <p class="text-center text-xs text-gray-500 mt-4">Credenciales de Demo: Usuario: <code class="font-bold text-gray-700">Dulce</code>, Contraseña: <code class="font-bold text-gray-700">1234</code></p>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">

        <!-- 1. Barra de Navegación Lateral (Sidebar) -->
        <aside class="w-64 bg-white shadow-xl flex flex-col transition-all duration-300">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-gray-800">Caja Pro</h1>
                <p class="text-xs text-gray-500 mt-1">App Contable</p>
            </div>

            <!-- Menú de Pestañas (Refactorizado para incluir las nuevas secciones) -->
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                
                <!-- Grupo 1: Resumen -->
                <button
                    id="tab-dashboard"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200 tab-active"
                    onclick="switchTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    Dashboard
                </button>
                <button
                    id="tab-reports"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('reports')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2m4 0l2-2v13m7-6h-2M4 6h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>
                    Reportes
                </button>

                <!-- Separador de Grupo: Transacciones -->
                <div class="tab-group-title">MOVIMIENTOS</div>
                
                <button
                    id="tab-ingresos"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('ingresos')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Ingresos
                </button>
                <button
                    id="tab-egresos"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('egresos')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Egresos
                </button>
                
                <!-- Gasolina (Filtro de Egresos) -->
                <button
                    id="tab-gasolina"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('gasolina')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 2 2m-2-2v13.5M3 10h18M7 16h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v7a2 2 0 002 2z" /></svg>
                    Gasolina
                </button>

                <!-- Separador de Grupo: Gestión -->
                 <div class="tab-group-title">ADMINISTRACIÓN</div>

                <button
                    id="tab-nomina"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('nomina')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Nómina
                </button>
                <button
                    id="tab-profesores"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('profesores')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M20 10a8 8 0 01-16 0V7a2 2 0 012-2h4M9 16v-1a4 4 0 014-4h.5a4 4 0 014 4v1m-4.5 4H8.25" /></svg>
                    Pagos a Profesores
                </button>
                <button
                    id="tab-conciliacion"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('conciliacion')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Conciliación Bancaria
                </button>
                <button
                    id="tab-proyecciones"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('proyecciones')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Proyecciones
                </button>
            </nav>

            <!-- Información del Usuario/ID (MANDATORIO para apps colaborativas) -->
            <div class="p-4 border-t border-gray-100 text-xs bg-gray-50">
                <p class="font-semibold text-gray-600">ID de Usuario (UID):</p>
                <code id="user-id-display" class="block w-full text-xs text-gray-500 truncate mt-1">Cargando...</code>
            </div>
        </aside>

        <!-- 2. Área de Contenido Principal -->
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Barra superior para el nombre de la pestaña actual y acciones -->
            <header class="mb-8 p-4 bg-white shadow rounded-lg flex justify-between items-center">
                <h2 id="current-tab-title" class="text-3xl font-extrabold text-gray-800">Dashboard</h2>
                <!-- Botón para abrir el modal de nueva transacción. Ahora solo se muestra en Ingresos/Egresos/Gasolina -->
                <button id="add-transaction-button" onclick="showTransactionModal()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 hidden">
                    + Nueva Transacción
                </button>
            </header>

            <!-- Contenedores de las Pestañas (Solo una visible a la vez) -->

            <!-- Pestaña 1: Dashboard -->
            <section id="content-dashboard" class="tab-content">
                <!-- Contenido se actualiza dinámicamente -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">¡Bienvenido!</h3>
                    <p class="text-gray-600">Este es el panel principal de tu aplicación contable. Aquí se mostrarán los resúmenes clave (saldos, ingresos/egresos) una vez que carguemos los datos de Transacciones.</p>
                    <div id="loading-state" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-md">
                        Inicializando Firebase y autenticación...
                    </div>
                    <div id="auth-ready" class="hidden mt-4 p-3 bg-green-100 text-green-800 rounded-md">
                        Autenticación de Firebase lista. Ingresa tus credenciales en el modal.
                    </div>
                </div>
            </section>

            <!-- Pestaña 2: Ingresos (Usará la misma lógica de Transacciones, filtrada) -->
            <section id="content-ingresos" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Ingreso' -->
            </section>

            <!-- Pestaña 3: Egresos (Usará la misma lógica de Transacciones, filtrada) -->
            <section id="content-egresos" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Egreso' -->
            </section>

            <!-- Pestaña 4: Gasolina (NUEVA) -->
            <section id="content-gasolina" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Egreso' y clasificación 'Gasolina' -->
            </section>
            
            <!-- Pestaña 5: Reportes -->
            <section id="content-reports" class="tab-content hidden">
                 <!-- Este contenido será llenado por renderReports() -->
            </section>

            <!-- Pestaña 6: Nómina (NUEVA) -->
            <section id="content-nomina" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">Gestión de Nómina</h3>
                    <p class="text-gray-600 mt-2">Aquí gestionarás los pagos recurrentes, impuestos y deducciones de los empleados. (Funcionalidad por desarrollar).</p>
                </div>
            </section>

            <!-- Pestaña 7: Pagos a Profesores (NUEVA) -->
            <section id="content-profesores" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">Registro de Pagos a Profesores</h3>
                    <p class="text-gray-600 mt-2">Interfaz para registrar y liquidar pagos específicos relacionados con la carga horaria o servicios de los profesores. (Funcionalidad por desarrollar).</p>
                </div>
            </section>

             <!-- Pestaña 8: Conciliación Bancaria (NUEVA) -->
            <section id="content-conciliacion" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">Conciliación Bancaria</h3>
                    <p class="text-gray-600 mt-2">Herramienta para comparar y conciliar las transacciones registradas en el sistema contra los extractos bancarios. (Funcionalidad por desarrollar).</p>
                </div>
            </section>

            <!-- Pestaña 9: Proyecciones (NUEVA) -->
            <section id="content-proyecciones" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">Modelos de Proyección Financiera</h3>
                    <p class="text-gray-600 mt-2">Herramienta para crear y visualizar proyecciones de flujo de efectivo futuras basadas en datos históricos. (Funcionalidad por desarrollar).</p>
                </div>
            </section>

        </main>
    </div>

    <!-- 3. Modal para Agregar/Editar Transacción (Formulario) -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <!-- Contenedor del Modal -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Nueva Transacción</h3>
            <!-- Mensaje de error/éxito del formulario -->
             <div id="transaction-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="transaction-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="transaction-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Ingreso">Ingreso</option>
                            <option value="Egreso">Egreso</option>
                        </select>
                    </div>

                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <!-- Deshabilitado para Gasolina, se calcula automáticamente -->
                        <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-gray-100">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-detalle" class="block text-sm font-medium text-gray-700">Detalle</label>
                        <input type="text" id="transaction-detalle" required placeholder="Detalle general de la transacción" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <!-- Bloque de Campos Específicos de Egreso Estándar -->
                    <div id="egreso-standard-fields" class="egreso-fields hidden-manual md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 border-gray-100">
                        <h4 class="md:col-span-2 text-md font-semibold text-gray-600 mb-2">Detalles Adicionales (Egreso Estándar)</h4>

                        <!-- Proveedor/Solicitante -->
                        <div>
                            <label for="transaction-proveedor" class="block text-sm font-medium text-gray-700">Proveedor/Solicitante (Obligatorio)</label>
                            <input type="text" id="transaction-proveedor" placeholder="Nombre del tercero" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Referencia de Pago -->
                        <div>
                            <label for="transaction-referencia" class="block text-sm font-medium text-gray-700">Referencia de Pago</label>
                            <input type="text" id="transaction-referencia" placeholder="Cheque, transferencia, factura #" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Concepto (Cuenta Contable) -->
                        <div>
                            <label for="transaction-concepto" class="block text-sm font-medium text-gray-700">Concepto (Cuenta Contable, Obligatorio)</label>
                            <input type="text" id="transaction-concepto" placeholder="Arriendo, Servicios, Sueldos..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Empresa (Entidad) -->
                        <div>
                            <label for="transaction-empresa" class="block text-sm font-medium text-gray-700">Empresa (Entidad)</label>
                            <input type="text" id="transaction-empresa" placeholder="Sede A, Sede B, General" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Clasificación (Dropdown) -->
                        <div class="md:col-span-2">
                            <label for="transaction-clasificacion-standard" class="block text-sm font-medium text-gray-700">Clasificación</label>
                            <select id="transaction-clasificacion-standard" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="Otros Egresos">Otros Egresos</option>
                                <option value="Gastos Dr Conde">Gastos Dr Conde</option>
                                <option value="Gastos Operativos">Gastos Operativos</option>
                                <option value="Gastos Administrativos">Gastos Administrativos</option>
                                <!-- Nota: La clasificación Gasolina se maneja en el bloque específico -->
                            </select>
                        </div>
                    </div>
                    <!-- FIN Bloque Egreso Estándar -->
                    
                    <!-- Bloque de Campos Específicos de Gasolina (NUEVO) -->
                    <div id="egreso-gasolina-fields" class="egreso-fields hidden-manual md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 border-gray-100">
                        <h4 class="md:col-span-2 text-md font-semibold text-gray-600 mb-2">Registro de Factura de Gasolina</h4>

                        <!-- Nombre (Selector para autocompletado de Tarjeta) -->
                        <div>
                            <label for="gasolina-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <select id="gasolina-nombre" class="calc-gasolina-auto mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">-- Seleccionar Nombre --</option>
                                <option value="Jorge">Jorge</option>
                                <option value="María">María</option>
                                <option value="Dulce">Dulce</option>
                            </select>
                        </div>
                        
                        <!-- #Tarjeta (Autocompletado) -->
                        <div>
                            <label for="gasolina-tarjeta" class="block text-sm font-medium text-gray-700"># Tarjeta / Clave</label>
                            <input type="text" id="gasolina-tarjeta" placeholder="Autocompletado..." readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100">
                        </div>
                        
                        <!-- Auto (Selector para autocompletado de Marca) -->
                        <div>
                            <label for="gasolina-auto" class="block text-sm font-medium text-gray-700">Auto</label>
                             <select id="gasolina-auto" class="calc-gasolina-auto mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">-- Seleccionar Auto --</option>
                                <option value="Sentra">Sentra</option>
                                <option value="Spark">Spark</option>
                                <option value="Pilot">Pilot</option>
                            </select>
                        </div>

                        <!-- Marca (Autocompletado) -->
                        <div>
                            <label for="gasolina-marca" class="block text-sm font-medium text-gray-700">Marca</label>
                            <input type="text" id="gasolina-marca" placeholder="Autocompletado..." readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100">
                        </div>
                        
                        <!-- Cantidad -->
                        <div>
                            <label for="gasolina-cantidad" class="block text-sm font-medium text-gray-700">Cantidad (Litros)</label>
                            <input type="number" id="gasolina-cantidad" step="0.01" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Precio -->
                        <div>
                            <label for="gasolina-precio" class="block text-sm font-medium text-gray-700">Precio (por Litro)</label>
                            <input type="number" id="gasolina-precio" step="0.01" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Subtotal (Ingreso Manual) -->
                        <div>
                            <label for="gasolina-subtotal" class="block text-sm font-medium text-gray-700 font-bold">SUBTOTAL (Ingreso Manual)</label>
                            <input type="number" id="gasolina-subtotal" step="0.01" placeholder="0.00" class="calc-subtotal mt-1 block w-full px-3 py-2 border-2 border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-semibold text-gray-800">
                        </div>
                        
                        <!-- IVA (Calculado) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">IVA (16%)</label>
                            <input type="text" id="gasolina-iva" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100 text-red-600 font-semibold">
                        </div>

                        <!-- Total (Calculado) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">TOTAL (Monto Final)</label>
                            <input type="text" id="gasolina-total" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100 text-2xl text-emerald-600 font-bold">
                        </div>
                        
                        <!-- Forma de Pago -->
                        <div class="md:col-span-2">
                            <label for="gasolina-forma-pago" class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                            <select id="gasolina-forma-pago" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="Tarjeta de Credito">Tarjeta de Crédito</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                        </div>
                        
                        <!-- Adjuntar Comprobante -->
                        <div class="md:col-span-2">
                            <label for="gasolina-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                            <input type="file" id="gasolina-comprobante" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                        </div>

                    </div>
                    <!-- FIN Bloque Egreso Gasolina -->

                    <!-- Campo oculto para el ID en caso de edición -->
                    <input type="hidden" id="transaction-id">
                    <input type="hidden" id="current-transaction-tab" value="ingresos"> <!-- Nuevo campo para rastrear la pestaña que abrió el modal -->
                    <input type="hidden" id="gasolina-comprobante-url"> <!-- Para guardar la URL si se editara -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideTransactionModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                        Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal de Confirmación (Reemplazo de window.confirm) -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h4 class="text-lg font-bold text-gray-800 mb-4" id="confirm-title">Confirmar Acción</h4>
            <p class="text-gray-600 mb-6" id="confirm-message">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-proceed" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-md">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Lógica de Firebase y de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase (necesarias para la persistencia de datos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Se añaden addDoc, collection y deleteDoc para la gestión de transacciones
        import { getFirestore, setDoc, doc, collection, onSnapshot, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('debug');

        // Variables Globales OBLIGATORIAS proporcionadas por el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const IVA_RATE = 0.16; // 16% IVA para cálculos

        let app, db, auth, userId = null;
        let transactions = []; // Almacenará los datos de las transacciones
        let monthlyChart = null; // Variable para almacenar la instancia del gráfico
        let activeTab = 'dashboard'; // Nueva variable para rastrear la pestaña activa
        
        // --- MAPA DE DATOS FICTICIO PARA AUTOCOMPLETADO DE GASOLINA ---
        const gasolinaDataMap = {
            nombres: {
                "Jorge": "6576",
                "María": "9801",
                "Dulce": "1234"
            },
            autos: {
                "Sentra": "Nissan",
                "Spark": "Chevrolet",
                "Pilot": "Honda"
            }
        };


        // --- LÓGICA DE AUTENTICACIÓN DEMO ---
        const DEMO_USER = "Dulce";
        const DEMO_PASS = "1234";

        // Función para mostrar la interfaz principal de la aplicación
        const showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            console.log("Inicio de sesión exitoso. Aplicación principal visible.");
        };

        // Función para manejar el inicio de sesión simulado
        window.handleLogin = () => {
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const messageDisplay = document.getElementById('login-message');

            messageDisplay.classList.add('hidden');
            messageDisplay.textContent = '';

            if (usernameInput === DEMO_USER && passwordInput === DEMO_PASS) {
                // Login exitoso
                showAppUI();
            } else {
                // Login fallido
                messageDisplay.textContent = "Credenciales incorrectas. Intenta con 'Dulce' / '1234'.";
                messageDisplay.classList.remove('hidden');
                console.warn("Intento de login fallido.");
            }
        };

        // --- LÓGICA DE FIREBASE Y TRANSACCIONES ---

        /**
         * Ruta de la colección de transacciones para el usuario actual.
         * Colección privada: /artifacts/{appId}/users/{userId}/transactions
         */
        const getTransactionsCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore o userId no están disponibles.");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'transactions');
        };

        // Escucha en tiempo real los cambios en las transacciones del usuario
        const setupTransactionsListener = () => {
            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            // La consulta simple es suficiente (sin orderBy para evitar errores de índice)
            const q = query(transactionsRef);

            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Procesamiento y renderizado de transacciones
                console.log("Transacciones cargadas en tiempo real:", transactions);
                
                // Actualiza todas las vistas dependientes
                renderTransactionsList('ingresos');
                renderTransactionsList('egresos');
                renderTransactionsList('gasolina'); // Renderizar la nueva pestaña
                updateDashboardSummary();
                
                // Solo si la pestaña de reportes está activa, la actualizamos
                if (activeTab === 'reports') {
                    renderReports();
                }

            }, (error) => {
                console.error("Error al escuchar transacciones:", error);
            });
        };

        // Muestra un mensaje temporal en el modal de transacción
        const showTransactionMessage = (message, isError = true) => {
            const msgElement = document.getElementById('transaction-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            // Cambia el color si es un error o éxito
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            // Ocultar después de 5 segundos
            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };
        
        // Guardar o Actualizar Transacción
        window.saveTransaction = async (event) => {
            event.preventDefault();

            const id = document.getElementById('transaction-id').value;
            const type = document.getElementById('transaction-type').value;
            
            const detalle = document.getElementById('transaction-detalle').value; 
            const date = document.getElementById('transaction-date').value;

            if (!detalle || !date) {
                showTransactionMessage("Por favor, rellena los campos básicos: Detalle y Fecha."); 
                return;
            }
            
            const isGasolina = (type === 'Egreso' && document.getElementById('egreso-gasolina-fields').classList.contains('active-fields'));

            let amount;

            if (isGasolina) {
                // Para Gasolina, tomamos el Total calculado
                amount = parseFloat(document.getElementById('gasolina-total').value.replace('$', '').replace(',', '')) || 0;
            } else {
                // Para Ingreso/Egreso Estándar, tomamos el Monto manual
                amount = parseFloat(document.getElementById('transaction-amount').value);
            }

            if (isNaN(amount) || amount <= 0) {
                 showTransactionMessage("El Monto Total (o Monto, si no es Gasolina) debe ser positivo."); 
                 return;
            }

            const transactionData = {
                type: type,
                detalle: detalle, 
                date: date,
                timestamp: Date.now(),
                amount: amount // Monto final, sea manual o calculado
            };
            
            if (type === 'Egreso') {
                if (isGasolina) {
                    // --- Guardado de Transacción de GASOLINA ---
                    
                    transactionData.clasificacion = 'Gasolina';
                    
                    // Campos específicos
                    transactionData.nombre = document.getElementById('gasolina-nombre').value.trim();
                    transactionData.tarjeta = document.getElementById('gasolina-tarjeta').value.trim();
                    transactionData.marca = document.getElementById('gasolina-marca').value.trim();
                    transactionData.auto = document.getElementById('gasolina-auto').value.trim();
                    transactionData.cantidad = parseFloat(document.getElementById('gasolina-cantidad').value) || 0;
                    transactionData.precio = parseFloat(document.getElementById('gasolina-precio').value) || 0;
                    
                    // Montos calculados/ingresados
                    transactionData.subtotal = parseFloat(document.getElementById('gasolina-subtotal').value) || 0;
                    transactionData.iva = parseFloat(document.getElementById('gasolina-iva').value.replace('$', '').replace(',', '')) || 0;
                    transactionData.total = amount; // Ya se verificó que es > 0
                    
                    transactionData.formaPago = document.getElementById('gasolina-forma-pago').value;
                    
                    // Simular manejo de comprobante (solo la URL/nombre)
                    const comprobanteFile = document.getElementById('gasolina-comprobante').files[0];
                    if (comprobanteFile) {
                        transactionData.comprobanteUrl = `gs://storage-path/${id || 'new'}-${comprobanteFile.name}`;
                    } else {
                        transactionData.comprobanteUrl = document.getElementById('gasolina-comprobante-url').value;
                    }


                } else {
                    // --- Guardado de Transacción de EGRESO ESTÁNDAR ---
                    transactionData.proveedor = document.getElementById('transaction-proveedor').value.trim();
                    transactionData.referencia = document.getElementById('transaction-referencia').value.trim();
                    transactionData.concepto = document.getElementById('transaction-concepto').value.trim();
                    transactionData.empresa = document.getElementById('transaction-empresa').value.trim();
                    transactionData.clasificacion = document.getElementById('transaction-clasificacion-standard').value;
                    
                    // Validación para campos obligatorios de Egreso Estándar
                    if (!transactionData.proveedor || !transactionData.concepto) {
                        showTransactionMessage("Para Egresos estándar, el Proveedor/Solicitante y el Concepto son obligatorios.");
                        return;
                    }
                }
            }

            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            try {
                if (id) {
                    await setDoc(doc(transactionsRef, id), transactionData);
                    showTransactionMessage("Transacción actualizada con éxito.", false);
                } else {
                    await addDoc(transactionsRef, transactionData);
                    showTransactionMessage("Nueva transacción agregada con éxito.", false);
                }
                setTimeout(hideTransactionModal, 1500); 
            } catch (e) {
                showTransactionMessage(`Error al guardar la transacción: ${e.message}`);
                console.error("Error al guardar la transacción:", e);
            }
        };
        
        // Función para editar: rellena el formulario y abre el modal
        window.editTransaction = (id) => {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Llenar campos básicos
            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-detalle').value = transaction.detalle || ''; 
            document.getElementById('transaction-date').value = transaction.date;
            
            // Configurar el campo oculto para que el modal sepa qué tipo es al reabrirse
            let tabToOpen = 'ingresos';
            if (transaction.type === 'Ingreso') {
                tabToOpen = 'ingresos';
            } else if (transaction.type === 'Egreso' && transaction.clasificacion === 'Gasolina') {
                 tabToOpen = 'gasolina';
            } else {
                tabToOpen = 'egresos';
            }
            document.getElementById('current-transaction-tab').value = tabToOpen;

            document.getElementById('modal-title').textContent = "Editar Transacción";
            
            // Cargar campos específicos
            if (transaction.type === 'Egreso') {
                if (transaction.clasificacion === 'Gasolina') {
                    // Cargar campos de Gasolina
                    document.getElementById('gasolina-nombre').value = transaction.nombre || '';
                    document.getElementById('gasolina-tarjeta').value = transaction.tarjeta || '';
                    document.getElementById('gasolina-marca').value = transaction.marca || '';
                    document.getElementById('gasolina-auto').value = transaction.auto || '';
                    document.getElementById('gasolina-cantidad').value = transaction.cantidad || '';
                    document.getElementById('gasolina-precio').value = transaction.precio || '';
                    document.getElementById('gasolina-forma-pago').value = transaction.formaPago || 'Tarjeta de Credito';
                    document.getElementById('gasolina-comprobante-url').value = transaction.comprobanteUrl || '';
                    
                    // Cargar montos y recalcular (El subtotal es el que se ingresa manualmente)
                    document.getElementById('gasolina-subtotal').value = transaction.subtotal ? transaction.subtotal.toFixed(2) : (transaction.amount / (1 + IVA_RATE)).toFixed(2);
                    calculateGasolinaTotals();

                } else {
                    // Cargar campos de Egreso Estándar
                    document.getElementById('transaction-proveedor').value = transaction.proveedor || '';
                    document.getElementById('transaction-referencia').value = transaction.referencia || '';
                    document.getElementById('transaction-concepto').value = transaction.concepto || '';
                    document.getElementById('transaction-empresa').value = transaction.empresa || '';
                    document.getElementById('transaction-clasificacion-standard').value = transaction.clasificacion || 'Otros Egresos';
                }
            }

            // Mostrar modal con bandera de edición
            window.showTransactionModal(true); 
        };

        // Función para eliminar: usa el modal de confirmación
        window.deleteTransaction = async (id) => {
            const action = async () => {
                const transactionsRef = getTransactionsCollectionRef();
                if (!transactionsRef) return;
                
                try {
                    await deleteDoc(doc(transactionsRef, id));
                    console.log("Transacción eliminada con ID:", id);
                } catch (e) {
                    console.error("Error al eliminar la transacción:", e);
                }
            };
            
            showConfirmModal("Eliminar Transacción", "¿Estás seguro de que quieres eliminar esta transacción? Esta acción es irreversible.", action);
        };

        // --- UTILS ---
        const formatCurrency = (value) => `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);

        /**
         * Calcula el IVA y el Total a partir del Subtotal (Ingreso manual).
         */
        const calculateGasolinaTotals = () => {
            // Se toma el Subtotal ingresado manualmente
            const subtotalInput = document.getElementById('gasolina-subtotal').value;
            const subtotal = parseFloat(subtotalInput) || 0;
            
            if (subtotal <= 0) {
                 document.getElementById('gasolina-iva').value = formatCurrency(0);
                 document.getElementById('gasolina-total').value = formatCurrency(0);
                 document.getElementById('transaction-amount').value = 0;
                 return;
            }

            const iva = subtotal * IVA_RATE;
            const total = subtotal + iva;

            document.getElementById('gasolina-iva').value = formatCurrency(iva);
            document.getElementById('gasolina-total').value = formatCurrency(total);
            
            // Sincronizar el Monto general (transaction-amount) con el Total
            document.getElementById('transaction-amount').value = total.toFixed(2);
        };
        
        /**
         * Autocompleta los campos de Tarjeta y Marca según la selección.
         */
        window.autoCompleteGasolinaFields = () => {
            const nombre = document.getElementById('gasolina-nombre').value;
            const auto = document.getElementById('gasolina-auto').value;
            
            // Autocompletar Tarjeta por Nombre
            const tarjeta = gasolinaDataMap.nombres[nombre] || '';
            document.getElementById('gasolina-tarjeta').value = tarjeta;

            // Autocompletar Marca por Auto
            const marca = gasolinaDataMap.autos[auto] || '';
            document.getElementById('gasolina-marca').value = marca;
        };


        // --- RENDERIZADO DE VISTAS ---

        /**
         * Función para renderizar la tabla de transacciones.
         * @param {('ingresos'|'egresos'|'gasolina')} tabName - La pestaña a renderizar.
         */
        const renderTransactionsList = (tabName) => {
            const contentId = `content-${tabName}`;
            const content = document.getElementById(contentId);
            if (!content) return;

            let title, requiredType, requiredClassification = null;

            if (tabName === 'ingresos') {
                title = 'Listado de Ingresos';
                requiredType = 'Ingreso';
            } else if (tabName === 'egresos') {
                title = 'Listado de Egresos Estándar';
                requiredType = 'Egreso';
                requiredClassification = '!Gasolina'; // Mostrar todo EXCEPTO Gasolina
            } else if (tabName === 'gasolina') {
                title = 'Gastos de Gasolina (Egreso Detallado)';
                requiredType = 'Egreso';
                requiredClassification = 'Gasolina';
            } else {
                return;
            }

            let filteredTransactions = transactions.filter(t => t.type === requiredType);

            if (requiredClassification) {
                if (requiredClassification === '!Gasolina') {
                    // Filtrar por todo lo que NO sea Gasolina
                    filteredTransactions = filteredTransactions.filter(t => t.clasificacion !== 'Gasolina' || !t.clasificacion);
                } else {
                    // Filtrar por la clasificación específica (e.g., 'Gasolina')
                    filteredTransactions = filteredTransactions.filter(t => t.clasificacion === requiredClassification);
                }
            }
            
            let tableHeaders, tableBodyMapper;

            if (requiredType === 'Ingreso') {
                tableHeaders = `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.detalle || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-green-600 font-semibold">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            } else if (tabName === 'gasolina') { // Egreso Gasolina
                tableHeaders = `
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conductor / Auto</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">FP</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                 tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${t.nombre || 'N/A'} / ${t.auto || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${(t.cantidad || 0).toFixed(2)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${formatCurrency(t.subtotal || 0)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${formatCurrency(t.iva || 0)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-red-600 font-semibold">
                            ${formatCurrency(t.total || t.amount)}
                        </td>
                         <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-600">${t.formaPago || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            } else { // Egreso Estándar
                tableHeaders = `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor/Solicitante</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.proveedor || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${t.concepto || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                ${t.clasificacion || 'N/A'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-red-600 font-semibold">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            }
            
            // 3. Renderizar HTML
            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">${title}</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>${tableHeaders}</tr>
                        </thead>
                        <tbody id="transactions-table-body-${tabName}" class="bg-white divide-y divide-gray-200">
                            <!-- Filas inyectadas por JS -->
                        </tbody>
                    </table>
                    ${filteredTransactions.length === 0 ? `<p class="px-6 py-4 text-center text-gray-500">No hay ${title.toLowerCase().split('de ')[1] || 'transacciones'} registradas.</p>` : ''}
                </div>
            `;
            
            const tbody = document.getElementById(`transactions-table-body-${tabName}`);
            if (!tbody) return;

            // Ordenar por fecha (más reciente primero)
            const sortedTransactions = filteredTransactions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB - dateA; 
                }
                return b.timestamp - a.timestamp;
            });

            tbody.innerHTML = sortedTransactions.map(tableBodyMapper).join('');
        };

        // Función para actualizar el resumen del Dashboard
        const updateDashboardSummary = () => {
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'Ingreso') {
                    totalIncome += t.amount;
                } else if (t.type === 'Egreso') {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            const balanceClass = currentBalance >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';

            const dashboardContent = document.getElementById('content-dashboard');
            dashboardContent.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <!-- Tarjeta de Saldo Actual -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Saldo Actual</p>
                        <p class="${balanceClass} mt-1">${formatCurrency(currentBalance)}</p>
                    </div>
                    <!-- Tarjeta de Ingresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <!-- Tarjeta de Egresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-2xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Resumen de la Actividad</h3>
                    <p class="text-gray-600">Total de transacciones registradas: <span class="font-bold text-lg text-emerald-600">${transactions.length}</span></p>
                </div>
            `;
        };

        // Función para renderizar la pestaña de Reportes (mantenida igual)
        const renderReports = () => {
            // ... (Lógica de Reportes sin cambios, usa los mismos totales) ...
            // 1. Agrupar transacciones por mes y año
            const monthlyData = transactions.reduce((acc, t) => {
                // Formato YYYY-MM
                const monthYear = t.date.substring(0, 7); 
                const amount = t.amount;
                const type = t.type;

                if (!acc[monthYear]) {
                    acc[monthYear] = { Ingreso: 0, Egreso: 0 };
                }

                acc[monthYear][type] += amount;
                return acc;
            }, {});

            // 2. Preparar datos para Chart.js
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                return `${monthNames[parseInt(month) - 1]}-${year.substring(2)}`;
            });

            const incomeData = sortedMonths.map(my => monthlyData[my].Ingreso);
            const expenseData = sortedMonths.map(my => monthlyData[my].Egreso);

            // 3. Calcular Ganancias y Pérdidas totales para el reporte
            let totalIncome = 0;
            let totalExpense = 0;
            transactions.forEach(t => {
                if (t.type === 'Ingreso') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            const netProfit = totalIncome - totalExpense;
            const netProfitClass = netProfit >= 0 ? 'text-green-600' : 'text-red-600';


            // 4. Renderizar el HTML de la pestaña de Reportes
            const content = document.getElementById('content-reports');
            content.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Reporte de Flujo de Efectivo y P&G</h3>
                
                <!-- Tarjetas de Resumen P&G (Ganancias y Pérdidas) -->
                <div id="pg-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Ingresos -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <!-- Egresos -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                    <!-- Utilidad Neta -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Utilidad Neta</p>
                        <p class="text-xl font-bold ${netProfitClass} mt-1">${formatCurrency(netProfit)}</p>
                    </div>
                </div>

                <!-- Gráfico de Barras Mensual -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Ingresos vs Egresos Mensuales</h4>
                    <div class="relative h-96">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    ${transactions.length === 0 ? '<p class="text-center text-gray-500 mt-4">Agrega transacciones para ver el gráfico.</p>' : ''}
                </div>
            `;

            // 5. Destruir gráfico anterior si existe y crear el nuevo
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            if (transactions.length > 0) {
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: incomeData,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)', // emerald-500
                                borderColor: 'rgba(5, 150, 105, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Egresos',
                                data: expenseData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)', // red-500
                                borderColor: 'rgba(220, 38, 38, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Flujo de Efectivo'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };
        
        // --- LÓGICA DE MODALES (Transacción y Confirmación) ---
        
        window.showTransactionModal = (isEditing = false) => {
            const transactionTypeSelect = document.getElementById('transaction-type');
            const egresoStandardDiv = document.getElementById('egreso-standard-fields');
            const egresoGasolinaDiv = document.getElementById('egreso-gasolina-fields');
            const transactionAmountInput = document.getElementById('transaction-amount');
            
            // Limpiar formulario y reiniciar campos obligatorios si no estamos editando
            if (!isEditing) {
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-id').value = '';
                document.getElementById('transaction-date').valueAsDate = new Date(); 
                document.getElementById('modal-title').textContent = "Nueva Transacción";
                document.getElementById('transaction-message').classList.add('hidden'); 
                calculateGasolinaTotals(); // Reiniciar cálculos de Gasolina
            }
            
            // 1. Determinar el tipo inicial basado en la pestaña activa
            let determinedType = transactionTypeSelect.value;
            const currentTab = document.getElementById('current-transaction-tab').value;

            if (!isEditing) {
                if (currentTab === 'ingresos') {
                    determinedType = 'Ingreso';
                } else if (currentTab === 'egresos' || currentTab === 'gasolina') {
                    determinedType = 'Egreso';
                }
                transactionTypeSelect.value = determinedType;
            }

            // 2. Toggle visibility and set required status
            const toggleFields = (type) => {
                const isEgreso = type === 'Egreso';
                // La pestaña activa determina si debe verse el formulario detallado de Gasolina
                const isGasolinaTab = isEgreso && currentTab === 'gasolina'; 
                
                // --- Configuración de campos generales ---
                transactionAmountInput.disabled = isGasolinaTab; // Deshabilitar monto si es Gasolina
                transactionAmountInput.required = !isGasolinaTab; // Requerir monto si es Ingreso o Egreso Estándar
                
                // --- Toggle bloques ---
                if (isGasolinaTab) {
                    // Mostrar Gasolina, Ocultar Estándar
                    egresoGasolinaDiv.classList.remove('hidden-manual');
                    egresoGasolinaDiv.classList.add('active-fields');
                    egresoStandardDiv.classList.add('hidden-manual');
                    egresoStandardDiv.classList.remove('active-fields');
                    
                    // Solo requerimos el Subtotal
                    document.getElementById('gasolina-subtotal').required = true;

                    // Remover obligatoriedad de campos de Egreso Estándar
                    document.getElementById('transaction-proveedor').required = false;
                    document.getElementById('transaction-concepto').required = false;

                } else if (isEgreso) {
                    // Mostrar Estándar, Ocultar Gasolina
                    egresoStandardDiv.classList.remove('hidden-manual');
                    egresoStandardDiv.classList.add('active-fields');
                    egresoGasolinaDiv.classList.add('hidden-manual');
                    egresoGasolinaDiv.classList.remove('active-fields');
                    
                    // Hacer obligatorios los campos clave de Egreso Estándar
                    document.getElementById('transaction-proveedor').required = true;
                    document.getElementById('transaction-concepto').required = true;
                    
                    // Remover obligatoriedad de Gasolina
                    document.getElementById('gasolina-subtotal').required = false;

                } else { // Ingreso
                    // Ocultar ambos
                    egresoStandardDiv.classList.add('hidden-manual');
                    egresoStandardDiv.classList.remove('active-fields');
                    egresoGasolinaDiv.classList.add('hidden-manual');
                    egresoGasolinaDiv.classList.remove('active-fields');
                    
                    // Remover obligatoriedad de campos de egreso
                    document.getElementById('transaction-proveedor').required = false;
                    document.getElementById('transaction-concepto').required = false;
                    document.getElementById('gasolina-subtotal').required = false;
                }
            };
            
            toggleFields(determinedType);
            
            // 3. Listener para cambios manuales en el select
            transactionTypeSelect.onchange = () => {
                // Si el usuario cambia manualmente el tipo, asumimos que sale de la vista específica
                if (transactionTypeSelect.value === 'Egreso') {
                    document.getElementById('current-transaction-tab').value = 'egresos'; // Vuelve a la vista estándar
                } else {
                    document.getElementById('current-transaction-tab').value = 'ingresos';
                }
                toggleFields(transactionTypeSelect.value);
            };

            // 4. Agregar listeners de cálculo para Subtotal de Gasolina
            document.querySelectorAll('.calc-subtotal').forEach(input => {
                input.oninput = calculateGasolinaTotals;
            });
            
            // 5. Agregar listeners de autocompletado (solo si es la pestaña de gasolina)
            if (currentTab === 'gasolina') {
                 autoCompleteGasolinaFields(); // Ejecutar al cargar la edición
                 document.getElementById('gasolina-nombre').onchange = autoCompleteGasolinaFields;
                 document.getElementById('gasolina-auto').onchange = autoCompleteGasolinaFields;
            }
            
            document.getElementById('transaction-modal').classList.remove('hidden');
        };

        window.hideTransactionModal = () => {
            document.getElementById('transaction-modal').classList.add('hidden');
        };

        // Función genérica de confirmación (reemplaza window.confirm)
        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const modal = document.getElementById('confirm-modal');
            const btnProceed = document.getElementById('confirm-proceed');
            const btnCancel = document.getElementById('confirm-cancel');

            // Limpiar listeners anteriores
            btnProceed.replaceWith(btnProceed.cloneNode(true));
            btnCancel.replaceWith(btnCancel.cloneNode(true));
            
            const newBtnProceed = document.getElementById('confirm-proceed');
            const newBtnCancel = document.getElementById('confirm-cancel');

            // Configurar el botón de proceder
            newBtnProceed.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };

            // Configurar el botón de cancelar
            newBtnCancel.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        };

        // Inicialización de Firebase
        const initApp = async () => {
            console.log("Inicializando Firebase...");
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configuración de Firebase no disponible. Usando valores predeterminados.");
                }

                // 1. Inicializar la aplicación
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Establecer el observador de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const authReady = document.getElementById('auth-ready');
                    const userIdDisplay = document.getElementById('user-id-display');
                    const loginModal = document.getElementById('login-modal');

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        loadingState.classList.add('hidden');
                        authReady.classList.remove('hidden');
                        
                        if (document.getElementById('app-container').classList.contains('hidden')) {
                             loginModal.classList.remove('hidden');
                        } else {
                            // Si ya estamos dentro (login de demo exitoso), empezamos a escuchar los datos
                            setupTransactionsListener();
                        }

                        console.log(`Usuario Firebase autenticado. UID: ${userId}`);

                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'No autenticado';
                        loadingState.textContent = 'Intentando autenticación anónima...';
                        authReady.classList.add('hidden');
                        loadingState.classList.remove('hidden');
                        loginModal.classList.remove('hidden'); 
                        console.warn("Usuario no autenticado, intentando sign-in.");
                    }
                });

                // 3. Intentar iniciar sesión con Firebase (custom token o anónimo)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Conectar el formulario de guardado a la función de guardado
                document.getElementById('transaction-form').addEventListener('submit', window.saveTransaction);

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                document.getElementById('loading-state').textContent = `Error crítico: ${error.message}. Verifica la configuración.`;
            }
        };

        // Función global para cambiar de pestaña/vista
        window.switchTab = (tabName) => {
            // Lista de todas las pestañas
            const tabs = ['dashboard', 'ingresos', 'egresos', 'gasolina', 'reports', 'nomina', 'profesores', 'conciliacion', 'proyecciones'];
            activeTab = tabName; // Actualizar la pestaña activa

            // Lógica para mostrar/ocultar el botón de "Nueva Transacción"
            const addButton = document.getElementById('add-transaction-button');
            const transactionTabField = document.getElementById('current-transaction-tab');
            
            if (tabName === 'ingresos' || tabName === 'egresos' || tabName === 'gasolina') {
                addButton.classList.remove('hidden');
                // Almacenar la pestaña actual en un campo oculto del modal para preseleccionar el tipo de transacción
                transactionTabField.value = tabName; 
            } else {
                addButton.classList.add('hidden');
            }

            // Ocultar todos los contenidos y desactivar botones
            tabs.forEach(tab => {
                document.getElementById(`content-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });

            // Mostrar el contenido y activar el botón de la pestaña seleccionada
            const contentElement = document.getElementById(`content-${tabName}`);
            const buttonElement = document.getElementById(`tab-${tabName}`);
            const titleElement = document.getElementById('current-tab-title');

            if (contentElement && buttonElement) {
                contentElement.classList.remove('hidden');
                buttonElement.classList.add('tab-active');
                titleElement.textContent = buttonElement.textContent.trim();
                
                // Llama al renderizado específico si es necesario
                if (tabName === 'ingresos') {
                    renderTransactionsList('ingresos');
                } else if (tabName === 'egresos') {
                    renderTransactionsList('egresos');
                } else if (tabName === 'gasolina') {
                    renderTransactionsList('gasolina');
                } else if (tabName === 'reports' && transactions.length > 0) {
                    renderReports();
                }
            }
        };


        // Iniciar la aplicación al cargar la ventana
        window.addEventListener('load', initApp);

        // Asegurar que el listener de transacciones inicie al mostrar la UI
        window.showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Si el login de demo fue exitoso, y ya tenemos el userId de Firebase, iniciamos el listener.
            if (userId) {
                setupTransactionsListener();
            }
        };
        
    </script>
</body>
</html>
