<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Contable Modular</title>
    <!-- Carga de Tailwind CSS para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Configuraciones básicas para la tipografía */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Estilo para el botón de la pestaña activa */
        .tab-active {
            background-color: #10b981; /* Esmeralda 500 */
            color: white;
            font-weight: 600;
            border-left: 4px solid #059669; /* Esmeralda 600 */
        }
    </style>
</head>
<body>

    <!-- 0. Login Modal Overlay -->
    <!-- Este overlay aparecerá por encima de la aplicación hasta que el login sea exitoso. -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 flex items-center justify-center transition-opacity duration-300">
        <!-- Contenido del Modal de Login -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Iniciar Sesión</h2>
            <div id="login-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
            <!-- El valor está vacío, usa Dulce para la demo -->
            <input type="text" id="login-username" placeholder="Nombre de usuario" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-4">

            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
            <!-- El valor está vacío, usa 1234 para la demo -->
            <input type="password" id="login-password" placeholder="Contraseña" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-6" onkeyup="if(event.key === 'Enter') handleLogin()">

            <button onclick="handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-lg transition-colors duration-200 shadow-lg transform hover:scale-[1.01]">
                Acceder
            </button>

            <!-- Se mantiene la información de las credenciales de demo para el usuario -->
            <p class="text-center text-xs text-gray-500 mt-4">Credenciales de Demo: Usuario: <code class="font-bold text-gray-700">Dulce</code>, Contraseña: <code class="font-bold text-gray-700">1234</code></p>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación -->
    <!-- Inicialmente oculto (hidden) hasta que el login sea exitoso -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">

        <!-- 1. Barra de Navegación Lateral (Sidebar) -->
        <aside class="w-64 bg-white shadow-xl flex flex-col transition-all duration-300">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-gray-800">Caja Pro</h1>
                <p class="text-xs text-gray-500 mt-1">App Contable</p>
            </div>

            <!-- Menú de Pestañas -->
            <nav class="flex-grow p-4 space-y-2">
                <!-- Pestaña 1: Dashboard (por defecto) -->
                <button
                    id="tab-dashboard"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200 tab-active"
                    onclick="switchTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Dashboard
                </button>

                <!-- Pestaña 2: Transacciones (Funcionalidad principal) -->
                <button
                    id="tab-transactions"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('transactions')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8V6m0 2v2m0 2v2m0 2v2M4 12h16" />
                    </svg>
                    Transacciones
                </button>

                <!-- Pestaña 3: Reportes (Implementación en este bloque) -->
                <button
                    id="tab-reports"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('reports')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2m4 0l2-2v13m7-6h-2M4 6h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" />
                    </svg>
                    Reportes
                </button>
            </nav>

            <!-- Información del Usuario/ID (MANDATORIO para apps colaborativas) -->
            <div class="p-4 border-t border-gray-100 text-xs bg-gray-50">
                <p class="font-semibold text-gray-600">ID de Usuario (UID):</p>
                <code id="user-id-display" class="block w-full text-xs text-gray-500 truncate mt-1">Cargando...</code>
            </div>
        </aside>

        <!-- 2. Área de Contenido Principal -->
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Barra superior para el nombre de la pestaña actual y acciones -->
            <header class="mb-8 p-4 bg-white shadow rounded-lg flex justify-between items-center">
                <h2 id="current-tab-title" class="text-3xl font-extrabold text-gray-800">Dashboard</h2>
                <!-- Botón para abrir el modal de nueva transacción. Solo visible en la pestaña Transacciones. -->
                <button id="add-transaction-button" onclick="showTransactionModal()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 hidden">
                    + Nueva Transacción
                </button>
            </header>

            <!-- Contenedores de las Pestañas (Solo una visible a la vez) -->

            <!-- Pestaña 1: Dashboard (Tablero Principal) - Contenido renderizado por JS (updateDashboardSummary) -->
            <section id="content-dashboard" class="tab-content">
                <!-- Contenido se actualiza dinámicamente -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">¡Bienvenido!</h3>
                    <p class="text-gray-600">Este es el panel principal de tu aplicación contable. Aquí se mostrarán los resúmenes clave (saldos, ingresos/egresos) una vez que carguemos los datos de Transacciones.</p>
                    <div id="loading-state" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-md">
                        Inicializando Firebase y autenticación...
                    </div>
                    <div id="auth-ready" class="hidden mt-4 p-3 bg-green-100 text-green-800 rounded-md">
                        Autenticación de Firebase lista. Ingresa tus credenciales en el modal.
                    </div>
                </div>
            </section>

            <!-- Pestaña 2: Transacciones (Listado) - Contenido renderizado por JS (renderTransactionsList) -->
            <section id="content-transactions" class="tab-content hidden">
                <!-- Contenido se actualiza dinámicamente -->
            </section>

            <!-- Pestaña 3: Reportes (Contenido nuevo: Gráficos y Resumen P&G) -->
            <section id="content-reports" class="tab-content hidden">
                 <!-- Este contenido será llenado por renderReports() -->
            </section>
        </main>
    </div>

    <!-- 3. Modal para Agregar/Editar Transacción (Formulario) -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <!-- Contenedor del Modal -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Nueva Transacción</h3>
            <!-- Mensaje de error/éxito del formulario -->
             <div id="transaction-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="transaction-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="transaction-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Ingreso">Ingreso</option>
                            <option value="Egreso">Egreso</option>
                        </select>
                    </div>

                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <input type="text" id="transaction-description" required placeholder="Venta de servicio, Pago de renta, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <!-- Campo oculto para el ID en caso de edición -->
                    <input type="hidden" id="transaction-id">
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideTransactionModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                        Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal de Confirmación (Reemplazo de window.confirm) -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h4 class="text-lg font-bold text-gray-800 mb-4" id="confirm-title">Confirmar Acción</h4>
            <p class="text-gray-600 mb-6" id="confirm-message">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-proceed" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-md">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Lógica de Firebase y de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase (necesarias para la persistencia de datos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Se añaden addDoc, collection y deleteDoc para la gestión de transacciones
        import { getFirestore, setDoc, doc, collection, onSnapshot, query, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('debug');

        // Variables Globales OBLIGATORIAS proporcionadas por el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let transactions = []; // Almacenará los datos de las transacciones
        let monthlyChart = null; // Variable para almacenar la instancia del gráfico

        // --- LÓGICA DE AUTENTICACIÓN DEMO ---
        const DEMO_USER = "Dulce";
        const DEMO_PASS = "1234";

        // Función para mostrar la interfaz principal de la aplicación
        const showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            console.log("Inicio de sesión exitoso. Aplicación principal visible.");
        };

        // Función para manejar el inicio de sesión simulado
        window.handleLogin = () => {
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const messageDisplay = document.getElementById('login-message');

            messageDisplay.classList.add('hidden');
            messageDisplay.textContent = '';

            if (usernameInput === DEMO_USER && passwordInput === DEMO_PASS) {
                // Login exitoso
                showAppUI();
            } else {
                // Login fallido
                messageDisplay.textContent = "Credenciales incorrectas. Intenta con 'Dulce' / '1234'.";
                messageDisplay.classList.remove('hidden');
                console.warn("Intento de login fallido.");
            }
        };

        // --- LÓGICA DE FIREBASE Y TRANSACCIONES ---

        /**
         * Ruta de la colección de transacciones para el usuario actual.
         * Colección privada: /artifacts/{appId}/users/{userId}/transactions
         */
        const getTransactionsCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore o userId no están disponibles.");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'transactions');
        };

        // Escucha en tiempo real los cambios en las transacciones del usuario
        const setupTransactionsListener = () => {
            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            // La consulta simple es suficiente (sin orderBy para evitar errores de índice)
            const q = query(transactionsRef);

            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Procesamiento y renderizado de transacciones
                console.log("Transacciones cargadas en tiempo real:", transactions);
                renderTransactionsList();
                updateDashboardSummary();
                if (!document.getElementById('content-reports').classList.contains('hidden')) {
                    // Solo si la pestaña de reportes está activa, la actualizamos
                    renderReports();
                }

            }, (error) => {
                console.error("Error al escuchar transacciones:", error);
            });
        };

        // Muestra un mensaje temporal en el modal de transacción
        const showTransactionMessage = (message, isError = true) => {
            const msgElement = document.getElementById('transaction-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            // Cambia el color si es un error o éxito
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            // Ocultar después de 5 segundos
            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };
        
        // Guardar o Actualizar Transacción
        window.saveTransaction = async (event) => {
            event.preventDefault();

            const id = document.getElementById('transaction-id').value;
            const type = document.getElementById('transaction-type').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const description = document.getElementById('transaction-description').value;
            const date = document.getElementById('transaction-date').value;

            if (isNaN(amount) || amount <= 0 || !description || !date) {
                showTransactionMessage("Por favor, rellena todos los campos correctamente. El monto debe ser positivo."); 
                return;
            }

            const transactionData = {
                type: type,
                amount: amount,
                description: description,
                date: date,
                // Usamos el timestamp para un ordenamiento secundario si es necesario
                timestamp: Date.now() 
            };

            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            try {
                if (id) {
                    // Editar transacción existente
                    await setDoc(doc(transactionsRef, id), transactionData);
                    showTransactionMessage("Transacción actualizada con éxito.", false);
                } else {
                    // Agregar nueva transacción
                    await addDoc(transactionsRef, transactionData);
                    showTransactionMessage("Nueva transacción agregada con éxito.", false);
                }

                // Dar tiempo para que el mensaje se vea antes de cerrar el modal
                setTimeout(hideTransactionModal, 1500); 
            } catch (e) {
                showTransactionMessage(`Error al guardar la transacción: ${e.message}`);
                console.error("Error al guardar la transacción:", e);
            }
        };
        
        // Función para editar: rellena el formulario y abre el modal
        window.editTransaction = (id) => {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Llenar el formulario con los datos de la transacción
            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-description').value = transaction.description;
            document.getElementById('transaction-date').value = transaction.date;

            document.getElementById('modal-title').textContent = "Editar Transacción";
            window.showTransactionModal();
        };

        // Función para eliminar: usa el modal de confirmación
        window.deleteTransaction = async (id) => {
            const action = async () => {
                const transactionsRef = getTransactionsCollectionRef();
                if (!transactionsRef) return;
                
                try {
                    await deleteDoc(doc(transactionsRef, id));
                    console.log("Transacción eliminada con ID:", id);
                } catch (e) {
                    console.error("Error al eliminar la transacción:", e);
                }
            };
            
            // Usar el modal de confirmación personalizado
            showConfirmModal("Eliminar Transacción", "¿Estás seguro de que quieres eliminar esta transacción? Esta acción es irreversible.", action);
        };

        // --- UTILS ---
        const formatCurrency = (value) => `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;

        // --- RENDERIZADO DE VISTAS ---

        // Función para renderizar la tabla de transacciones
        const renderTransactionsList = () => {
            const content = document.getElementById('content-transactions');
            
            // Contenido de la pestaña Transacciones
            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Listado de Transacciones</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Filas inyectadas por JS -->
                        </tbody>
                    </table>
                    ${transactions.length === 0 ? '<p class="px-6 py-4 text-center text-gray-500">No hay transacciones registradas.</p>' : ''}
                </div>
            `;
            
            const tbody = document.getElementById('transactions-table-body');
            if (!tbody) return;

            // Ordenar por fecha (más reciente primero), ya que Firestore no se ordena por defecto sin índices.
            // Si las fechas son iguales, usamos el timestamp
            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB - dateA; // Ordenar por fecha
                }
                return b.timestamp - a.timestamp; // Si las fechas son iguales, ordenar por timestamp
            });

            tbody.innerHTML = sortedTransactions.map(t => {
                const isIncome = t.type === 'Ingreso';
                const amountClass = isIncome ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                const formattedAmount = formatCurrency(t.amount); 
                
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isIncome ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${t.type}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm ${amountClass}">
                            ${formattedAmount}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        // Función para actualizar el resumen del Dashboard
        const updateDashboardSummary = () => {
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'Ingreso') {
                    totalIncome += t.amount;
                } else if (t.type === 'Egreso') {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            const balanceClass = currentBalance >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';

            const dashboardContent = document.getElementById('content-dashboard');
            dashboardContent.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <!-- Tarjeta de Saldo Actual -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Saldo Actual</p>
                        <p class="${balanceClass} mt-1">${formatCurrency(currentBalance)}</p>
                    </div>
                    <!-- Tarjeta de Ingresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <!-- Tarjeta de Egresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-2xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Resumen de la Actividad</h3>
                    <p class="text-gray-600">Total de transacciones registradas: <span class="font-bold text-lg text-emerald-600">${transactions.length}</span></p>
                </div>
            `;
        };

        // Función para renderizar la pestaña de Reportes
        const renderReports = () => {
            // 1. Agrupar transacciones por mes y año
            const monthlyData = transactions.reduce((acc, t) => {
                // Formato YYYY-MM
                const monthYear = t.date.substring(0, 7); 
                const amount = t.amount;
                const type = t.type;

                if (!acc[monthYear]) {
                    acc[monthYear] = { Ingreso: 0, Egreso: 0 };
                }

                acc[monthYear][type] += amount;
                return acc;
            }, {});

            // 2. Preparar datos para Chart.js
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                // Simplemente muestra el mes, el año ya está implícito en el orden
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                return `${monthNames[parseInt(month) - 1]}-${year.substring(2)}`;
            });

            const incomeData = sortedMonths.map(my => monthlyData[my].Ingreso);
            const expenseData = sortedMonths.map(my => monthlyData[my].Egreso);

            // 3. Calcular Ganancias y Pérdidas totales para el reporte
            let totalIncome = 0;
            let totalExpense = 0;
            transactions.forEach(t => {
                if (t.type === 'Ingreso') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            const netProfit = totalIncome - totalExpense;
            const netProfitClass = netProfit >= 0 ? 'text-green-600' : 'text-red-600';


            // 4. Renderizar el HTML de la pestaña de Reportes
            const content = document.getElementById('content-reports');
            content.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Reporte de Flujo de Efectivo y P&G</h3>
                
                <!-- Tarjetas de Resumen P&G (Ganancias y Pérdidas) -->
                <div id="pg-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Ingresos -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <!-- Egresos -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                    <!-- Utilidad Neta -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Utilidad Neta</p>
                        <p class="text-xl font-bold ${netProfitClass} mt-1">${formatCurrency(netProfit)}</p>
                    </div>
                </div>

                <!-- Gráfico de Barras Mensual -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Ingresos vs Egresos Mensuales</h4>
                    <div class="relative h-96">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    ${transactions.length === 0 ? '<p class="text-center text-gray-500 mt-4">Agrega transacciones para ver el gráfico.</p>' : ''}
                </div>
            `;

            // 5. Destruir gráfico anterior si existe y crear el nuevo
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            if (transactions.length > 0) {
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: incomeData,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)', // emerald-500
                                borderColor: 'rgba(5, 150, 105, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Egresos',
                                data: expenseData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)', // red-500
                                borderColor: 'rgba(220, 38, 38, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Flujo de Efectivo'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };
        
        // --- LÓGICA DE MODALES (Transacción y Confirmación) ---
        
        window.showTransactionModal = () => {
            // Limpiar el formulario y prepararlo para una nueva transacción
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-date').valueAsDate = new Date(); // Establecer fecha actual
            document.getElementById('modal-title').textContent = "Nueva Transacción";
            document.getElementById('transaction-message').classList.add('hidden'); // Ocultar mensaje de error anterior
            
            document.getElementById('transaction-modal').classList.remove('hidden');
        };

        window.hideTransactionModal = () => {
            document.getElementById('transaction-modal').classList.add('hidden');
        };

        // Función genérica de confirmación (reemplaza window.confirm)
        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const modal = document.getElementById('confirm-modal');
            const btnProceed = document.getElementById('confirm-proceed');
            const btnCancel = document.getElementById('confirm-cancel');

            // Limpiar listeners anteriores
            btnProceed.replaceWith(btnProceed.cloneNode(true));
            btnCancel.replaceWith(btnCancel.cloneNode(true));
            
            const newBtnProceed = document.getElementById('confirm-proceed');
            const newBtnCancel = document.getElementById('confirm-cancel');

            // Configurar el botón de proceder
            newBtnProceed.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };

            // Configurar el botón de cancelar
            newBtnCancel.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        };

        // Inicialización de Firebase
        const initApp = async () => {
            console.log("Inicializando Firebase...");
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configuración de Firebase no disponible. Usando valores predeterminados.");
                }

                // 1. Inicializar la aplicación
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Establecer el observador de estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const authReady = document.getElementById('auth-ready');
                    const userIdDisplay = document.getElementById('user-id-display');
                    const loginModal = document.getElementById('login-modal');

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        loadingState.classList.add('hidden');
                        authReady.classList.remove('hidden');
                        
                        if (document.getElementById('app-container').classList.contains('hidden')) {
                             loginModal.classList.remove('hidden');
                        } else {
                            // Si ya estamos dentro (login de demo exitoso), empezamos a escuchar los datos
                            setupTransactionsListener();
                        }

                        console.log(`Usuario Firebase autenticado. UID: ${userId}`);

                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'No autenticado';
                        loadingState.textContent = 'Intentando autenticación anónima...';
                        authReady.classList.add('hidden');
                        loadingState.classList.remove('hidden');
                        loginModal.classList.remove('hidden'); 
                        console.warn("Usuario no autenticado, intentando sign-in.");
                    }
                });

                // 3. Intentar iniciar sesión con Firebase (custom token o anónimo)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Conectar el formulario de guardado a la función de guardado
                document.getElementById('transaction-form').addEventListener('submit', window.saveTransaction);

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                document.getElementById('loading-state').textContent = `Error crítico: ${error.message}. Verifica la configuración.`;
            }
        };

        // Función global para cambiar de pestaña/vista
        window.switchTab = (tabName) => {
            const tabs = ['dashboard', 'transactions', 'reports'];
            
            // Lógica para mostrar/ocultar el botón de "Nueva Transacción"
            const addButton = document.getElementById('add-transaction-button');
            if (tabName === 'transactions') {
                addButton.classList.remove('hidden');
            } else {
                addButton.classList.add('hidden');
            }

            // Ocultar todos los contenidos y desactivar botones
            tabs.forEach(tab => {
                document.getElementById(`content-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });

            // Mostrar el contenido y activar el botón de la pestaña seleccionada
            const contentElement = document.getElementById(`content-${tabName}`);
            const buttonElement = document.getElementById(`tab-${tabName}`);
            const titleElement = document.getElementById('current-tab-title');

            if (contentElement && buttonElement) {
                contentElement.classList.remove('hidden');
                buttonElement.classList.add('tab-active');
                titleElement.textContent = buttonElement.textContent.trim();
                
                // Llama al renderizado específico de la pestaña de reportes si es necesario
                if (tabName === 'reports' && transactions.length > 0) {
                    renderReports();
                }
            }
        };


        // Iniciar la aplicación al cargar la ventana
        window.addEventListener('load', initApp);

        // Asegurar que el listener de transacciones inicie al mostrar la UI
        window.showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Si el login de demo fue exitoso, y ya tenemos el userId de Firebase, iniciamos el listener.
            if (userId) {
                setupTransactionsListener();
            }
        };
        
    </script>
</body>
</html>
