<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación Contable Completa</title>
    <!-- Carga Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos generales */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .sidebar { background-color: #1f2937; color: white; transition: width 0.3s; }
        .sidebar-button { justify-content: start; transition: background-color 0.15s, transform 0.1s; }
        .sidebar-button:hover { background-color: #374151; transform: scale(1.02); }
        .sidebar-button.active { background-color: #4b5563; border-left: 4px solid #3b82f6; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        /* Estilos para ocultar campos específicos de Gasolina/Egresos */
        .gasolina-fields, .egreso-fields { display: none; }
        .bg-ingreso { background-color: #d1fae5; color: #065f46; }
        .bg-egreso { background-color: #fee2e2; color: #991b1b; }
        /* Estilo para el área de arrastre de archivos */
        #file-drag-area { border: 2px dashed #9ca3af; transition: border-color 0.3s; }
        #file-drag-area.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
    <!-- CONFIGURACIÓN DE FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables Globales del Entorno Canvas (MANDATORIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        window.userId = null;
        window.transactions = [];
        window.employees = [];
        window.professorPayments = [];
        window.students = [];
        window.conciliations = []; // Nueva lista para datos de conciliación
        window.isAuthReady = false;

        window.formatCurrency = (value) => {
            if (typeof value !== 'number' || isNaN(value)) return '$0.00';
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
        };

        const getCollectionPath = (collectionName, isPrivate = true) => {
            if (!window.userId) return null;
            if (isPrivate) {
                return `/artifacts/${appId}/users/${window.userId}/${collectionName}`;
            } else {
                return `/artifacts/${appId}/public/data/${collectionName}`;
            }
        };

        // --- AUTENTICACIÓN Y LISTENERS ---

        const initApp = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Configuración no disponible.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                let authPromise;
                if (initialAuthToken) {
                    authPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    authPromise = signInAnonymously(auth);
                }
                await authPromise;
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID Usuario: ${user.uid}`;
                        window.isAuthReady = true;

                        // Inicializar Listeners de Datos una vez que el usuario esté listo
                        window.setupTransactionsListener(db);
                        window.setupEmployeesListener(db);
                        window.setupProfessorPaymentsListener(db);
                        window.setupStudentsListener(db);
                        window.setupConciliationsListener(db); // Nuevo listener para Conciliación

                    } else {
                        window.userId = null;
                        window.isAuthReady = true;
                    }
                });
            } catch (error) {
                console.error("Error al inicializar Firebase o Autenticar:", error);
            }
        };

        window.setupTransactionsListener = (dbInstance) => {
            if (!window.userId || !window.isAuthReady) return;
            const path = getCollectionPath('transactions');
            if (!path) return;
            const q = collection(dbInstance, path);
            onSnapshot(q, (snapshot) => {
                window.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Las funciones de renderizado se llaman aquí para actualizar la UI en tiempo real
                window.updateDashboardSummary();
                if (document.getElementById('content-ingresos').classList.contains('active')) window.renderStudentsList();
                if (document.getElementById('content-egresos').classList.contains('active')) window.renderTransactionsList('egreso');
                if (document.getElementById('content-gasolina').classList.contains('active')) {
                    window.renderTransactionsList('gasolina');
                    window.renderGasolinaReports();
                }
                if (document.getElementById('content-reportes').classList.contains('active')) window.renderReports();
                if (document.getElementById('content-profesores').classList.contains('active')) window.renderProfessorPaymentsList();
                if (document.getElementById('content-proyecciones').classList.contains('active')) window.renderProjections();


            }, (error) => {
                console.error("Error en listener de transacciones:", error);
            });
        };

        window.setupEmployeesListener = (dbInstance) => {
            if (!window.userId || !window.isAuthReady) return;
            const path = getCollectionPath('employees');
            if (!path) return;
            const q = collection(dbInstance, path);
            onSnapshot(q, (snapshot) => {
                window.employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('content-nomina').classList.contains('active')) window.renderEmployeesList();
                if (document.getElementById('content-proyecciones').classList.contains('active')) window.renderProjections();
            }, (error) => {
                console.error("Error en listener de empleados:", error);
            });
        };

        window.setupProfessorPaymentsListener = (dbInstance) => {
            if (!window.userId || !window.isAuthReady) return;
            const path = getCollectionPath('professor_payments');
            if (!path) return;
            const q = collection(dbInstance, path);
            onSnapshot(q, (snapshot) => {
                window.professorPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('content-profesores').classList.contains('active')) window.renderProfessorPaymentsList();
            }, (error) => {
                console.error("Error en listener de pagos a profesores:", error);
            });
        };

        window.setupStudentsListener = (dbInstance) => {
            if (!window.userId || !window.isAuthReady) return;
            const path = getCollectionPath('students');
            if (!path) return;
            const q = collection(dbInstance, path);
            onSnapshot(q, (snapshot) => {
                window.students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('content-ingresos').classList.contains('active')) window.renderStudentsList();
                if (document.getElementById('content-proyecciones').classList.contains('active')) window.renderProjections();
            }, (error) => {
                console.error("Error en listener de alumnos:", error);
            });
        };

        window.setupConciliationsListener = (dbInstance) => {
            if (!window.userId || !window.isAuthReady) return;
            const path = getCollectionPath('conciliations');
            if (!path) return;
            const q = collection(dbInstance, path);
            onSnapshot(q, (snapshot) => {
                window.conciliations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('content-conciliacion').classList.contains('active')) window.renderConciliationTable(window.conciliations);
            }, (error) => {
                console.error("Error en listener de conciliaciones:", error);
            });
        };

        // --- LÓGICA DE FIREBASE CRUD GENÉRICA ---

        window.saveDocument = async (collectionName, data, docId = null) => {
            if (!window.userId || !window.isAuthReady) { console.error("Usuario no autenticado o no listo."); return; }
            const path = getCollectionPath(collectionName);
            try {
                if (docId) {
                    await setDoc(doc(db, path, docId), { ...data, updatedAt: serverTimestamp() }, { merge: true });
                } else {
                    await addDoc(collection(db, path), { ...data, createdAt: serverTimestamp() });
                }
            } catch (e) {
                console.error("Error al guardar documento:", e);
            }
        };

        window.deleteDocument = async (collectionName, docId) => {
            if (!window.userId || !window.isAuthReady) { console.error("Usuario no autenticado o no listo."); return; }
            const path = getCollectionPath(collectionName);
            try {
                await deleteDoc(doc(db, path, docId));
            } catch (e) {
                console.error("Error al eliminar documento:", e);
            }
        };
        
        // Inicializar Firebase
        window.onload = initApp;
    </script>
</head>
<body class="min-h-screen flex">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Acceso Contabilidad</h2>
            <div class="space-y-4">
                <input type="text" id="login-user" placeholder="Usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="">
                <input type="password" id="login-password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="">
            </div>
            <button onclick="window.handleLogin()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-lg transition duration-200">
                Iniciar Sesión
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden">Credenciales incorrectas. Usa Dulce/1234.</p>
        </div>
    </div>

    <!-- Main App Container (Initially hidden) -->
    <div id="app-container" class="flex flex-col flex-grow hidden">
        <!-- Sidebar Navigation -->
        <aside class="sidebar w-64 fixed h-full z-30 flex flex-col">
            <div class="p-4 text-2xl font-bold text-blue-400 border-b border-gray-700">Contabilidad U/I</div>
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <button id="nav-dashboard" onclick="window.switchTab('dashboard')" class="sidebar-button flex items-center p-3 w-full rounded-lg active">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6m-6 0h.01"></path></svg>
                    Dashboard
                </button>
                
                <p class="text-xs text-gray-500 uppercase pt-4 pb-1 pl-3 font-semibold">Movimientos</p>
                <button id="nav-ingresos" onclick="window.switchTab('ingresos')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2h-1a2 2 0 01-2-2v-1a2 2 0 012-2h1z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Ingresos (Cobranza)
                </button>
                <button id="nav-egresos" onclick="window.switchTab('egresos')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l-5 5m0 0l5 5m-5-5h12"></path></svg>
                    Egresos Estándar
                </button>
                <button id="nav-gasolina" onclick="window.switchTab('gasolina')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m0 0v-2.19m0 0a3.75 3.75 0 00-7.5 0m7.5 0h-7.5"></path></svg>
                    Gasolina
                </button>

                <p class="text-xs text-gray-500 uppercase pt-4 pb-1 pl-3 font-semibold">Gestión de Personal</p>
                <button id="nav-nomina" onclick="window.switchTab('nomina')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0v2a2 2 0 002 2h4a2 2 0 002-2v-2m-4-2h5"></path></svg>
                    Nómina (Sueldos)
                </button>
                <button id="nav-profesores" onclick="window.switchTab('profesores')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm-6-6a4 4 0 00-4 4h8a4 4 0 00-4-4z"></path></svg>
                    Pagos a Profesores
                </button>

                <p class="text-xs text-gray-500 uppercase pt-4 pb-1 pl-3 font-semibold">Analítica</p>
                <button id="nav-reportes" onclick="window.switchTab('reportes')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path></svg>
                    Reportes
                </button>
                <button id="nav-proyecciones" onclick="window.switchTab('proyecciones')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Proyecciones
                </button>
                <button id="nav-conciliacion" onclick="window.switchTab('conciliacion')" class="sidebar-button flex items-center p-3 w-full rounded-lg">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Conciliación Bancaria
                </button>
            </nav>
            <div class="p-4 border-t border-gray-700 text-xs text-gray-400">
                <p id="user-id-display">ID Usuario: Cargando...</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="ml-64 flex-grow p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-6">
                <h1 id="current-tab-title" class="text-3xl font-bold text-gray-800">Dashboard</h1>
                <button id="new-transaction-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 hidden" onclick="window.showTransactionModal()">
                    + Nueva Transacción
                </button>
                <button id="new-student-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 hidden" onclick="window.showStudentModal()">
                    + Nuevo Alumno
                </button>
                <button id="new-employee-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 hidden" onclick="window.showEmployeeModal()">
                    + Nuevo Empleado
                </button>
                <button id="new-professor-pay-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200 hidden" onclick="window.showProfessorPayModal()">
                    + Registrar Pago
                </button>
            </header>

            <!-- Content Containers -->
            <div id="content-container" class="space-y-6">
                <!-- Dashboard -->
                <div id="content-dashboard" class="tab-content active">
                    <div id="dashboard-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Summary Cards populated by JS -->
                    </div>
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">Gastos Operacionales Clave</h2>
                    <div id="dashboard-kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- KPI Cards populated by JS -->
                    </div>
                    
                    <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700 border-b pb-2">Últimas 10 Transacciones</h2>
                    <div id="latest-transactions-table" class="bg-white p-4 rounded-xl shadow">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-latest-list" class="bg-white divide-y divide-gray-200">
                                <!-- Latest transactions populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ingresos (Cobranza) -->
                <div id="content-ingresos" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Gráfico de Progreso de Cobranza -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Progreso de Cobranza</h3>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="cobranza-chart"></canvas>
                            </div>
                            <div id="cobranza-stats" class="mt-4 text-center text-sm">
                                <!-- Leyendas de la gráfica -->
                            </div>
                        </div>
                        <!-- Matriz de Alumnos y Pagos -->
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Maestro de Alumnos y Estado</h3>
                            <div id="students-list-container" class="overflow-x-auto">
                                <!-- Tabla de Alumnos poblada por JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Egresos Estándar -->
                <div id="content-egresos" class="tab-content hidden">
                    <div id="egresos-list-container" class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Listado de Egresos Estándar</h2>
                        <div id="egresos-table" class="overflow-x-auto">
                            <!-- Tabla de Egresos poblada por JS -->
                        </div>
                    </div>
                </div>

                <!-- Gasolina -->
                <div id="content-gasolina" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Columna de Gráficos -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Gasto por Conductor</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="gasolina-driver-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-xl font-semibold mb-4 text-gray-700">Gasto por Vehículo</h3>
                                <div class="h-64 flex items-center justify-center">
                                    <canvas id="gasolina-car-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <!-- Columna de Listado -->
                        <div class="lg:col-span-2">
                            <div id="gasolina-list-container" class="bg-white p-6 rounded-xl shadow-lg">
                                <h2 class="text-2xl font-semibold mb-4 text-gray-700">Registro Detallado de Gasolina</h2>
                                <div id="gasolina-table" class="overflow-x-auto">
                                    <!-- Tabla de Gasolina poblada por JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nómina -->
                <div id="content-nomina" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Gráfico de Pagos de Nómina -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Progreso de Nómina</h3>
                            <div class="mb-4">
                                <label for="nomina-quincena-selector" class="block text-sm font-medium text-gray-700">Seleccionar Quincena:</label>
                                <select id="nomina-quincena-selector" onchange="window.renderEmployeesList()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="first">Primera Quincena</option>
                                    <option value="second">Segunda Quincena</option>
                                </select>
                            </div>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="nomina-chart"></canvas>
                            </div>
                            <div id="nomina-stats" class="mt-4 text-center text-sm">
                                <p>Total Nómina: <span id="total-nomina-display" class="font-bold"></span></p>
                            </div>
                        </div>
                        <!-- Maestro de Empleados y Registro de Pagos -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Maestro de Empleados y Pagos</h3>
                            <div id="employees-list-container" class="overflow-x-auto">
                                <!-- Tabla de Empleados poblada por JS -->
                            </div>
                            <p class="text-sm text-gray-500 mt-4">Usa la tabla para registrar pagos quincenales.</p>
                        </div>
                    </div>
                </div>

                <!-- Pagos a Profesores -->
                <div id="content-profesores" class="tab-content hidden">
                    <div id="profesor-pagos-list-container" class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Registro y Listado de Pagos a Profesores</h2>
                        <div id="profesor-pagos-table" class="overflow-x-auto">
                            <!-- Tabla de Pagos a Profesores poblada por JS -->
                        </div>
                    </div>
                </div>

                <!-- Reportes -->
                <div id="content-reportes" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Reporte P&G -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg space-y-4">
                            <h3 class="text-xl font-semibold text-gray-700">Ganancias y Pérdidas (P&G)</h3>
                            <div id="pg-summary" class="text-lg">
                                <!-- Resumen P&G poblado por JS -->
                            </div>
                            <button onclick="window.downloadPGReport()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                Descargar Reporte
                            </button>
                        </div>
                        <!-- Gráfico de Flujo de Efectivo Mensual -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700">Flujo de Efectivo Mensual</h3>
                            <div class="h-96">
                                <canvas id="flujo-efectivo-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Proyecciones -->
                <div id="content-proyecciones" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Proyección de Flujo de Caja (Próximos 6 meses)</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-lg font-semibold mb-2">Supuestos Fijos</h3>
                                <p class="text-sm">Nómina Fija Mensual: <span id="proj-nomina-display" class="font-bold text-purple-700">$0.00</span></p>
                                <p class="text-sm">Egreso Gasolina Promedio Mensual: <span id="proj-gasolina-display" class="font-bold text-blue-700">$0.00</span></p>
                                <p class="text-sm mt-3">Total Alumnos Activos: <span id="proj-students-count" class="font-bold text-green-700">0</span></p>
                            </div>
                            <div class="lg:col-span-2 h-72">
                                <canvas id="proyecciones-chart"></canvas>
                            </div>
                        </div>
                        <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700 border-b pb-2">Detalle Mensual Proyectado</h3>
                        <div id="proyecciones-table" class="overflow-x-auto">
                            <!-- Tabla de Proyecciones poblada por JS -->
                        </div>
                    </div>
                </div>

                <!-- Conciliación Bancaria -->
                <div id="content-conciliacion" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Herramienta de Conciliación y Clasificación (Simulación CSV)</h2>
                        
                        <!-- Área de Carga de Archivos -->
                        <div id="file-drag-area" class="p-10 text-center rounded-lg cursor-pointer mb-6" onclick="document.getElementById('file-input').click()">
                            <input type="file" id="file-input" multiple accept=".csv" class="hidden" onchange="window.handleFileSelect(event)">
                            <p class="text-gray-500">Arrastra y suelta tus archivos CSV aquí, o haz clic para seleccionar.</p>
                            <p id="file-count" class="text-sm text-blue-600 mt-2">0 archivos seleccionados</p>
                        </div>

                        <button onclick="window.processFiles()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow transition duration-200 mb-6">
                            Procesar y Guardar Conciliación
                        </button>

                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Resultados de la Conciliación Guardados</h3>
                        <div id="conciliacion-results" class="overflow-x-auto bg-gray-50 p-4 rounded-lg">
                            <p class="text-gray-500">Carga y procesa archivos CSV o espera a que carguen los datos guardados.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals (Transaction, Student Pay, Employee, Confirmation, etc.) -->

    <!-- Modal 1: Registro de Transacción (Ingreso, Egreso Estándar, Gasolina) -->
    <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-gray-800" id="transaction-modal-title">Nueva Transacción</h3>
            <form id="transaction-form" onsubmit="window.saveTransaction(event)">
                <input type="hidden" id="transaction-id">
                <input type="hidden" id="transaction-type">

                <!-- Campos Comunes (Solo visibles para Egreso/Ingreso Estándar) -->
                <div id="general-fields" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="transaction-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="transaction-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto</label>
                            <input type="number" id="transaction-amount" step="0.01" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="transaction-description" class="block text-sm font-medium text-gray-700">Detalle / Descripción General</label>
                        <textarea id="transaction-description" rows="2" class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    </div>
                </div>
                
                <!-- Bloque de Campos Específicos para Egresos ESTÁNDAR -->
                <div id="egreso-fields" class="egreso-fields space-y-4 p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-semibold text-gray-700 border-b pb-2">Detalles de Egreso</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="egreso-provider" class="block text-sm font-medium text-gray-700">Proveedor/Solicitante</label>
                            <input type="text" id="egreso-provider" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="egreso-ref" class="block text-sm font-medium text-gray-700">Referencia de Pago</label>
                            <input type="text" id="egreso-ref" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="egreso-concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                            <input type="text" id="egreso-concepto" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="egreso-empresa" class="block text-sm font-medium text-gray-700">Empresa</label>
                            <select id="egreso-empresa" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="UDC">UDC</option>
                                <option value="IESM">IESM</option>
                                <option value="Externo">Externo</option>
                            </select>
                        </div>
                        <div>
                            <label for="egreso-classification" class="block text-sm font-medium text-gray-700">Clasificación</label>
                            <select id="egreso-classification" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="Gastos Dr Conde">Gastos Dr Conde</option>
                                <option value="Gastos Operativos">Gastos Operativos</option>
                                <option value="Gastos Administrativos">Gastos Administrativos</option>
                                <option value="Gasolina">Gasolina</option>
                                <option value="Sueldos">Sueldos</option>
                                <option value="Pagos Profesores">Pagos a Profesores</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Bloque de Campos Específicos para GASOLINA -->
                <div id="gasolina-fields" class="gasolina-fields space-y-4 p-4 border border-blue-300 rounded-lg bg-blue-50">
                    <h4 class="font-semibold text-blue-700 border-b pb-2">Detalles de Egreso (Gasolina)</h4>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="gasolina-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <select id="gasolina-nombre" onchange="window.updateGasolinaAutoFill('nombre')" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">Seleccionar...</option>
                                <option value="Jorge">Jorge</option>
                                <option value="Diana">Diana</option>
                                <option value="Andres">Andrés</option>
                            </select>
                        </div>
                        <div>
                            <label for="gasolina-tarjeta" class="block text-sm font-medium text-gray-700"># Tarjeta (Auto)</label>
                            <input type="text" id="gasolina-tarjeta" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-gray-200" readonly>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="gasolina-auto" class="block text-sm font-medium text-gray-700">Auto</label>
                            <select id="gasolina-auto" onchange="window.updateGasolinaAutoFill('auto')" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="">Seleccionar...</option>
                                <option value="Sentra">Sentra</option>
                                <option value="CRV">CRV</option>
                                <option value="Civic">Civic</option>
                            </select>
                        </div>
                        <div>
                            <label for="gasolina-marca" class="block text-sm font-medium text-gray-700">Marca (Auto)</label>
                            <input type="text" id="gasolina-marca" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-gray-200" readonly>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <label for="gasolina-fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="gasolina-fecha" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="gasolina-cantidad" class="block text-sm font-medium text-gray-700">Cantidad (Lts)</label>
                            <input type="number" id="gasolina-cantidad" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="gasolina-price" class="block text-sm font-medium text-gray-700">Precio x Litro</label>
                            <input type="number" id="gasolina-price" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="gasolina-subtotal" class="block text-sm font-medium text-gray-700">Subtotal</label>
                            <input type="number" id="gasolina-subtotal" step="0.01" oninput="window.updateGasolinaTotal()" class="mt-1 w-full p-3 border border-gray-300 rounded-lg font-bold bg-yellow-100">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="gasolina-iva" class="block text-sm font-medium text-gray-700">IVA (16%)</label>
                            <input type="number" id="gasolina-iva" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-gray-200" readonly>
                        </div>
                        <div>
                            <label for="gasolina-total" class="block text-sm font-medium text-gray-700">Total</label>
                            <input type="number" id="gasolina-total" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg bg-gray-200 font-bold" readonly>
                        </div>
                        <div>
                            <label for="gasolina-formapago" class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                            <select id="gasolina-formapago" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Tarjeta Crédito">Tarjeta Crédito</option>
                                <option value="Tarjeta Débito">Tarjeta Débito</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="gasolina-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                        <input type="file" id="gasolina-comprobante" accept=".pdf" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>


                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('transaction-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal 2: Registro de Maestro de Empleados (Nómina) -->
    <div id="employee-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Registrar Nuevo Empleado</h3>
            <form id="employee-form" onsubmit="window.saveEmployee(event)">
                <input type="hidden" id="employee-id">
                <div class="space-y-4">
                    <div>
                        <label for="employee-name" class="block text-sm font-medium text-gray-700">Nombre del Empleado</label>
                        <input type="text" id="employee-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="employee-company" class="block text-sm font-medium text-gray-700">Empresa</label>
                        <select id="employee-company" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                            <option value="UDC">UDC</option>
                            <option value="IESM">IESM</option>
                            <option value="Externo">Externo</option>
                        </select>
                    </div>
                    <div>
                        <label for="employee-salary" class="block text-sm font-medium text-gray-700">Salario Mensual Bruto</label>
                        <input type="number" id="employee-salary" step="0.01" required oninput="window.updateEmployeeQuincenalDisplay(this)" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <p class="text-sm font-semibold text-green-600">Salario Quincenal Estimado: <span id="quincenal-display">$0.00</span></p>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('employee-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Empleado</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 3: Registro de Pago Quincenal (Nómina) -->
    <div id="pay-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Registrar Pago de Nómina</h3>
            <form id="pay-form" onsubmit="window.savePayrollPayment(event)">
                <input type="hidden" id="pay-employee-id">
                <input type="hidden" id="pay-amount-base">
                <div class="space-y-4">
                    <p class="text-lg font-semibold text-gray-700">Empleado: <span id="pay-employee-name-display" class="text-blue-600"></span></p>
                    <p class="text-lg font-semibold text-gray-700">Monto Quincenal: <span id="pay-amount-display" class="text-green-600"></span></p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pay-date" class="block text-sm font-medium text-gray-700">Fecha de Pago</label>
                            <input type="date" id="pay-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="pay-quincena" class="block text-sm font-medium text-gray-700">Quincena</label>
                            <select id="pay-quincena" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="first">Primera Quincena</option>
                                <option value="second">Segunda Quincena</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="pay-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                        <input type="file" id="pay-comprobante" accept=".pdf" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('pay-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg">Confirmar Pago</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 4: Registro de Pago a Profesor -->
    <div id="professor-pay-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Registrar Pago a Profesor</h3>
            <form id="professor-pay-form" onsubmit="window.saveProfessorPayment(event)">
                <input type="hidden" id="professor-pay-id">
                <div class="space-y-4">
                    <div>
                        <label for="professor-pay-name" class="block text-sm font-medium text-gray-700">Nombre del Profesor/a</label>
                        <select id="professor-pay-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                            <option value="Profesor A">Profesor A</option>
                            <option value="Profesor B">Profesor B</option>
                            <option value="Profesor C">Profesor C</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="professor-pay-amount" class="block text-sm font-medium text-gray-700">Monto</label>
                            <input type="number" id="professor-pay-amount" step="0.01" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="professor-pay-date" class="block text-sm font-medium text-gray-700">Fecha de Pago</label>
                            <input type="date" id="professor-pay-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="professor-pay-concept" class="block text-sm font-medium text-gray-700">Concepto de Pago</label>
                        <select id="professor-pay-concept" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                            <option value="Quincena">Quincena</option>
                            <option value="Clases Adicionales">Clases Adicionales</option>
                            <option value="Curso/Diplomado">Curso/Diplomado</option>
                            <option value="Honorarios">Honorarios</option>
                        </select>
                    </div>
                    <div>
                        <label for="professor-pay-ref" class="block text-sm font-medium text-gray-700">Referencia de Pago</label>
                        <input type="text" id="professor-pay-ref" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="professor-pay-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                        <input type="file" id="professor-pay-comprobante" accept=".pdf" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('professor-pay-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg">Confirmar Pago</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 5: Registro de Maestro de Alumno (Ingresos) -->
    <div id="student-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Registrar Nuevo Alumno</h3>
            <form id="student-form" onsubmit="window.saveStudent(event)">
                <input type="hidden" id="student-id">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="student-name" class="block text-sm font-medium text-gray-700">Nombre del Alumno</label>
                            <input type="text" id="student-name" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="student-enroll-date" class="block text-sm font-medium text-gray-700">Fecha de Inscripción</label>
                            <input type="date" id="student-enroll-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="student-program" class="block text-sm font-medium text-gray-700">Programa / Carrera</label>
                            <input type="text" id="student-program" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="Maestría en Cirugía Estética">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="student-company" class="block text-sm font-medium text-gray-700">Empresa</label>
                            <select id="student-company" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                <option value="UDC">UDC</option>
                                <option value="IESM">IESM</option>
                            </select>
                        </div>
                        <div>
                            <label for="student-generation" class="block text-sm font-medium text-gray-700">Generación</label>
                            <input type="text" id="student-generation" value="Gen 10" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 border p-4 rounded-lg bg-yellow-50">
                        <div>
                            <label for="student-total-amount" class="block text-sm font-medium text-gray-700">Monto Total del Plan</label>
                            <input type="number" id="student-total-amount" step="0.01" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="student-installments" class="block text-sm font-medium text-gray-700"># de Mensualidades</label>
                            <input type="number" id="student-installments" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="12">
                        </div>
                        <div>
                            <label for="student-discount" class="block text-sm font-medium text-gray-700">Beca/Descuento (%)</label>
                            <input type="number" id="student-discount" step="0.01" max="100" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" value="0">
                        </div>
                    </div>
                    <div>
                        <label for="student-paid-full" class="inline-flex items-center">
                            <input type="checkbox" id="student-paid-full" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                            <span class="ml-2 text-sm text-gray-700 font-semibold">Pagó de Contado (Todo el monto)</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('student-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Alumno</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal 6: Registro de Pago de Alumno -->
    <div id="student-pay-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">Registrar Pago de Colegiatura</h3>
            <form id="student-pay-form" onsubmit="window.saveStudentPayment(event)">
                <input type="hidden" id="pay-student-id">
                <p class="text-lg font-semibold text-gray-700 mb-4">Alumno: <span id="pay-student-name-display" class="text-green-600"></span></p>

                <div class="space-y-4">
                    <div>
                        <label for="student-pay-date" class="block text-sm font-medium text-gray-700">Fecha de Pago</label>
                        <input type="date" id="student-pay-date" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="student-pay-amount" class="block text-sm font-medium text-gray-700">Monto Recibido</label>
                        <input type="number" id="student-pay-amount" step="0.01" required oninput="window.updateStudentPayDisplay(this)" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="student-pay-concept" class="block text-sm font-medium text-gray-700">Concepto de Pago</label>
                        <select id="student-pay-concept" required class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                            <option value="Mensualidad">Mensualidad (Actual)</option>
                            <option value="Adelanto">Adelanto (Varias Mensualidades)</option>
                            <option value="Inscripcion">Inscripción / Reinscripción</option>
                            <option value="Titulación">Titulación</option>
                            <option value="Extraordinario">Examen Extraordinario</option>
                            <option value="Contado">Pago de Contado (Total)</option>
                        </select>
                    </div>
                    <div>
                        <label for="student-pay-ref" class="block text-sm font-medium text-gray-700">Referencia de Pago</label>
                        <input type="text" id="student-pay-ref" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.closeModal('student-pay-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">Registrar Ingreso</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal 7: Modal de Confirmación Genérico (Reemplazo de window.confirm) -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="confirm-title">Confirmar Acción</h3>
            <p class="text-gray-600 mb-6" id="confirm-message">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="flex justify-end space-x-4">
                <button onclick="window.confirmCallback(false)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
                <button onclick="window.confirmCallback(true)" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LÓGICA -->
    <script type="module">
        // Lógica de Autocompletado de Gasolina
        const gasolinaDataMap = {
            'Jorge': { tarjeta: '6576', autos: ['Sentra'] },
            'Diana': { tarjeta: '3451', autos: ['CRV', 'Civic'] },
            'Andres': { tarjeta: '9981', autos: ['Sedan'] },
            'Sentra': 'Nissan',
            'CRV': 'Honda',
            'Civic': 'Honda',
            'Sedan': 'BMW'
        };

        let currentConfirmAction = null;
        let chartInstances = {};
        window.tempFiles = []; // Para la conciliación

        // --- FUNCIONES DE UTILIDAD GENERAL ---

        window.showModal = (id) => { document.getElementById(id).classList.remove('hidden'); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); };

        window.showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            window.switchTab('dashboard'); // Iniciar en el Dashboard
        };

        window.handleLogin = () => {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');

            if (user === 'Dulce' && pass === '1234') {
                errorP.classList.add('hidden');
                window.showAppUI();
            } else {
                errorP.classList.remove('hidden');
            }
        };

        // Reemplazo de window.confirm
        window.showConfirmModal = (message, callback) => {
            document.getElementById('confirm-message').textContent = message;
            currentConfirmAction = callback;
            window.showModal('confirm-modal');
        };

        window.confirmCallback = (result) => {
            window.closeModal('confirm-modal');
            if (currentConfirmAction) {
                currentConfirmAction(result);
                currentConfirmAction = null;
            }
        };
        
        // --- FUNCIÓN DE NAVEGACIÓN ---

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.sidebar-button').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('header button').forEach(el => el.classList.add('hidden'));

            const targetContent = document.getElementById(`content-${tabId}`);
            if (targetContent) {
                targetContent.classList.remove('hidden');
                targetContent.classList.add('active'); // Marca como activa para el listener
                document.getElementById(`nav-${tabId}`).classList.add('active');
                document.getElementById('current-tab-title').textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1);
            }

            // Mostrar botones contextuales
            if (['egresos', 'gasolina'].includes(tabId)) {
                document.getElementById('new-transaction-btn').classList.remove('hidden');
            } else if (tabId === 'ingresos') {
                 // Solo se muestra el botón de nuevo alumno en Ingresos
                document.getElementById('new-student-btn').classList.remove('hidden');
            } else if (tabId === 'nomina') {
                document.getElementById('new-employee-btn').classList.remove('hidden');
            } else if (tabId === 'profesores') {
                document.getElementById('new-professor-pay-btn').classList.remove('hidden');
            }

            // Actualizar la vista al cambiar de pestaña
            if (tabId === 'dashboard') window.updateDashboardSummary();
            else if (tabId === 'ingresos') window.renderStudentsList();
            else if (tabId === 'egresos') window.renderTransactionsList('egreso');
            else if (tabId === 'gasolina') {
                window.renderTransactionsList('gasolina');
                window.renderGasolinaReports();
            }
            else if (tabId === 'nomina') window.renderEmployeesList();
            else if (tabId === 'profesores') window.renderProfessorPaymentsList();
            else if (tabId === 'reportes') window.renderReports();
            else if (tabId === 'conciliacion') window.renderConciliationTable(window.conciliations);
            else if (tabId === 'proyecciones') window.renderProjections();

        };

        // --- BLOQUE: DASHBOARD ---

        window.updateDashboardSummary = () => {
            const totalIngresos = window.transactions.filter(t => t.type === 'ingreso').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalEgresos = window.transactions.filter(t => t.type === 'egreso').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const saldoActual = totalIngresos - totalEgresos;

            const payrollEgresos = window.transactions.filter(t => t.classification === 'Sueldos').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const professorEgresos = window.transactions.filter(t => t.classification === 'Pagos Profesores').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const gasolinaEgresos = window.transactions.filter(t => t.classification === 'Gasolina').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const summaryHTML = `
                <div class="card bg-blue-100 p-6 rounded-xl border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-blue-700">Saldo Actual</p>
                    <p class="text-3xl font-bold mt-1 text-blue-900">${window.formatCurrency(saldoActual)}</p>
                </div>
                <div class="card bg-green-100 p-6 rounded-xl border-l-4 border-green-500">
                    <p class="text-sm font-medium text-green-700">Ingresos Totales</p>
                    <p class="text-3xl font-bold mt-1 text-green-900">${window.formatCurrency(totalIngresos)}</p>
                </div>
                <div class="card bg-red-100 p-6 rounded-xl border-l-4 border-red-500">
                    <p class="text-sm font-medium text-red-700">Egresos Totales</p>
                    <p class="text-3xl font-bold mt-1 text-red-900">${window.formatCurrency(totalEgresos)}</p>
                </div>
            `;
            document.getElementById('dashboard-summary').innerHTML = summaryHTML;

            const kpiHTML = `
                <div class="card bg-purple-100 p-6 rounded-xl border-l-4 border-purple-500">
                    <p class="text-sm font-medium text-purple-700">Gasto Total de Nómina</p>
                    <p class="text-2xl font-bold mt-1 text-purple-900">${window.formatCurrency(payrollEgresos)}</p>
                </div>
                <div class="card bg-indigo-100 p-6 rounded-xl border-l-4 border-indigo-500">
                    <p class="text-sm font-medium text-indigo-700">Pagos a Profesores</p>
                    <p class="text-2xl font-bold mt-1 text-indigo-900">${window.formatCurrency(professorEgresos)}</p>
                </div>
                <div class="card bg-yellow-100 p-6 rounded-xl border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-yellow-700">Gasto Total de Gasolina</p>
                    <p class="text-2xl font-bold mt-1 text-yellow-900">${window.formatCurrency(gasolinaEgresos)}</p>
                </div>
            `;
            document.getElementById('dashboard-kpis').innerHTML = kpiHTML;
            
            // Lista de últimas transacciones
            const latest = window.transactions.sort((a, b) => b.createdAt?.toMillis() - a.createdAt?.toMillis()).slice(0, 10);
            const latestHTML = latest.map(t => `
                <tr class="${t.type === 'ingreso' ? 'bg-green-50' : 'bg-red-50'}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${t.type.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold">${window.formatCurrency(t.amount)}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${t.description || t.classification || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                </tr>
            `).join('');
            document.getElementById('dashboard-latest-list').innerHTML = latestHTML || '<tr><td colspan="4" class="p-4 text-center text-gray-500">No hay transacciones registradas.</td></tr>';
        };

        // --- BLOQUE: INGRESOS (ALUMNOS/COBRANZA) ---

        window.showStudentModal = (student = null) => {
            const form = document.getElementById('student-form');
            form.reset();
            if (student) {
                document.getElementById('student-id').value = student.id;
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-enroll-date').value = student.enrollDate;
                document.getElementById('student-program').value = student.program;
                document.getElementById('student-company').value = student.company;
                document.getElementById('student-generation').value = student.generation;
                document.getElementById('student-total-amount').value = student.totalAmount;
                document.getElementById('student-installments').value = student.installments;
                document.getElementById('student-discount').value = student.discount;
                document.getElementById('student-paid-full').checked = student.paidFull;
            } else {
                document.getElementById('student-id').value = '';
            }
            window.showModal('student-modal');
        };

        window.saveStudent = async (event) => {
            event.preventDefault();
            const studentId = document.getElementById('student-id').value;
            const data = {
                name: document.getElementById('student-name').value,
                enrollDate: document.getElementById('student-enroll-date').value,
                program: document.getElementById('student-program').value,
                company: document.getElementById('student-company').value,
                generation: document.getElementById('student-generation').value,
                totalAmount: parseFloat(document.getElementById('student-total-amount').value),
                installments: parseInt(document.getElementById('student-installments').value),
                discount: parseFloat(document.getElementById('student-discount').value),
                paidFull: document.getElementById('student-paid-full').checked,
                totalPaid: 0, // Inicializar el total pagado
            };

            await window.saveDocument('students', data, studentId);
            window.closeModal('student-modal');
        };

        window.getStudentPaymentStatus = (student) => {
            if (student.paidFull) {
                return { status: 'Pagado Completo', paid: student.totalAmount, required: student.totalAmount, color: 'green' };
            }

            const totalPaid = window.transactions
                .filter(t => t.studentId === student.id && t.type === 'ingreso')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

            const studentMonthlyCost = student.totalAmount * (1 - student.discount / 100) / student.installments;
            
            // Meses transcurridos desde la inscripción (simple)
            const today = new Date();
            const enrollDate = new Date(student.enrollDate);
            const monthsPassed = (today.getFullYear() - enrollDate.getFullYear()) * 12 + (today.getMonth() - enrollDate.getMonth()) + 1;
            
            const requiredAmount = Math.min(monthsPassed, student.installments) * studentMonthlyCost;

            let status;
            let color;
            if (totalPaid >= student.totalAmount * (1 - student.discount / 100)) {
                status = 'Pagado Completo';
                color = 'green';
            } else if (totalPaid > requiredAmount) {
                status = 'Pago Adelantado';
                color = 'blue';
            } else if (totalPaid >= requiredAmount - studentMonthlyCost * 0.1) { // 10% tolerancia
                status = 'Al Día';
                color = 'green';
            } else {
                status = 'Moroso';
                color = 'red';
            }

            return { status, paid: totalPaid, required: requiredAmount, color };
        };

        window.renderStudentsList = () => {
            const container = document.getElementById('students-list-container');
            const sortedStudents = window.students.map(student => ({
                ...student,
                ...window.getStudentPaymentStatus(student)
            })).sort((a, b) => (a.name > b.name) ? 1 : -1);

            let totalAdelantado = 0, totalAlDia = 0, totalMoroso = 0;
            let countAdelantado = 0, countAlDia = 0, countMoroso = 0;

            const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alumno / Programa</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plan Mensual</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Pagado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${sortedStudents.map(s => {
                            const monthlyCost = s.totalAmount * (1 - s.discount / 100) / s.installments;
                            if (s.status === 'Pago Adelantado' || s.status === 'Pagado Completo') {
                                totalAdelantado += 1;
                                countAdelantado++;
                            } else if (s.status === 'Al Día') {
                                totalAlDia += 1;
                                countAlDia++;
                            } else if (s.status === 'Moroso') {
                                totalMoroso += 1;
                                countMoroso++;
                            }
                            const bgColor = s.color === 'green' ? 'bg-green-50' : s.color === 'blue' ? 'bg-blue-50' : 'bg-red-50';
                            const textColor = s.color === 'green' ? 'text-green-700' : s.color === 'blue' ? 'text-blue-700' : 'text-red-700';

                            return `
                                <tr class="${bgColor}">
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                        ${s.name} <br><span class="text-xs text-gray-500">${s.program} (${s.generation})</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm">${window.formatCurrency(monthlyCost)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold">${window.formatCurrency(s.paid)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${bgColor} ${textColor}">
                                            ${s.status}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                        <button onclick="window.showStudentPayModal('${s.id}', '${s.name}')" class="text-green-600 hover:text-green-900 mr-2 text-sm">Pagar</button>
                                        <button onclick="window.showStudentModal(window.students.find(st => st.id === '${s.id}'))" class="text-blue-600 hover:text-blue-900 mr-2 text-sm">Editar</button>
                                        <button onclick="window.deleteStudent('${s.id}')" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHTML || '<p class="p-4 text-center text-gray-500">No hay alumnos registrados. Comienza a agregar.</p>';
            
            // Actualizar Gráfico de Cobranza
            window.updateCobranzaChart(countAlDia, countMoroso, countAdelantado);
        };

        window.deleteStudent = (studentId) => {
            window.showConfirmModal("¿Estás seguro de eliminar a este alumno y todos sus registros de pago?", (result) => {
                if (result) {
                    window.deleteDocument('students', studentId);
                    // Nota: Idealmente, también deberíamos eliminar las transacciones asociadas.
                }
            });
        };

        window.showStudentPayModal = (studentId, studentName) => {
            const student = window.students.find(s => s.id === studentId);
            document.getElementById('pay-student-id').value = studentId;
            document.getElementById('pay-student-name-display').textContent = studentName;
            document.getElementById('student-pay-form').reset();
            window.showModal('student-pay-modal');
        };

        window.saveStudentPayment = async (event) => {
            event.preventDefault();
            const studentId = document.getElementById('pay-student-id').value;
            const amount = parseFloat(document.getElementById('student-pay-amount').value);

            const paymentData = {
                type: 'ingreso',
                amount: amount,
                date: document.getElementById('student-pay-date').value,
                description: document.getElementById('student-pay-concept').value, // Concepto de pago
                reference: document.getElementById('student-pay-ref').value,
                studentId: studentId, // Enlaza el ingreso al alumno
            };

            // 1. Registrar la transacción como Ingreso
            await window.saveDocument('transactions', paymentData);

            // 2. Opcional: Actualizar el campo totalPaid en el maestro del alumno (Firestore listener se encarga de re-calcular el estado)
            
            window.closeModal('student-pay-modal');
        };
        
        // --- GRÁFICO DE COBRANZA ---

        window.updateCobranzaChart = (alDia, moroso, adelantado) => {
            if (chartInstances.cobranza) chartInstances.cobranza.destroy();

            const ctx = document.getElementById('cobranza-chart').getContext('2d');
            const totalAlumnos = alDia + moroso + adelantado;
            
            if (totalAlumnos === 0) {
                document.getElementById('cobranza-stats').innerHTML = `<p class="text-center text-gray-500">No hay datos de alumnos para la gráfica.</p>`;
                return;
            }

            chartInstances.cobranza = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Al Día', 'Morosos', 'Adelantados'],
                    datasets: [{
                        data: [alDia, moroso, adelantado],
                        backgroundColor: ['#10b981', '#ef4444', '#3b82f6'], // Verde, Rojo, Azul
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const percentage = (value / totalAlumnos * 100).toFixed(1);
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            document.getElementById('cobranza-stats').innerHTML = `
                <p>Total Alumnos: ${totalAlumnos}</p>
                <p class="text-green-600">Al Día: ${alDia}</p>
                <p class="text-red-600">Morosos: ${moroso}</p>
                <p class="text-blue-600">Adelantados: ${adelantado}</p>
            `;
        };
        
        // --- BLOQUE: EGRESOS (ESTÁNDAR/GASOLINA) ---

        window.showTransactionModal = (transaction = null, type = null) => {
            const form = document.getElementById('transaction-form');
            form.reset();
            document.getElementById('transaction-modal-title').textContent = 'Nueva Transacción';
            document.getElementById('transaction-id').value = '';

            const currentTab = document.querySelector('.tab-content.active').id.replace('content-', '');
            const defaultType = type || (['ingresos', 'egresos', 'gasolina'].includes(currentTab) ? currentTab.replace('ses', 'so').replace('lina', 'lina') : 'ingreso');

            document.getElementById('transaction-type').value = defaultType.includes('ingreso') ? 'ingreso' : 'egreso';
            
            // Ocultar/Mostrar campos generales (solo usados por Ingreso/Egreso estándar)
            const showGeneralFields = currentTab !== 'gasolina';
            document.getElementById('general-fields').classList.toggle('hidden', !showGeneralFields);
            
            // Mostrar/Ocultar campos específicos
            const isGasolina = currentTab === 'gasolina';
            const isEgresoStandard = currentTab === 'egresos';

            document.getElementById('egreso-fields').classList.toggle('hidden', !isEgresoStandard);
            document.getElementById('gasolina-fields').classList.toggle('hidden', !isGasolina);
            
            // Lógica específica al abrir el modal
            if (isGasolina) {
                document.getElementById('transaction-modal-title').textContent = 'Registro de Gasolina';
                document.getElementById('egreso-classification').value = 'Gasolina';
                // Resetear y pre-llenar campos de gasolina para el cálculo
                document.getElementById('gasolina-subtotal').value = '';
                document.getElementById('gasolina-iva').value = '0.00';
                document.getElementById('gasolina-total').value = '0.00';
                document.getElementById('gasolina-fecha').valueAsDate = new Date(); 
            } else if (isEgresoStandard) {
                 document.getElementById('transaction-modal-title').textContent = 'Nuevo Egreso Estándar';
                 document.getElementById('egreso-classification').value = 'Gastos Operativos';
            } else if (currentTab === 'ingresos') {
                 document.getElementById('transaction-modal-title').textContent = 'Nuevo Ingreso (Manual)';
            }
            
            window.showModal('transaction-modal');
        };

        window.saveTransaction = async (event) => {
            event.preventDefault();
            const type = document.getElementById('transaction-type').value;
            const transactionId = document.getElementById('transaction-id').value;

            let data = {};
            data.type = type;

            if (type === 'egreso') {
                const isGasolina = document.getElementById('gasolina-fields').classList.contains('hidden') === false;

                if (isGasolina) {
                    const totalGasolina = parseFloat(document.getElementById('gasolina-total').value);
                    data = {
                        ...data,
                        amount: totalGasolina, // Usar TOTAL como el monto
                        date: document.getElementById('gasolina-fecha').value, 
                        description: `Egreso Gasolina: ${document.getElementById('gasolina-auto').value} - ${document.getElementById('gasolina-nombre').value}`,
                        classification: 'Gasolina',
                        gasolina: {
                            fecha: document.getElementById('gasolina-fecha').value,
                            nombre: document.getElementById('gasolina-nombre').value,
                            tarjeta: document.getElementById('gasolina-tarjeta').value,
                            auto: document.getElementById('gasolina-auto').value,
                            marca: document.getElementById('gasolina-marca').value,
                            cantidad: parseFloat(document.getElementById('gasolina-cantidad').value || 0),
                            price: parseFloat(document.getElementById('gasolina-price').value || 0),
                            subtotal: parseFloat(document.getElementById('gasolina-subtotal').value || 0),
                            iva: parseFloat(document.getElementById('gasolina-iva').value || 0),
                            total: totalGasolina,
                            formapago: document.getElementById('gasolina-formapago').value,
                            comprobante: document.getElementById('gasolina-comprobante').files.length ? document.getElementById('gasolina-comprobante').files[0].name : 'N/A',
                        }
                    };
                } else {
                    // Egreso Estándar
                    data = {
                        ...data,
                        amount: parseFloat(document.getElementById('transaction-amount').value),
                        date: document.getElementById('transaction-date').value,
                        description: document.getElementById('transaction-description').value,
                        classification: document.getElementById('egreso-classification').value,
                        provider: document.getElementById('egreso-provider').value,
                        reference: document.getElementById('egreso-ref').value,
                        concept: document.getElementById('egreso-concepto').value,
                        company: document.getElementById('egreso-empresa').value,
                    };
                }
            } else {
                 // Ingreso Estándar (manual)
                 data = {
                    ...data,
                    amount: parseFloat(document.getElementById('transaction-amount').value),
                    date: document.getElementById('transaction-date').value,
                    description: document.getElementById('transaction-description').value,
                    classification: 'Ingresos Generales',
                 }
            }

            await window.saveDocument('transactions', data, transactionId);
            window.closeModal('transaction-modal');
        };

        window.renderTransactionsList = (filter) => {
            let containerId;
            let title;
            let filtered;

            if (filter === 'ingreso') {
                 // Esta sección ya está delegada a renderStudentsList() para la cobranza
                 return;
            } else if (filter === 'egreso') {
                containerId = 'egresos-table';
                title = 'Egresos Estándar';
                filtered = window.transactions.filter(t => t.type === 'egreso' && t.classification !== 'Gasolina' && t.classification !== 'Sueldos' && t.classification !== 'Pagos Profesores');
            } else if (filter === 'gasolina') {
                containerId = 'gasolina-table';
                title = 'Registro de Gasolina';
                filtered = window.transactions.filter(t => t.classification === 'Gasolina');
            }

            const sorted = filtered.sort((a, b) => b.date.localeCompare(a.date));

            if (filter === 'egreso') {
                const html = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor/Solicitante</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref Pago</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        ${sorted.map(t => `
                            <tr class="bg-red-50">
                                <td class="px-4 py-3 text-sm">${t.date}</td>
                                <td class="px-4 py-3 text-sm font-bold text-red-700">${window.formatCurrency(t.amount)}</td>
                                <td class="px-4 py-3 text-sm">${t.provider || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm">${t.concept || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm">${t.classification || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm">${t.reference || 'N/A'}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById(containerId).innerHTML = html || '<p class="p-4 text-center text-gray-500">No hay egresos registrados.</p>';
            } 
            
            else if (filter === 'gasolina') {
                const html = `
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conductor / Auto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forma Pago</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comprobante</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        ${sorted.map(t => `
                            <tr class="bg-blue-50">
                                <td class="px-4 py-3 text-sm">${t.date}</td>
                                <td class="px-4 py-3 text-sm font-medium">${t.gasolina?.nombre || 'N/A'} / ${t.gasolina?.auto || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm">${window.formatCurrency(t.gasolina?.subtotal || 0)}</td>
                                <td class="px-4 py-3 text-sm font-bold text-blue-700">${window.formatCurrency(t.gasolina?.total || 0)}</td>
                                <td class="px-4 py-3 text-sm">${t.gasolina?.formapago || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-green-600">${t.gasolina?.comprobante !== 'N/A' ? 'Adjunto' : 'Pendiente'}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById(containerId).innerHTML = html || '<p class="p-4 text-center text-gray-500">No hay egresos de gasolina registrados.</p>';
            }
        };

        // --- LÓGICA DE GASOLINA Y REPORTES ---

        window.renderGasolinaReports = () => {
            const gasolinaTransactions = window.transactions.filter(t => t.classification === 'Gasolina' && t.gasolina);
            
            if (gasolinaTransactions.length === 0) {
                document.getElementById('gasolina-driver-chart').innerHTML = '<p class="text-center text-gray-500 text-sm">Sin datos para analizar.</p>';
                document.getElementById('gasolina-car-chart').innerHTML = '<p class="text-center text-gray-500 text-sm">Sin datos para analizar.</p>';
                return;
            }

            // --- Gasto por Persona ---
            const driverMap = gasolinaTransactions.reduce((acc, t) => {
                const driver = t.gasolina.nombre || 'Desconocido';
                acc[driver] = (acc[driver] || 0) + (t.gasolina.total || 0);
                return acc;
            }, {});

            window.createPieChart('gasolina-driver-chart', Object.keys(driverMap), Object.values(driverMap), 'Gasto por Conductor');

            // --- Gasto por Vehículo ---
            const carMap = gasolinaTransactions.reduce((acc, t) => {
                const car = t.gasolina.auto || 'Desconocido';
                acc[car] = (acc[car] || 0) + (t.gasolina.total || 0);
                return acc;
            }, {});

            window.createPieChart('gasolina-car-chart', Object.keys(carMap), Object.values(carMap), 'Gasto por Vehículo');
        };

        window.createPieChart = (canvasId, labels, data, title) => {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Generar colores aleatorios para las secciones del pastel
            const backgroundColors = labels.map(() => `hsl(${Math.random() * 360}, 70%, 50%)`);

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${window.formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.updateGasolinaAutoFill = (source) => {
            if (source === 'nombre') {
                const name = document.getElementById('gasolina-nombre').value;
                const tarjeta = gasolinaDataMap[name]?.tarjeta || '';
                document.getElementById('gasolina-tarjeta').value = tarjeta;
            } else if (source === 'auto') {
                const auto = document.getElementById('gasolina-auto').value;
                const marca = gasolinaDataMap[auto] || '';
                document.getElementById('gasolina-marca').value = marca;
            }
        };

        window.updateGasolinaTotal = () => {
            const subtotalInput = document.getElementById('gasolina-subtotal');
            const ivaInput = document.getElementById('gasolina-iva');
            const totalInput = document.getElementById('gasolina-total');
            
            const subtotal = parseFloat(subtotalInput.value) || 0;
            const ivaRate = 0.16;
            
            const iva = subtotal * ivaRate;
            const total = subtotal + iva;
            
            ivaInput.value = iva.toFixed(2);
            totalInput.value = total.toFixed(2);
            
            // Sincronizar con el campo general de monto (para guardar)
            // Se sincroniza, aunque este campo general esté oculto, para que la función saveTransaction lo use
            document.getElementById('transaction-amount').value = total.toFixed(2);
        };
        
        // --- BLOQUE: NÓMINA ---

        window.showEmployeeModal = (employee = null) => {
            const form = document.getElementById('employee-form');
            form.reset();
            document.getElementById('quincenal-display').textContent = '$0.00';
            if (employee) {
                document.getElementById('employee-id').value = employee.id;
                document.getElementById('employee-name').value = employee.name;
                document.getElementById('employee-company').value = employee.company;
                document.getElementById('employee-salary').value = employee.salary;
                document.getElementById('quincenal-display').textContent = window.formatCurrency(employee.salary / 2);
            } else {
                document.getElementById('employee-id').value = '';
            }
            window.showModal('employee-modal');
        };

        window.updateEmployeeQuincenalDisplay = (input) => {
            const monthlySalary = parseFloat(input.value) || 0;
            document.getElementById('quincenal-display').textContent = window.formatCurrency(monthlySalary / 2);
        };

        window.saveEmployee = async (event) => {
            event.preventDefault();
            const employeeId = document.getElementById('employee-id').value;
            const data = {
                name: document.getElementById('employee-name').value,
                company: document.getElementById('employee-company').value,
                salary: parseFloat(document.getElementById('employee-salary').value),
            };
            await window.saveDocument('employees', data, employeeId);
            window.closeModal('employee-modal');
        };

        window.deleteEmployee = (employeeId) => {
            window.showConfirmModal("¿Estás seguro de eliminar a este empleado del maestro?", (result) => {
                if (result) {
                    window.deleteDocument('employees', employeeId);
                }
            });
        };
        
        window.showPayModal = (employee) => {
            document.getElementById('pay-employee-id').value = employee.id;
            document.getElementById('pay-employee-name-display').textContent = employee.name;
            const quincenal = employee.salary / 2;
            document.getElementById('pay-amount-base').value = quincenal;
            document.getElementById('pay-amount-display').textContent = window.formatCurrency(quincenal);
            document.getElementById('pay-date').valueAsDate = new Date();
            window.showModal('pay-modal');
        };

        window.savePayrollPayment = async (event) => {
            event.preventDefault();
            const employeeId = document.getElementById('pay-employee-id').value;
            const amount = parseFloat(document.getElementById('pay-amount-base').value);
            const quincena = document.getElementById('pay-quincena').value;
            const date = document.getElementById('pay-date').value;
            const comprobante = document.getElementById('pay-comprobante').files.length ? document.getElementById('pay-comprobante').files[0].name : 'N/A';
            const employee = window.employees.find(e => e.id === employeeId);

            if (!employee) {
                console.error("Empleado no encontrado.");
                window.closeModal('pay-modal');
                return;
            }

            const paymentData = {
                employeeId: employeeId,
                employeeName: employee.name,
                quincena: quincena,
                date: date,
                amount: amount,
                comprobante: comprobante,
            };

            const transactionData = {
                type: 'egreso',
                amount: amount,
                date: date,
                description: `Pago de Nómina: ${employee.name} - ${quincena === 'first' ? '1ra' : '2da'} Quincena`,
                classification: 'Sueldos', // Clasificación clave
                company: employee.company,
            };

            // Guardar en la colección de transacciones (para el Dashboard)
            await window.saveDocument('transactions', transactionData);
            
            // Guardar en la colección específica de nómina (para el gráfico)
            await window.saveDocument('payroll_payments', paymentData);

            window.closeModal('pay-modal');
        };

        window.renderEmployeesList = async () => {
            const quincena = document.getElementById('nomina-quincena-selector').value;
            const container = document.getElementById('employees-list-container');
            const totalNomina = window.employees.reduce((sum, e) => sum + e.salary / 2, 0);
            
            // Obtener pagos de nómina para la quincena seleccionada
            const paymentsPath = getCollectionPath('payroll_payments');
            let payrollPayments = [];
            if (paymentsPath) {
                const paymentsSnapshot = await getDocs(query(collection(db, paymentsPath), where('quincena', '==', quincena)));
                payrollPayments = paymentsSnapshot.docs.map(doc => doc.data());
            }

            const getPaymentStatus = (employeeId) => {
                return payrollPayments.some(p => p.employeeId === employeeId);
            };

            let paidCount = 0;
            let paidAmount = 0;
            
            const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado / Empresa</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Quincenal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado de Pago</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${window.employees.map(e => {
                            const isPaid = getPaymentStatus(e.id);
                            const quincenal = e.salary / 2;
                            if (isPaid) { paidCount++; paidAmount += quincenal; }
                            
                            const statusColor = isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                            return `
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                        ${e.name} <br><span class="text-xs text-gray-500">${e.company}</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold">${window.formatCurrency(quincenal)}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                            ${isPaid ? 'PAGADO' : 'PENDIENTE'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                        ${!isPaid ? `<button onclick="window.showPayModal({id: '${e.id}', name: '${e.name}', salary: ${e.salary}})" class="text-blue-600 hover:text-blue-900 mr-2 text-sm">PAGAR AHORA</button>` : ''}
                                        <button onclick="window.showEmployeeModal(window.employees.find(em => em.id === '${e.id}'))" class="text-gray-600 hover:text-gray-900 mr-2 text-sm">Editar</button>
                                        <button onclick="window.deleteEmployee('${e.id}')" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHTML || '<p class="p-4 text-center text-gray-500">No hay empleados registrados.</p>';
            
            window.updateNominaChart(totalNomina, paidAmount);
            document.getElementById('total-nomina-display').textContent = window.formatCurrency(totalNomina);
        };
        
        // --- GRÁFICO DE NÓMINA ---

        window.updateNominaChart = (totalNomina, paidAmount) => {
            if (chartInstances.nomina) chartInstances.nomina.destroy();

            const ctx = document.getElementById('nomina-chart').getContext('2d');
            const remainingAmount = totalNomina - paidAmount;
            
            if (totalNomina === 0) {
                document.getElementById('nomina-stats').innerHTML = `<p class="text-center text-gray-500">No hay datos de nómina para la gráfica.</p>`;
                return;
            }

            chartInstances.nomina = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pagado', 'Pendiente'],
                    datasets: [{
                        data: [paidAmount, remainingAmount],
                        backgroundColor: ['#4c51bf', '#f56565'], // Índigo, Rojo
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed;
                                    const percentage = (value / totalNomina * 100).toFixed(1);
                                    return `${context.label}: ${window.formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        // --- BLOQUE: PAGOS A PROFESORES ---

        window.showProfessorPayModal = (payment = null) => {
            const form = document.getElementById('professor-pay-form');
            form.reset();
            document.getElementById('professor-pay-id').value = '';
            if (payment) {
                // Populate form for editing (simplificado)
            }
            window.showModal('professor-pay-modal');
        };

        window.saveProfessorPayment = async (event) => {
            event.preventDefault();
            const amount = parseFloat(document.getElementById('professor-pay-amount').value);
            const date = document.getElementById('professor-pay-date').value;
            const name = document.getElementById('professor-pay-name').value;
            const concept = document.getElementById('professor-pay-concept').value;
            const ref = document.getElementById('professor-pay-ref').value;
            const comprobante = document.getElementById('professor-pay-comprobante').files.length ? document.getElementById('professor-pay-comprobante').files[0].name : 'N/A';

            const paymentData = {
                name: name,
                amount: amount,
                date: date,
                concept: concept,
                reference: ref,
                comprobante: comprobante,
            };

            const transactionData = {
                type: 'egreso',
                amount: amount,
                date: date,
                description: `Pago a Profesor: ${name} (${concept})`,
                classification: 'Pagos Profesores', // Clasificación clave
                reference: ref,
            };

            // 1. Guardar en la colección específica
            await window.saveDocument('professor_payments', paymentData);

            // 2. Guardar en la colección de transacciones (para el Dashboard)
            await window.saveDocument('transactions', transactionData);

            window.closeModal('professor-pay-modal');
        };

        window.renderProfessorPaymentsList = () => {
            const container = document.getElementById('profesor-pagos-table');
            const sorted = window.professorPayments.sort((a, b) => b.date.localeCompare(a.date));

            const html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profesor/a</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referencia</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    ${sorted.map(p => `
                        <tr class="bg-indigo-50">
                            <td class="px-4 py-3 text-sm">${p.date}</td>
                            <td class="px-4 py-3 text-sm font-medium">${p.name}</td>
                            <td class="px-4 py-3 text-sm font-bold text-indigo-700">${window.formatCurrency(p.amount)}</td>
                            <td class="px-4 py-3 text-sm">${p.concept || 'N/A'}</td>
                            <td class="px-4 py-3 text-sm">${p.reference || 'N/A'}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = html || '<p class="p-4 text-center text-gray-500">No hay pagos a profesores registrados.</p>';
        };
        
        // --- BLOQUE: REPORTES (P&G y Flujo de Efectivo) ---

        window.renderReports = () => {
            // 1. Resumen P&G
            const totalIngresos = window.transactions.filter(t => t.type === 'ingreso').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalEgresos = window.transactions.filter(t => t.type === 'egreso').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const utilidadNeta = totalIngresos - totalEgresos;
            
            const pgHTML = `
                <p class="text-green-600 font-bold">Ingresos Totales: ${window.formatCurrency(totalIngresos)}</p>
                <p class="text-red-600 font-bold">Egresos Totales: ${window.formatCurrency(totalEgresos)}</p>
                <hr class="my-2 border-gray-300">
                <p class="${utilidadNeta >= 0 ? 'text-blue-600' : 'text-red-600'} text-xl font-extrabold">
                    Utilidad Neta: ${window.formatCurrency(utilidadNeta)}
                </p>
            `;
            document.getElementById('pg-summary').innerHTML = pgHTML;

            // 2. Gráfico de Flujo de Efectivo Mensual
            const monthlyData = window.transactions.reduce((acc, t) => {
                const date = t.date ? new Date(t.date) : new Date(t.createdAt?.toMillis());
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[monthYear]) acc[monthYear] = { ingresos: 0, egresos: 0 };
                
                const amount = parseFloat(t.amount || 0);
                if (t.type === 'ingreso') acc[monthYear].ingresos += amount;
                if (t.type === 'egreso') acc[monthYear].egresos += amount;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(my => new Date(my).toLocaleString('es-MX', { month: 'long', year: 'numeric' }));
            const ingresosData = sortedMonths.map(my => monthlyData[my].ingresos);
            const egresosData = sortedMonths.map(my => monthlyData[my].egresos);

            if (chartInstances.flujoEfectivo) chartInstances.flujoEfectivo.destroy();

            const ctx = document.getElementById('flujo-efectivo-chart').getContext('2d');
            chartInstances.flujoEfectivo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: ingresosData,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)', // Verde
                        },
                        {
                            label: 'Egresos',
                            data: egresosData,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Rojo
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false },
                        y: { 
                            stacked: false,
                            beginAtZero: true,
                            ticks: { callback: (value) => window.formatCurrency(value) }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${window.formatCurrency(context.parsed.y)}`
                            }
                        }
                    }
                }
            });
        };
        
        // --- BLOQUE: PROYECCIONES ---
        
        const PROJECTION_MONTHS = 6;
        
        window.getProjectionsData = () => {
            const today = new Date();
            const projections = [];
            const studentProjections = {}; // { studentId: totalPaid }

            // 1. Calcular Ingresos Recurrentes Proyectados por alumno
            let totalExpectedMonthlyIncome = 0;
            window.students.forEach(student => {
                if (student.paidFull) return; // No proyectar ingresos de alumnos ya pagados
                
                const totalPaid = window.transactions
                    .filter(t => t.studentId === student.id && t.type === 'ingreso')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                const monthlyCost = student.totalAmount * (1 - student.discount / 100) / student.installments;
                const totalPlan = student.totalAmount * (1 - student.discount / 100);
                const remainingPayments = student.installments - Math.floor(totalPaid / monthlyCost);
                
                // Si ya pagó más del total del plan, no proyectar
                if (totalPaid >= totalPlan) return; 

                // Mes de la primera mensualidad proyectada (el mes siguiente al pago más reciente o a la inscripción)
                let startMonth = new Date(student.enrollDate);
                const lastPayment = window.transactions
                    .filter(t => t.studentId === student.id && t.type === 'ingreso')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    
                if (lastPayment) {
                    startMonth = new Date(lastPayment.date);
                }
                
                totalExpectedMonthlyIncome += monthlyCost; // Sumar para el KPI

                let installmentsLeft = remainingPayments;
                
                for (let i = 0; i < PROJECTION_MONTHS; i++) {
                    if (installmentsLeft <= 0) break;
                    
                    const projectionDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                    const monthKey = `${projectionDate.getFullYear()}-${String(projectionDate.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!projections[monthKey]) {
                        projections[monthKey] = { income: 0, expense: 0, label: projectionDate.toLocaleString('es-MX', { month: 'long', year: 'numeric' }) };
                    }
                    
                    // Si el mes proyectado es posterior o igual al mes de la última mensualidad pagada
                    if (projectionDate >= startMonth) {
                         projections[monthKey].income += monthlyCost;
                         installmentsLeft--;
                    }
                }
            });
            
            // 2. Calcular Egresos Fijos Recurrentes Proyectados (Nómina y Gasolina)
            
            // Nómina (Fijo Mensual)
            const totalNominaMensual = window.employees.reduce((sum, e) => sum + e.salary, 0);

            // Gasolina Promedio (Egreso Gasolina de los últimos 3 meses)
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            const recentGasolina = window.transactions
                .filter(t => t.classification === 'Gasolina' && new Date(t.date) >= threeMonthsAgo)
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
            const monthsCovered = (today.getFullYear() * 12 + today.getMonth()) - (threeMonthsAgo.getFullYear() * 12 + threeMonthsAgo.getMonth());
            const avgGasolinaMensual = monthsCovered > 0 ? recentGasolina / monthsCovered : 0;
            
            const totalFixedExpenseMonthly = totalNominaMensual + avgGasolinaMensual;

            // Aplicar egresos fijos a cada mes proyectado
            for (let i = 0; i < PROJECTION_MONTHS; i++) {
                const projectionDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const monthKey = `${projectionDate.getFullYear()}-${String(projectionDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (!projections[monthKey]) {
                    projections[monthKey] = { income: 0, expense: 0, label: projectionDate.toLocaleString('es-MX', { month: 'long', year: 'numeric' }) };
                }
                
                projections[monthKey].expense += totalFixedExpenseMonthly;
            }

            // Consolidar en un array ordenado
            const sortedKeys = Object.keys(projections).sort();
            const finalProjection = sortedKeys.map(key => ({
                month: projections[key].label,
                income: projections[key].income,
                expense: projections[key].expense,
                netFlow: projections[key].income - projections[key].expense,
            }));
            
            return {
                data: finalProjection,
                nomina: totalNominaMensual,
                gasolina: avgGasolinaMensual,
                studentsCount: window.students.length,
                expectedIncome: totalExpectedMonthlyIncome,
            };
        };

        window.renderProjections = () => {
            const { data, nomina, gasolina, studentsCount } = window.getProjectionsData();
            
            document.getElementById('proj-nomina-display').textContent = window.formatCurrency(nomina);
            document.getElementById('proj-gasolina-display').textContent = window.formatCurrency(gasolina);
            document.getElementById('proj-students-count').textContent = studentsCount;

            const tableBody = document.getElementById('proyecciones-table');
            
            if (data.length === 0) {
                 tableBody.innerHTML = '<p class="p-4 text-center text-gray-500">No hay suficientes datos de alumnos o egresos fijos para generar una proyección.</p>';
                 return;
            }

            let cumulativeBalance = 0; // Usar el saldo actual como punto de partida

            const tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mes Proyectado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingresos (Colegiaturas)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Egresos Fijos (Estimado)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Flujo Neto Mensual</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.map(d => {
                            const netFlowColor = d.netFlow >= 0 ? 'text-green-700' : 'text-red-700';
                            
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm font-semibold">${d.month}</td>
                                    <td class="px-4 py-3 text-sm text-green-600">${window.formatCurrency(d.income)}</td>
                                    <td class="px-4 py-3 text-sm text-red-600">${window.formatCurrency(d.expense)}</td>
                                    <td class="px-4 py-3 text-sm font-bold ${netFlowColor}">${window.formatCurrency(d.netFlow)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            tableBody.innerHTML = tableHTML;

            // Renderizar Gráfico
            if (chartInstances.proyecciones) chartInstances.proyecciones.destroy();

            const ctx = document.getElementById('proyecciones-chart').getContext('2d');
            chartInstances.proyecciones = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.month),
                    datasets: [
                        {
                            label: 'Ingresos Proyectados',
                            data: data.map(d => d.income),
                            borderColor: '#10b981', // Verde
                            tension: 0.1,
                            fill: false,
                        },
                        {
                            label: 'Egresos Proyectados',
                            data: data.map(d => d.expense),
                            borderColor: '#ef4444', // Rojo
                            tension: 0.1,
                            fill: false,
                        },
                        {
                            label: 'Flujo Neto',
                            data: data.map(d => d.netFlow),
                            borderColor: '#3b82f6', // Azul
                            borderWidth: 3,
                            tension: 0.2,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            title: { display: true, text: 'Monto (MXN)' },
                            ticks: { callback: (value) => window.formatCurrency(value) }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${window.formatCurrency(context.parsed.y)}`
                            }
                        }
                    }
                }
            });

        };

        // --- BLOQUE: CONCILIACIÓN (Simulación CSV con Persistencia) ---
        
        window.handleFileSelect = (event) => {
            const fileInput = document.getElementById('file-input');
            window.tempFiles = Array.from(fileInput.files);
            document.getElementById('file-count').textContent = `${window.tempFiles.length} archivos seleccionados`;
        };
        
        document.getElementById('content-conciliacion').addEventListener('dragover', (e) => {
            e.preventDefault();
            document.getElementById('file-drag-area').classList.add('drag-over');
        });
        
        document.getElementById('content-conciliacion').addEventListener('dragleave', (e) => {
            document.getElementById('file-drag-area').classList.remove('drag-over');
        });

        document.getElementById('content-conciliacion').addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('file-drag-area').classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.csv'));
            window.tempFiles = files;
            document.getElementById('file-count').textContent = `${window.tempFiles.length} archivos seleccionados`;
        });

        const readCsvFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Simple CSV to Array of Objects parser for simulation
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2) return resolve([]);
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[\W_]+/g, ''));
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length === headers.length) {
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index].trim();
                            });
                            data.push(row);
                        }
                    }
                    resolve(data);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        };
        
        window.processFiles = async () => {
            if (window.tempFiles.length === 0) {
                document.getElementById('conciliacion-results').innerHTML = '<p class="text-red-500">Por favor, selecciona al menos un archivo CSV.</p>';
                return;
            }
            
            document.getElementById('conciliacion-results').innerHTML = '<p class="text-blue-500">Procesando y guardando datos...</p>';

            const allData = [];
            for (const file of window.tempFiles) {
                try {
                    const fileData = await readCsvFile(file);
                    
                    let empresa = "DESCONOCIDO";
                    if (file.name.toLowerCase().includes("udc")) empresa = "UDC";
                    else if (file.name.toLowerCase().includes("iesm")) empresa = "IESM";
                    else if (file.name.toLowerCase().includes("conacon")) empresa = "CONACON";
                    
                    fileData.forEach(row => {
                        row.empresa = empresa;
                        allData.push(row);
                    });
                } catch (e) {
                    console.error(`Error leyendo archivo ${file.name}:`, e);
                }
            }

            let processedData = allData.filter(d => (d.estatus && d.estatus.toLowerCase() === 'paid') && (d.descripcion && d.descripcion.trim() !== ''));

            // Lista temporal para almacenar promesas de guardado
            const savePromises = [];

            processedData.forEach(d => {
                const montoCargo = parseFloat((d.montocargo || '0').replace('$', '').replace(',', '')) || 0;
                const comision = parseFloat((d.comision || '0').replace('$', '').replace(',', '')) || 0;
                const montoDeposito = montoCargo - comision;

                if (montoCargo === 0) return; // Omitir si no hay monto

                const fechaPago = d.fechadepago || d.fechapago || new Date().toISOString().split('T')[0];
                const descripcion = d.descripcion ? d.descripcion.toLowerCase() : '';
                const clasificacion = window.detectarConciliacion(descripcion);
                
                const conciliationRecord = {
                    Empresa: d.empresa,
                    Referencia: d.referencia_deposito || 'PENDIENTE',
                    'Fecha de Pago': fechaPago,
                    'Monto Cargo': montoCargo,
                    Comisión: comision,
                    'Monto Depósito': montoDeposito,
                    'Tipo de Pago': clasificacion.tipoPago,
                    'Categoría General': clasificacion.categoria,
                    'Programa Académico': clasificacion.programa,
                    Nombre: d.nombre ? d.nombre.toUpperCase() : 'N/A',
                    'ID Orden': d.idorden || 'N/A',
                };
                
                // Guardar cada registro limpio en Firestore
                savePromises.push(window.saveDocument('conciliations', conciliationRecord));
            });

            // Esperar a que se guarden todos los documentos
            await Promise.all(savePromises);
            
            // El listener se encargará de llamar a renderConciliationTable(window.conciliations)
            document.getElementById('file-count').textContent = `0 archivos seleccionados`;
        };
        
        // Funciones de Clasificación (Simulando el script Python)
        window.detectarConciliacion = (desc) => {
            let categoria = "Otro", tipoPago = "Otro", programa = "Otro";

            if (desc.includes("reinscripción")) categoria = "Reinscripción";
            else if (desc.includes("inscripción")) categoria = "Inscripción";
            else if (desc.includes("titulación")) categoria = "Titulación";

            const keywords = ["mensualidad", "inscripción", "titulación", "colegiatura", "examen"];
            for (const palabra of keywords) {
                if (desc.includes(palabra)) { tipoPago = palabra.charAt(0).toUpperCase() + palabra.slice(1); break; }
            }

            if (desc.includes("medicina estética") || desc.includes("estética y longevidad")) programa = "MEyL";
            else if (desc.includes("cirugía estética")) programa = "MxCE";
            else if (desc.includes("criminología")) programa = "MACRI";
            else if (desc.includes("derecho")) programa = "DER";

            return { categoria, tipoPago, programa };
        };

        window.renderConciliationTable = (data) => {
            if (data.length === 0) {
                document.getElementById('conciliacion-results').innerHTML = '<p class="text-gray-500">No hay datos de conciliación guardados. Carga un CSV para comenzar.</p>';
                return;
            }

            // Usamos las claves de un registro para obtener los headers
            const headers = Object.keys(data[0]).filter(k => k !== 'id' && k !== 'createdAt' && k !== 'updatedAt');
            
            const headerHTML = headers.map(h => `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');
            
            const bodyHTML = data.map(row => {
                const cells = headers.map(h => {
                    let value = row[h];
                    // Formatear montos
                    if (['Monto Cargo', 'Comisión', 'Monto Depósito'].includes(h) && typeof value === 'number') {
                        value = window.formatCurrency(value);
                    }
                    return `<td class="px-4 py-3 text-sm">${value || 'N/A'}</td>`;
                }).join('');
                return `<tr class="hover:bg-gray-100">${cells}</tr>`;
            }).join('');

            const tableHTML = `
                <p class="text-sm font-semibold mb-2 text-gray-700">Registros guardados: ${data.length}</p>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>${headerHTML}</tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${bodyHTML}
                    </tbody>
                </table>
                <div class="mt-4 flex justify-end space-x-2">
                    <button onclick="window.downloadConciliationCSV(data)" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Descargar CSV Limpio
                    </button>
                    <button onclick="window.deleteAllConciliations()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Eliminar Todos
                    </button>
                </div>
            `;
            document.getElementById('conciliacion-results').innerHTML = tableHTML;
        };

        window.downloadConciliationCSV = (data) => {
            if (data.length === 0) return;
            const headers = Object.keys(data[0]).filter(k => k !== 'id' && k !== 'createdAt' && k !== 'updatedAt').join(',');
            
            const rows = data.map(row => {
                const rowValues = Object.keys(row).filter(k => k !== 'id' && k !== 'createdAt' && k !== 'updatedAt').map(key => {
                    let value = row[key];
                    // Asegurar que los números se exportan como números puros, sin formato de moneda
                    if (['Monto Cargo', 'Comisión', 'Monto Depósito'].includes(key) && typeof value === 'number') {
                         return value.toFixed(2);
                    }
                    return `"${(value || '').toString().replace(/"/g, '""')}"`;
                });
                return rowValues.join(',');
            }).join('\n');
            
            const csv = `${headers}\n${rows}`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Conciliacion_Datos_Limpios.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        window.deleteAllConciliations = () => {
            window.showConfirmModal("Esta acción eliminará TODOS los registros de conciliación guardados. ¿Estás seguro?", async (result) => {
                if (result) {
                    const deletePromises = window.conciliations.map(c => window.deleteDocument('conciliations', c.id));
                    await Promise.all(deletePromises);
                }
            });
        };
        
        // --- UTILIDAD DE FORMATO PARA ALUMNOS (Corrección del ReferenceError) ---
        window.updateStudentPayDisplay = (input) => {
            // Solo garantiza que se puede acceder a formatCurrency si fuera necesario
            const value = parseFloat(input.value) || 0;
        };
        
    </script>
</body>
</html>
