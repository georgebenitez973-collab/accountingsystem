<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Contable Modular</title>
    <!-- Carga de Tailwind CSS para estilos responsivos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Configuraciones básicas para la tipografía */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Estilo para el botón de la pestaña activa */
        .tab-active {
            background-color: #10b981; /* Esmeralda 500 */
            color: white;
            font-weight: 600;
            border-left: 4px solid #059669; /* Esmeralda 600 */
        }
        .tab-group-title {
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            margin-top: 1rem;
            margin-bottom: 0.25rem;
            font-size: 0.875rem; /* sm */
        }
        /* Clase para el bloque de egreso que se oculta/muestra por JS */
        .egreso-fields {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 700px; /* Suficiente para contener todos los campos */
            opacity: 1;
            overflow: hidden;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        /* Clase para ocultar el bloque con transición */
        .egreso-fields.hidden-manual {
            max-height: 0;
            opacity: 0;
            padding-top: 0 !important;
            margin-top: 0 !important;
            border-top: none !important;
        }
    </style>
</head>
<body>

    <!-- 0. Login Modal Overlay -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-90 flex items-center justify-center transition-opacity duration-300">
        <!-- Contenido del Modal de Login -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Iniciar Sesión</h2>
            <div id="login-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
            <!-- El valor está vacío, usa Dulce para la demo -->
            <input type="text" id="login-username" placeholder="Nombre de usuario" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-4">

            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
            <!-- El valor está vacío, usa 1234 para la demo -->
            <input type="password" id="login-password" placeholder="Contraseña" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mb-6" onkeyup="if(event.key === 'Enter') handleLogin()">

            <button onclick="handleLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 rounded-lg transition-colors duration-200 shadow-lg transform hover:scale-[1.01]">
                Acceder
            </button>

            <!-- Se mantiene la información de las credenciales de demo para el usuario -->
            <p class="text-center text-xs text-gray-500 mt-4">Credenciales de Demo: Usuario: <code class="font-bold text-gray-700">Dulce</code>, Contraseña: <code class="font-bold text-gray-700">1234</code></p>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">

        <!-- 1. Barra de Navegación Lateral (Sidebar) -->
        <aside class="w-64 bg-white shadow-xl flex flex-col transition-all duration-300">
            <div class="p-6 border-b border-gray-100">
                <h1 class="text-2xl font-bold text-gray-800">Caja Pro</h1>
                <p class="text-xs text-gray-500 mt-1">App Contable</p>
            </div>

            <!-- Menú de Pestañas (Refactorizado para incluir las nuevas secciones) -->
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                
                <!-- Grupo 1: Resumen -->
                <button
                    id="tab-dashboard"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200 tab-active"
                    onclick="switchTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    Dashboard
                </button>
                <button
                    id="tab-reports"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('reports')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-2 2m4 0l2-2v13m7-6h-2M4 6h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>
                    Reportes
                </button>

                <!-- Separador de Grupo: Transacciones -->
                <div class="tab-group-title">MOVIMIENTOS</div>
                
                <button
                    id="tab-ingresos"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('ingresos')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Ingresos
                </button>
                <button
                    id="tab-egresos"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('egresos')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Egresos
                </button>
                
                <!-- Gasolina (Filtro de Egresos) -->
                <button
                    id="tab-gasolina"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('gasolina')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 2 2m-2-2v13.5M3 10h18M7 16h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v7a2 2 0 002 2z" /></svg>
                    Gasolina
                </button>

                <!-- Separador de Grupo: Gestión -->
                 <div class="tab-group-title">ADMINISTRACIÓN</div>

                <button
                    id="tab-nomina"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('nomina')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Nómina
                </button>
                <button
                    id="tab-profesores"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('profesores')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M20 10a8 8 0 01-16 0V7a2 2 0 012-2h4M9 16v-1a4 4 0 014-4h.5a4 4 0 014 4v1m-4.5 4H8.25" /></svg>
                    Pagos a Profesores
                </button>
                <button
                    id="tab-conciliacion"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('conciliacion')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Conciliación Bancaria
                </button>
                <button
                    id="tab-proyecciones"
                    class="tab-button w-full flex items-center p-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200"
                    onclick="switchTab('proyecciones')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Proyecciones
                </button>
            </nav>

            <!-- Información del Usuario/ID (MANDATORIO para apps colaborativas) -->
            <div class="p-4 border-t border-gray-100 text-xs bg-gray-50">
                <p class="font-semibold text-gray-600">ID de Usuario (UID):</p>
                <code id="user-id-display" class="block w-full text-xs text-gray-500 truncate mt-1">Cargando...</code>
            </div>
        </aside>

        <!-- 2. Área de Contenido Principal -->
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Barra superior para el nombre de la pestaña actual y acciones -->
            <header class="mb-8 p-4 bg-white shadow rounded-lg flex justify-between items-center">
                <h2 id="current-tab-title" class="text-3xl font-extrabold text-gray-800">Dashboard</h2>
                <!-- Botón para abrir el modal de nueva transacción. Ahora solo se muestra en Ingresos/Egresos/Gasolina -->
                <button id="add-transaction-button" onclick="showTransactionModal()" class="px-4 py-2 bg-emerald-500 text-white rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 hidden">
                    + Nueva Transacción
                </button>
            </header>

            <!-- Contenedores de las Pestañas (Solo una visible a la vez) -->

            <!-- Pestaña 1: Dashboard -->
            <section id="content-dashboard" class="tab-content">
                <!-- Contenido se actualiza dinámicamente -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">¡Bienvenido!</h3>
                    <p class="text-gray-600">Este es el panel principal de tu aplicación contable. Aquí se mostrarán los resúmenes clave (saldos, ingresos/egresos) una vez que carguemos los datos de Transacciones.</p>
                    <div id="loading-state" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-md">
                        Inicializando Firebase y autenticación...
                    </div>
                    <div id="auth-ready" class="hidden mt-4 p-3 bg-green-100 text-green-800 rounded-md">
                        Autenticación de Firebase lista. Ingresa tus credenciales en el modal.
                    </div>
                </div>
            </section>

            <!-- Pestaña 2: Ingresos (Usará la misma lógica de Transacciones, filtrada) -->
            <section id="content-ingresos" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Ingreso' -->
            </section>

            <!-- Pestaña 3: Egresos (Usará la misma lógica de Transacciones, filtrada) -->
            <section id="content-egresos" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Egreso' -->
            </section>

            <!-- Pestaña 4: Gasolina (NUEVA) -->
            <section id="content-gasolina" class="tab-content hidden">
                <!-- Contenido se actualizará por renderTransactionsList con filtro 'Egreso' y clasificación 'Gasolina' -->
            </section>
            
            <!-- Pestaña 5: Reportes -->
            <section id="content-reports" class="tab-content hidden">
                 <!-- Este contenido será llenado por renderReports() -->
            </section>

            <!-- Pestaña 6: Nómina (NUEVA) -->
            <section id="content-nomina" class="tab-content hidden">
                <!-- Contenido de Nómina (Maestro y Pagos) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna 1: Total y Gráfico -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Resumen de Nómina</h3>
                            <p class="text-sm font-medium text-gray-500">Nómina Total Mensual:</p>
                            <p id="nomina-total-mensual" class="text-3xl font-bold text-blue-600 mt-1 mb-4">$0.00</p>
                            
                            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Estado de Pagos (Quincena Actual)</h4>
                            <div class="relative h-64">
                                <canvas id="payrollChart"></canvas>
                            </div>
                            <div id="payroll-status-legend" class="mt-4 text-sm space-y-1">
                                <!-- Leyenda dinámica -->
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2 & 3: Maestro de Empleados y Pagos -->
                    <div class="lg:col-span-2">
                        <!-- Maestro de Empleados -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-700">Maestro de Empleados</h3>
                                <button onclick="showEmployeeModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200">
                                    + Nuevo Empleado
                                </button>
                            </div>
                            <div id="employees-list-container" class="overflow-x-auto">
                                <!-- Tabla de empleados -->
                            </div>
                        </div>

                        <!-- Registro de Pagos Quincenales -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                             <h3 class="text-xl font-semibold text-gray-700 mb-4">Registro de Pagos Quincenales Pendientes</h3>
                             <p class="text-sm text-gray-600 mb-4">Selecciona un empleado para registrar su pago quincenal. Los pagos se registrarán también como **Egresos**.</p>
                             <div id="payroll-payment-list">
                                <!-- Lista de empleados con botones de pago -->
                             </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pestaña 7: Pagos a Profesores (NUEVA) -->
            <section id="content-profesores" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Listado de Pagos a Profesores</h3>
                        <button onclick="showProfessorPayModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition-colors duration-200">
                            + Registrar Pago
                        </button>
                    </div>
                    
                    <div id="professor-payments-list-container" class="overflow-x-auto">
                        <!-- Tabla de pagos a profesores inyectada por JS -->
                    </div>
                </div>
            </section>

             <!-- Pestaña 8: Conciliación Bancaria (NUEVA) -->
            <section id="content-conciliacion" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Herramienta de Conciliación Bancaria (Archivos)</h3>
                    <div id="conciliacion-input" class="mb-6 border-2 border-dashed border-gray-300 p-6 rounded-xl text-center">
                        <label for="conciliation-file-upload" class="cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.885-7.11A5 5 0 0115 7a4 4 0 014 4v3.586a1 1 0 01-.293.707l-3 3a1 1 0 01-.707.293H7z" /></svg>
                            <p class="mt-2 text-sm text-gray-600 font-medium">Arrastra y suelta archivos CSV aquí, o haz clic para subir.</p>
                            <p class="text-xs text-gray-500">(Archivos UDCS, IESM, CONACON)</p>
                        </label>
                        <input type="file" id="conciliation-file-upload" accept=".csv" multiple class="hidden" onchange="handleFileSelection(event)">
                        <div id="file-list" class="mt-4 text-left space-y-1"></div>
                        <button id="process-conciliation-button" onclick="processFiles()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50" disabled>
                            <span id="process-button-text">Procesar Archivos (0)</span>
                        </button>
                    </div>
                    
                    <div id="conciliation-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

                    <div id="conciliation-output" class="hidden">
                        <h4 class="text-xl font-semibold text-gray-700 mb-4">Resultado de Conciliación Limpio</h4>
                        <div id="conciliation-results-table" class="bg-white p-4 rounded-lg shadow-inner overflow-x-auto">
                            <!-- Tabla de resultados inyectada por JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pestaña 9: Proyecciones (NUEVA) -->
            <section id="content-proyecciones" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700">Modelos de Proyección Financiera</h3>
                    <p class="text-gray-600 mt-2">Herramienta para crear y visualizar proyecciones de flujo de efectivo futuras basadas en datos históricos. (Funcionalidad por desarrollar).</p>
                </div>
            </section>

        </main>
    </div>

    <!-- 3. Modal para Agregar/Editar Transacción (Formulario) -->
    <div id="transaction-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <!-- Contenedor del Modal -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Nueva Transacción</h3>
            <!-- Mensaje de error/éxito del formulario -->
             <div id="transaction-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="transaction-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="transaction-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Ingreso">Ingreso</option>
                            <option value="Egreso">Egreso</option>
                        </select>
                    </div>

                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <!-- Deshabilitado para Gasolina, se calcula automáticamente -->
                        <input type="number" id="transaction-amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500 disabled:bg-gray-100">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-detalle" class="block text-sm font-medium text-gray-700">Detalle</label>
                        <input type="text" id="transaction-detalle" required placeholder="Detalle general de la transacción" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <div class="md:col-span-2">
                        <label for="transaction-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>

                    <!-- Bloque de Campos Específicos de Egreso Estándar -->
                    <div id="egreso-standard-fields" class="egreso-fields hidden-manual md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 border-gray-100">
                        <h4 class="md:col-span-2 text-md font-semibold text-gray-600 mb-2">Detalles Adicionales (Egreso Estándar)</h4>

                        <!-- Proveedor/Solicitante -->
                        <div>
                            <label for="transaction-proveedor" class="block text-sm font-medium text-gray-700">Proveedor/Solicitante (Obligatorio)</label>
                            <input type="text" id="transaction-proveedor" placeholder="Nombre del tercero" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Referencia de Pago -->
                        <div>
                            <label for="transaction-referencia" class="block text-sm font-medium text-gray-700">Referencia de Pago</label>
                            <input type="text" id="transaction-referencia" placeholder="Cheque, transferencia, factura #" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Concepto (Cuenta Contable) -->
                        <div>
                            <label for="transaction-concepto" class="block text-sm font-medium text-gray-700">Concepto (Cuenta Contable, Obligatorio)</label>
                            <input type="text" id="transaction-concepto" placeholder="Arriendo, Servicios, Sueldos..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Empresa (Entidad) -->
                        <div>
                            <label for="transaction-empresa" class="block text-sm font-medium text-gray-700">Empresa (Entidad)</label>
                            <input type="text" id="transaction-empresa" placeholder="Sede A, Sede B, General" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>

                        <!-- Clasificación (Dropdown) -->
                        <div class="md:col-span-2">
                            <label for="transaction-clasificacion-standard" class="block text-sm font-medium text-gray-700">Clasificación</label>
                            <select id="transaction-clasificacion-standard" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="Otros Egresos">Otros Egresos</option>
                                <option value="Gastos Dr Conde">Gastos Dr Conde</option>
                                <option value="Gastos Operativos">Gastos Operativos</option>
                                <option value="Gastos Administrativos">Gastos Administrativos</option>
                                <!-- Nota: La clasificación Gasolina se maneja en el bloque específico -->
                            </select>
                        </div>
                    </div>
                    <!-- FIN Bloque Egreso Estándar -->
                    
                    <!-- Bloque de Campos Específicos de Gasolina (NUEVO) -->
                    <div id="egreso-gasolina-fields" class="egreso-fields hidden-manual md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 border-gray-100">
                        <h4 class="md:col-span-2 text-md font-semibold text-gray-600 mb-2">Registro de Factura de Gasolina</h4>

                        <!-- Nombre (Selector para autocompletado de Tarjeta) -->
                        <div>
                            <label for="gasolina-nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                            <select id="gasolina-nombre" class="calc-gasolina-auto mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">-- Seleccionar Nombre --</option>
                                <option value="Jorge">Jorge</option>
                                <option value="María">María</option>
                                <option value="Dulce">Dulce</option>
                            </select>
                        </div>
                        
                        <!-- #Tarjeta (Autocompletado) -->
                        <div>
                            <label for="gasolina-tarjeta" class="block text-sm font-medium text-gray-700"># Tarjeta / Clave</label>
                            <input type="text" id="gasolina-tarjeta" placeholder="Autocompletado..." readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100">
                        </div>
                        
                        <!-- Auto (Selector para autocompletado de Marca) -->
                        <div>
                            <label for="gasolina-auto" class="block text-sm font-medium text-gray-700">Auto</label>
                             <select id="gasolina-auto" class="calc-gasolina-auto mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="">-- Seleccionar Auto --</option>
                                <option value="Sentra">Sentra</option>
                                <option value="Spark">Spark</option>
                                <option value="Pilot">Pilot</option>
                            </select>
                        </div>

                        <!-- Marca (Autocompletado) -->
                        <div>
                            <label for="gasolina-marca" class="block text-sm font-medium text-gray-700">Marca</label>
                            <input type="text" id="gasolina-marca" placeholder="Autocompletado..." readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100">
                        </div>
                        
                        <!-- Cantidad -->
                        <div>
                            <label for="gasolina-cantidad" class="block text-sm font-medium text-gray-700">Cantidad (Litros)</label>
                            <input type="number" id="gasolina-cantidad" step="0.01" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Precio -->
                        <div>
                            <label for="gasolina-precio" class="block text-sm font-medium text-gray-700">Precio (por Litro)</label>
                            <input type="number" id="gasolina-precio" step="0.01" placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        
                        <!-- Subtotal (Ingreso Manual) -->
                        <div>
                            <label for="gasolina-subtotal" class="block text-sm font-medium text-gray-700 font-bold">SUBTOTAL (Ingreso Manual)</label>
                            <input type="number" id="gasolina-subtotal" step="0.01" placeholder="0.00" class="calc-subtotal mt-1 block w-full px-3 py-2 border-2 border-blue-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 font-semibold text-gray-800">
                        </div>
                        
                        <!-- IVA (Calculado) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">IVA (16%)</label>
                            <input type="text" id="gasolina-iva" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100 text-red-600 font-semibold">
                        </div>

                        <!-- Total (Calculado) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">TOTAL (Monto Final)</label>
                            <input type="text" id="gasolina-total" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled:bg-gray-100 text-2xl text-emerald-600 font-bold">
                        </div>
                        
                        <!-- Forma de Pago -->
                        <div class="md:col-span-2">
                            <label for="gasolina-forma-pago" class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                            <select id="gasolina-forma-pago" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="Tarjeta de Credito">Tarjeta de Crédito</option>
                                <option value="Efectivo">Efectivo</option>
                                <option value="Transferencia">Transferencia</option>
                            </select>
                        </div>
                        
                        <!-- Adjuntar Comprobante -->
                        <div class="md:col-span-2">
                            <label for="gasolina-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                            <input type="file" id="gasolina-comprobante" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                        </div>

                    </div>
                    <!-- FIN Bloque Egreso Gasolina -->

                    <!-- Campo oculto para el ID en caso de edición -->
                    <input type="hidden" id="transaction-id">
                    <input type="hidden" id="current-transaction-tab" value="ingresos"> <!-- Nuevo campo para rastrear la pestaña que abrió el modal -->
                    <input type="hidden" id="gasolina-comprobante-url"> <!-- Para guardar la URL si se editara -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideTransactionModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                        Guardar Transacción
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 4. Modal de Confirmación (Reemplazo de window.confirm) -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h4 class="text-lg font-bold text-gray-800 mb-4" id="confirm-title">Confirmar Acción</h4>
            <p class="text-gray-600 mb-6" id="confirm-message">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-proceed" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-md">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Modal para Agregar/Editar Empleado (NUEVO) -->
    <div id="employee-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <!-- Contenedor del Modal -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
            <h3 id="employee-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Nuevo Empleado</h3>
            <div id="employee-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="employee-form">
                <input type="hidden" id="employee-id">

                <div class="mb-4">
                    <label for="employee-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="employee-nombre" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label for="employee-salario" class="block text-sm font-medium text-gray-700">Salario Mensual Bruto ($)</label>
                    <!-- Listener para cálculo quincenal -->
                    <input type="number" id="employee-salario" step="0.01" required 
                           oninput="document.getElementById('salario-quincenal-display').textContent = formatCurrency((parseFloat(this.value) || 0) / 2);"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Salario quincenal: <span id="salario-quincenal-display" class="font-semibold text-blue-600">--</span></p>
                </div>

                <div class="mb-6">
                    <label for="employee-empresa" class="block text-sm font-medium text-gray-700">Empresa / Entidad</label>
                    <select id="employee-empresa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Seleccionar --</option>
                        <option value="UDC">UDC</option>
                        <option value="IESM">IESM</option>
                        <option value="Externo">Externo</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEmployeeModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        Guardar Empleado
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 6. Modal para Registrar Pago de Nómina (NUEVO) -->
    <div id="pay-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity50 flex items-center justify-center">
        <!-- Contenedor del Modal -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Registrar Pago de Nómina</h3>
            <div id="pay-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="pay-form">
                <input type="hidden" id="pay-employee-id">
                <input type="hidden" id="pay-amount">
                <input type="hidden" id="pay-empleado-nombre">
                <input type="hidden" id="pay-empresa">

                <p class="text-lg font-semibold mb-2">Empleado: <span id="pay-employee-name-display" class="text-blue-600"></span></p>
                <p class="text-lg font-semibold mb-4">Monto: <span id="pay-amount-display" class="text-emerald-600"></span></p>

                <div class="mb-4">
                    <label for="pay-quincena" class="block text-sm font-medium text-gray-700">Quincena a Pagar</label>
                    <select id="pay-quincena" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="Q1">Primera Quincena</option>
                        <option value="Q2">Segunda Quincena</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="pay-date" class="block text-sm font-medium text-gray-700">Fecha de Pago</label>
                    <input type="date" id="pay-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div class="mb-6">
                    <label for="pay-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                    <input type="file" id="pay-comprobante" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                    <input type="hidden" id="pay-comprobante-url">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hidePayModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md">
                        Registrar Egreso y Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 7. Modal para Registrar Pago a Profesores (NUEVO) -->
    <div id="professor-pay-modal" class="hidden fixed inset-0 z-40 bg-gray-900 bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Registro de Pago a Profesor</h3>
            <div id="professor-pay-message" class="hidden p-3 mb-4 text-sm rounded-lg text-red-700 bg-red-100 font-medium border border-red-200"></div>

            <form id="professor-pay-form">
                <input type="hidden" id="professor-pay-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- Nombre del Profesor (Ficticio para Demo) -->
                    <div>
                        <label for="professor-pay-nombre" class="block text-sm font-medium text-gray-700">Nombre del Profesor/a</label>
                        <select id="professor-pay-nombre" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="">-- Seleccionar --</option>
                             <option value="Prof. Ana García">Prof. Ana García</option>
                             <option value="Dr. Juan López">Dr. Juan López</option>
                             <option value="Mtra. Elena Díaz">Mtra. Elena Díaz</option>
                             <option value="Lic. Pedro Ruiz">Lic. Pedro Ruiz</option>
                        </select>
                    </div>
                    
                    <!-- Monto -->
                    <div>
                        <label for="professor-pay-monto" class="block text-sm font-medium text-gray-700">Monto ($)</label>
                        <input type="number" id="professor-pay-monto" step="0.01" required placeholder="0.00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Empresa -->
                    <div>
                        <label for="professor-pay-empresa" class="block text-sm font-medium text-gray-700">Empresa / Entidad</label>
                        <select id="professor-pay-empresa" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="UDC">UDC</option>
                            <option value="IESM">IESM</option>
                            <option value="Externo">Externo</option>
                        </select>
                    </div>

                    <!-- Fecha de Pago -->
                    <div>
                        <label for="professor-pay-date" class="block text-sm font-medium text-gray-700">Fecha de Pago</label>
                        <input type="date" id="professor-pay-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <!-- Concepto de Pago -->
                    <div class="md:col-span-2">
                         <label for="professor-pay-concepto" class="block text-sm font-medium text-gray-700">Concepto de Pago (Detalle)</label>
                        <select id="professor-pay-concepto" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">-- Seleccionar --</option>
                            <option value="Pago de Quincena (Q1)">Pago de Quincena (Q1)</option>
                            <option value="Pago de Quincena (Q2)">Pago de Quincena (Q2)</option>
                            <option value="Clases Adicionales / Suplencia">Clases Adicionales / Suplencia</option>
                            <option value="Impartición de Curso / Diplomado">Impartición de Curso / Diplomado</option>
                            <option value="Asesoría de Tesis / Titulación">Asesoría de Tesis / Titulación</option>
                            <option value="Otro">Otro (Especificar en Referencia)</option>
                        </select>
                    </div>
                    
                    <!-- Programa / Referencia -->
                    <div class="md:col-span-2">
                        <label for="professor-pay-referencia" class="block text-sm font-medium text-gray-700">Programa / Referencia de Pago</label>
                        <input type="text" id="professor-pay-referencia" placeholder="Ej: Maestría en Educación Gen 5, o Número de Transferencia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <!-- Adjuntar Comprobante -->
                    <div class="md:col-span-2">
                        <label for="professor-pay-comprobante" class="block text-sm font-medium text-gray-700">Adjuntar Comprobante (PDF)</label>
                        <input type="file" id="professor-pay-comprobante" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <input type="hidden" id="professor-pay-comprobante-url">
                    </div>

                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="hideProfessorPayModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                        Registrar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Lógica de Firebase y de la Aplicación -->
    <script type="module">
        // Importaciones de Firebase (necesarias para la persistencia de datos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Se añaden addDoc, collection y deleteDoc para la gestión de transacciones
        import { getFirestore, setDoc, doc, collection, onSnapshot, query, addDoc, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('debug');

        // Variables Globales OBLIGATORIAS proporcionadas por el entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const IVA_RATE = 0.16; // 16% IVA para cálculos

        let app, db, auth, userId = null;
        let transactions = []; // Almacenará los datos de las transacciones
        let employees = []; // Almacenará el maestro de empleados
        let professorPayments = []; // NUEVO: Almacenará los pagos a profesores
        let monthlyChart = null; // Variable para almacenar la instancia del gráfico (Reportes)
        let payrollChartInstance = null; // Variable para la gráfica de pastel de Nómina
        let activeTab = 'dashboard'; // Nueva variable para rastrear la pestaña activa
        
        // --- MAPA DE DATOS FICTICIO PARA AUTOCOMPLETADO DE GASOLINA ---
        const gasolinaDataMap = {
            nombres: {
                "Jorge": "6576",
                "María": "9801",
                "Dulce": "1234"
            },
            autos: {
                "Sentra": "Nissan",
                "Spark": "Chevrolet",
                "Pilot": "Honda"
            }
        };


        // --- LÓGICA DE AUTENTICACIÓN DEMO ---
        const DEMO_USER = "Dulce";
        const DEMO_PASS = "1234";

        // Función para mostrar la interfaz principal de la aplicación
        const showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            console.log("Inicio de sesión exitoso. Aplicación principal visible.");
        };

        // Función para manejar el inicio de sesión simulado
        window.handleLogin = () => {
            const usernameInput = document.getElementById('login-username').value;
            const passwordInput = document.getElementById('login-password').value;
            const messageDisplay = document.getElementById('login-message');

            messageDisplay.classList.add('hidden');
            messageDisplay.textContent = '';

            if (usernameInput === DEMO_USER && passwordInput === DEMO_PASS) {
                // Login exitoso
                showAppUI();
            } else {
                // Login fallido
                messageDisplay.textContent = "Credenciales incorrectas. Intenta con 'Dulce' / '1234'.";
                messageDisplay.classList.remove('hidden');
                console.warn("Intento de login fallido.");
            }
        };

        // --- LÓGICA DE FIREBASE Y COLLECTIONS ---

        /**
         * Ruta de la colección de transacciones (Egresos/Ingresos).
         */
        const getTransactionsCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore o userId no están disponibles.");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'transactions');
        };
        
         /**
         * Ruta de la colección de empleados (Maestro de Nómina).
         */
        const getEmployeesCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore o userId no están disponibles.");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'employees');
        };
        
        /**
         * NUEVO: Ruta de la colección de pagos a profesores.
         */
        const getProfessorPaymentsCollectionRef = () => {
            if (!db || !userId) {
                console.error("Firestore o userId no están disponibles.");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'professor_payments');
        };

        // Escucha en tiempo real los cambios en las transacciones del usuario
        const setupTransactionsListener = () => {
            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            const q = query(transactionsRef);

            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // Procesamiento y renderizado de transacciones
                console.log("Transacciones cargadas en tiempo real:", transactions);
                
                // Actualiza vistas dependientes de transacciones
                renderTransactionsList('ingresos');
                renderTransactionsList('egresos');
                renderTransactionsList('gasolina');
                updateDashboardSummary();
                
                if (activeTab === 'reports') {
                    renderReports();
                }
                
                // Si la pestaña de nómina está activa, actualizar solo si los empleados ya cargaron
                 if (activeTab === 'nomina' && employees.length > 0) {
                    renderPayrollPaymentTracker();
                    renderPayrollChart();
                }

            }, (error) => {
                console.error("Error al escuchar transacciones:", error);
            });
        };
        
        // NUEVO: Escucha en tiempo real los cambios en la colección de empleados
        const setupEmployeesListener = () => {
            const employeesRef = getEmployeesCollectionRef();
            if (!employeesRef) return;

            const q = query(employeesRef);

            onSnapshot(q, async (snapshot) => {
                employees = [];
                snapshot.forEach((doc) => {
                    employees.push({ id: doc.id, ...doc.data() });
                });

                console.log("Empleados cargados en tiempo real:", employees);
                
                // Si la pestaña de nómina está activa, renderizar la vista de nómina
                if (activeTab === 'nomina') {
                    renderEmployeeList();
                    // También actualizar los pagos si las transacciones ya están listas
                    if (transactions.length > 0) {
                         renderPayrollPaymentTracker();
                         renderPayrollChart();
                    }
                }
            
            }, (error) => {
                console.error("Error al escuchar empleados:", error);
            });
        };
        
        // NUEVO: Escucha en tiempo real los pagos a profesores
        const setupProfessorPaymentsListener = () => {
            const paymentsRef = getProfessorPaymentsCollectionRef();
            if (!paymentsRef) return;

            const q = query(paymentsRef);

            onSnapshot(q, (snapshot) => {
                professorPayments = [];
                snapshot.forEach((doc) => {
                    professorPayments.push({ id: doc.id, ...doc.data() });
                });

                console.log("Pagos a Profesores cargados en tiempo real:", professorPayments);
                
                if (activeTab === 'profesores') {
                    renderProfessorPaymentsList();
                }
            
            }, (error) => {
                console.error("Error al escuchar pagos a profesores:", error);
            });
        };


        // --- MANEJO DE MENSAJES ---

        // Muestra un mensaje temporal en el modal de transacción
        const showTransactionMessage = (message, isError = true) => {
            const msgElement = document.getElementById('transaction-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };
        
        // Muestra un mensaje temporal en el modal de empleado
        const showEmployeeMessage = (message, isError = true) => {
            const msgElement = document.getElementById('employee-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };

        // Muestra un mensaje temporal en el contenedor de conciliación
        const showConciliationMessage = (message, isError = true) => {
            const msgElement = document.getElementById('conciliation-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 8000);
        };

        // NUEVO: Muestra un mensaje temporal en el modal de pago a profesor
        const showProfessorPayMessage = (message, isError = true) => {
            const msgElement = document.getElementById('professor-pay-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-red-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };
        
        // --- UTILS ---
        const formatCurrency = (value) => `$${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        window.formatCurrency = formatCurrency; // FIX: Hacer global para que el HTML pueda acceder

        
        // Determinar la quincena actual (1 o 2) para el rastreador de pagos
        const getCurrentQuincena = () => {
            const day = new Date().getDate();
            return day <= 15 ? 1 : 2;
        };
        
        // Determinar el mes y año actual
        const getCurrentPeriod = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            return { year, month };
        };


        // --- LÓGICA DE TRANSACCIONES (CRUD) ---
        // (saveTransaction, editTransaction, deleteTransaction sin cambios, solo usa las nuevas variables)
        
        window.saveTransaction = async (event) => {
            event.preventDefault();
            // ... (Lógica de saveTransaction) ...
            const id = document.getElementById('transaction-id').value;
            const type = document.getElementById('transaction-type').value;
            
            const detalle = document.getElementById('transaction-detalle').value; 
            const date = document.getElementById('transaction-date').value;

            if (!detalle || !date) {
                showTransactionMessage("Por favor, rellena los campos básicos: Detalle y Fecha."); 
                return;
            }
            
            const isGasolina = (type === 'Egreso' && document.getElementById('egreso-gasolina-fields').classList.contains('active-fields'));

            let amount;

            if (isGasolina) {
                amount = parseFloat(document.getElementById('gasolina-total').value.replace('$', '').replace(',', '')) || 0;
            } else {
                amount = parseFloat(document.getElementById('transaction-amount').value);
            }

            if (isNaN(amount) || amount <= 0) {
                 showTransactionMessage("El Monto Total (o Monto, si no es Gasolina) debe ser positivo."); 
                 return;
            }

            const transactionData = {
                type: type,
                detalle: detalle, 
                date: date,
                timestamp: Date.now(),
                amount: amount 
            };
            
            if (type === 'Egreso') {
                if (isGasolina) {
                    transactionData.clasificacion = 'Gasolina';
                    transactionData.nombre = document.getElementById('gasolina-nombre').value.trim();
                    transactionData.tarjeta = document.getElementById('gasolina-tarjeta').value.trim();
                    transactionData.marca = document.getElementById('gasolina-marca').value.trim();
                    transactionData.auto = document.getElementById('gasolina-auto').value.trim();
                    transactionData.cantidad = parseFloat(document.getElementById('gasolina-cantidad').value) || 0;
                    transactionData.precio = parseFloat(document.getElementById('gasolina-precio').value) || 0;
                    transactionData.subtotal = parseFloat(document.getElementById('gasolina-subtotal').value) || 0;
                    transactionData.iva = parseFloat(document.getElementById('gasolina-iva').value.replace('$', '').replace(',', '')) || 0;
                    transactionData.total = amount; 
                    transactionData.formaPago = document.getElementById('gasolina-forma-pago').value;
                    
                    const comprobanteFile = document.getElementById('gasolina-comprobante').files[0];
                    if (comprobanteFile) {
                        transactionData.comprobanteUrl = `gs://storage-path/${id || 'new'}-${comprobanteFile.name}`;
                    } else {
                        transactionData.comprobanteUrl = document.getElementById('gasolina-comprobante-url').value;
                    }

                } else {
                    transactionData.proveedor = document.getElementById('transaction-proveedor').value.trim();
                    transactionData.referencia = document.getElementById('transaction-referencia').value.trim();
                    transactionData.concepto = document.getElementById('transaction-concepto').value.trim();
                    transactionData.empresa = document.getElementById('transaction-empresa').value.trim();
                    transactionData.clasificacion = document.getElementById('transaction-clasificacion-standard').value;
                    
                    if (!transactionData.proveedor || !transactionData.concepto) {
                        showTransactionMessage("Para Egresos estándar, el Proveedor/Solicitante y el Concepto son obligatorios.");
                        return;
                    }
                }
            }

            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            try {
                if (id) {
                    await setDoc(doc(transactionsRef, id), transactionData);
                    showTransactionMessage("Transacción actualizada con éxito.", false);
                } else {
                    await addDoc(transactionsRef, transactionData);
                    showTransactionMessage("Nueva transacción agregada con éxito.", false);
                }
                setTimeout(hideTransactionModal, 1500); 
            } catch (e) {
                showTransactionMessage(`Error al guardar la transacción: ${e.message}`);
                console.error("Error al guardar la transacción:", e);
            }
        };
        
        window.editTransaction = (id) => { /* ... (Logic remains the same) ... */
             const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            // Llenar campos básicos
            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('transaction-type').value = transaction.type;
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-detalle').value = transaction.detalle || ''; 
            document.getElementById('transaction-date').value = transaction.date;
            
            // Configurar el campo oculto para que el modal sepa qué tipo es al reabrirse
            let tabToOpen = 'ingresos';
            if (transaction.type === 'Ingreso') {
                tabToOpen = 'ingresos';
            } else if (transaction.type === 'Egreso' && transaction.clasificacion === 'Gasolina') {
                 tabToOpen = 'gasolina';
            } else {
                tabToOpen = 'egresos';
            }
            document.getElementById('current-transaction-tab').value = tabToOpen;

            document.getElementById('modal-title').textContent = "Editar Transacción";
            
            // Cargar campos específicos
            if (transaction.type === 'Egreso') {
                if (transaction.clasificacion === 'Gasolina') {
                    document.getElementById('gasolina-nombre').value = transaction.nombre || '';
                    document.getElementById('gasolina-tarjeta').value = transaction.tarjeta || '';
                    document.getElementById('gasolina-marca').value = transaction.marca || '';
                    document.getElementById('gasolina-auto').value = transaction.auto || '';
                    document.getElementById('gasolina-cantidad').value = transaction.cantidad || '';
                    document.getElementById('gasolina-precio').value = transaction.precio || '';
                    document.getElementById('gasolina-forma-pago').value = transaction.formaPago || 'Tarjeta de Credito';
                    document.getElementById('gasolina-comprobante-url').value = transaction.comprobanteUrl || '';
                    
                    document.getElementById('gasolina-subtotal').value = transaction.subtotal ? transaction.subtotal.toFixed(2) : (transaction.amount / (1 + IVA_RATE)).toFixed(2);
                    calculateGasolinaTotals();

                } else {
                    document.getElementById('transaction-proveedor').value = transaction.proveedor || '';
                    document.getElementById('transaction-referencia').value = transaction.referencia || '';
                    document.getElementById('transaction-concepto').value = transaction.concepto || '';
                    document.getElementById('transaction-empresa').value = transaction.empresa || '';
                    document.getElementById('transaction-clasificacion-standard').value = transaction.clasificacion || 'Otros Egresos';
                }
            }

            window.showTransactionModal(true); 
        };

        window.deleteTransaction = async (id) => { /* ... (Logic remains the same) ... */
             const action = async () => {
                const transactionsRef = getTransactionsCollectionRef();
                if (!transactionsRef) return;
                
                try {
                    await deleteDoc(doc(transactionsRef, id));
                    console.log("Transacción eliminada con ID:", id);
                } catch (e) {
                    console.error("Error al eliminar la transacción:", e);
                }
            };
            
            showConfirmModal("Eliminar Transacción", "¿Estás seguro de que quieres eliminar esta transacción? Esta acción es irreversible.", action);
        };

        // --- LÓGICA DE EMPLEADOS (CRUD) ---

        window.showEmployeeModal = (employee = null) => {
            document.getElementById('employee-form').reset();
            document.getElementById('employee-id').value = '';
            document.getElementById('salario-quincenal-display').textContent = '--';
            document.getElementById('employee-message').classList.add('hidden');
            
            if (employee) {
                document.getElementById('employee-modal-title').textContent = "Editar Empleado";
                document.getElementById('employee-id').value = employee.id;
                document.getElementById('employee-nombre').value = employee.nombre;
                document.getElementById('employee-salario').value = employee.salarioMensual;
                document.getElementById('employee-empresa').value = employee.empresa;
                document.getElementById('salario-quincenal-display').textContent = formatCurrency(employee.salarioMensual / 2);
            } else {
                document.getElementById('employee-modal-title').textContent = "Nuevo Empleado";
            }
            
            document.getElementById('employee-modal').classList.remove('hidden');
        };

        window.hideEmployeeModal = () => {
            document.getElementById('employee-modal').classList.add('hidden');
        };

        document.getElementById('employee-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const id = document.getElementById('employee-id').value;
            const nombre = document.getElementById('employee-nombre').value.trim();
            const salarioMensual = parseFloat(document.getElementById('employee-salario').value) || 0;
            const empresa = document.getElementById('employee-empresa').value;

            if (salarioMensual <= 0) {
                showEmployeeMessage("El salario mensual debe ser mayor a cero.");
                return;
            }
            
            const employeeData = {
                nombre,
                salarioMensual,
                empresa,
                salarioQuincenal: salarioMensual / 2
            };

            const employeesRef = getEmployeesCollectionRef();
            if (!employeesRef) return;

            try {
                if (id) {
                    await setDoc(doc(employeesRef, id), employeeData);
                    showEmployeeMessage("Empleado actualizado con éxito.", false);
                } else {
                    await addDoc(employeesRef, employeeData);
                    showEmployeeMessage("Empleado registrado con éxito.", false);
                }
                setTimeout(hideEmployeeModal, 1500); 
            } catch (e) {
                showEmployeeMessage(`Error al guardar el empleado: ${e.message}`);
                console.error("Error al guardar el empleado:", e);
            }
        });
        
        window.editEmployee = (id) => {
            const employee = employees.find(e => e.id === id);
            if (employee) {
                showEmployeeModal(employee);
            }
        };

        window.deleteEmployee = (id) => {
            const action = async () => {
                const employeesRef = getEmployeesCollectionRef();
                if (!employeesRef) return;
                
                try {
                    await deleteDoc(doc(employeesRef, id));
                    console.log("Empleado eliminado con ID:", id);
                } catch (e) {
                    console.error("Error al eliminar el empleado:", e);
                }
            };
            
            showConfirmModal("Eliminar Empleado", "¿Estás seguro de que quieres eliminar a este empleado de la nómina? Esto no elimina los pagos ya realizados.", action);
        };
        
        // --- LÓGICA DE PAGOS DE NÓMINA ---
        
        // Muestra un mensaje temporal en el modal de pago
        const showPayMessage = (message, isError = true) => {
            const msgElement = document.getElementById('pay-message');
            msgElement.textContent = message;
            msgElement.classList.remove('hidden');
            
            if (isError) {
                msgElement.classList.remove('bg-green-100', 'text-green-700');
                msgElement.classList.add('bg-red-100', 'text-red-700');
            } else {
                msgElement.classList.remove('bg-red-100', 'text-green-700');
                msgElement.classList.add('bg-green-100', 'text-green-700');
            }

            setTimeout(() => {
                msgElement.classList.add('hidden');
            }, 5000);
        };

        window.showPayModal = (employee) => {
            document.getElementById('pay-form').reset();
            document.getElementById('pay-employee-id').value = employee.id;
            document.getElementById('pay-amount').value = employee.salarioQuincenal;
            document.getElementById('pay-empleado-nombre').value = employee.nombre;
            document.getElementById('pay-empresa').value = employee.empresa;
            document.getElementById('pay-date').valueAsDate = new Date();
            
            document.getElementById('pay-employee-name-display').textContent = employee.nombre;
            document.getElementById('pay-amount-display').textContent = formatCurrency(employee.salarioQuincenal);
            
            document.getElementById('pay-modal').classList.remove('hidden');
        };

        window.hidePayModal = () => {
            document.getElementById('pay-modal').classList.add('hidden');
        };
        
        document.getElementById('pay-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const employeeId = document.getElementById('pay-employee-id').value;
            const amount = parseFloat(document.getElementById('pay-amount').value);
            const quincena = document.getElementById('pay-quincena').value;
            const date = document.getElementById('pay-date').value;
            const empleadoNombre = document.getElementById('pay-empleado-nombre').value;
            const empresa = document.getElementById('pay-empresa').value;
            
            // Simular manejo de comprobante (solo la URL/nombre)
            const comprobanteFile = document.getElementById('pay-comprobante').files[0];
            let comprobanteUrl = '';
            if (comprobanteFile) {
                comprobanteUrl = `gs://storage-path/pago-nomina-${employeeId}-${quincena}-${comprobanteFile.name}`;
            }

            // Registrar el Egreso en la colección de Transacciones
            const transactionData = {
                type: 'Egreso',
                amount: amount,
                detalle: `Pago de Nómina (${quincena}) a ${empleadoNombre}`, 
                date: date,
                timestamp: Date.now(),
                clasificacion: 'Gastos Operativos', // Se puede ajustar
                proveedor: empleadoNombre,
                concepto: 'Sueldos y Salarios',
                empresa: empresa,
                referencia: quincena, // Usar Q1/Q2 como referencia
                // Datos específicos de nómina para referencia
                payroll_employeeId: employeeId,
                payroll_quincena: quincena,
                payroll_period: `${getCurrentPeriod().year}-${String(getCurrentPeriod().month).padStart(2, '0')}`,
                comprobanteUrl: comprobanteUrl
            };
            
            const transactionsRef = getTransactionsCollectionRef();
            if (!transactionsRef) return;

            try {
                await addDoc(transactionsRef, transactionData);
                showPayMessage("Pago de nómina registrado con éxito como Egreso.", false);
                setTimeout(hidePayModal, 1500);
            } catch (e) {
                showPayMessage(`Error al registrar el pago: ${e.message}`);
                console.error("Error al registrar el pago de nómina:", e);
            }
        });
        
        // --- LÓGICA DE PAGOS A PROFESORES ---
        
        window.showProfessorPayModal = () => {
            document.getElementById('professor-pay-form').reset();
            document.getElementById('professor-pay-id').value = '';
            document.getElementById('professor-pay-date').valueAsDate = new Date();
            document.getElementById('professor-pay-message').classList.add('hidden');
            document.getElementById('professor-pay-modal').classList.remove('hidden');
        };

        window.hideProfessorPayModal = () => {
            document.getElementById('professor-pay-modal').classList.add('hidden');
        };

        document.getElementById('professor-pay-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const id = document.getElementById('professor-pay-id').value;
            const nombre = document.getElementById('professor-pay-nombre').value;
            const monto = parseFloat(document.getElementById('professor-pay-monto').value) || 0;
            const empresa = document.getElementById('professor-pay-empresa').value;
            const concepto = document.getElementById('professor-pay-concepto').value;
            const referencia = document.getElementById('professor-pay-referencia').value;
            const date = document.getElementById('professor-pay-date').value;

            if (monto <= 0 || !nombre || !concepto || !date) {
                showProfessorPayMessage("Por favor, rellena los campos obligatorios (Nombre, Monto, Concepto y Fecha).");
                return;
            }
            
            // Simular manejo de comprobante (solo la URL/nombre)
            const comprobanteFile = document.getElementById('professor-pay-comprobante').files[0];
            let comprobanteUrl = '';
            if (comprobanteFile) {
                comprobanteUrl = `gs://storage-path/pago-profesor-${nombre.replace(/\s/g, '-')}-${date}-${comprobanteFile.name}`;
            }

            const paymentData = {
                nombre,
                monto,
                empresa,
                concepto,
                referencia: referencia || 'N/A',
                date,
                timestamp: Date.now(),
                comprobanteUrl
            };
            
            const professorPaymentsRef = getProfessorPaymentsCollectionRef();
            const transactionsRef = getTransactionsCollectionRef();
            if (!professorPaymentsRef || !transactionsRef) return;

            try {
                let docRef;
                if (id) {
                    await setDoc(doc(professorPaymentsRef, id), paymentData);
                    showProfessorPayMessage("Pago a profesor actualizado con éxito.", false);
                    docRef = doc(professorPaymentsRef, id); // Mantener la referencia para el egreso
                } else {
                    docRef = await addDoc(professorPaymentsRef, paymentData);
                    showProfessorPayMessage("Pago a profesor registrado con éxito.", false);
                }
                
                // 2. Registrar el egreso en la colección general de transacciones
                const transactionData = {
                    type: 'Egreso',
                    amount: monto,
                    detalle: `Pago a profesor: ${nombre} por ${concepto}`, 
                    date: date,
                    timestamp: paymentData.timestamp,
                    clasificacion: 'Gastos Operativos', // Clasificación estándar para pagos
                    proveedor: nombre,
                    concepto: 'Pagos a Profesores',
                    empresa: empresa,
                    referencia: referencia || concepto,
                    // Enlazar al registro específico de profesor
                    professor_payment_id: docRef.id 
                };

                // Podríamos buscar si ya existe una transacción ligada para actualizarla en lugar de crear una nueva,
                // pero para simplificar, registraremos o actualizaremos la transacción principal:
                // Si la lógica fuera 1:1, deberíamos buscar y actualizar el egreso, pero para fines de demo simple,
                // asumiremos que cada registro aquí es un nuevo egreso.

                await addDoc(transactionsRef, transactionData);
                
                setTimeout(hideProfessorPayModal, 1500); 
            } catch (e) {
                showProfessorPayMessage(`Error al guardar el pago: ${e.message}`);
                console.error("Error al guardar el pago a profesor:", e);
            }
        });

        /**
         * Renderiza la tabla de pagos a profesores.
         */
        const renderProfessorPaymentsList = () => {
            const container = document.getElementById('professor-payments-list-container');
            if (professorPayments.length === 0) {
                 container.innerHTML = `<p class="p-4 text-center text-gray-500">No hay pagos a profesores registrados.</p>`;
                 return;
            }

            const sortedPayments = professorPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tableRows = sortedPayments.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.date}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${p.nombre}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600">${p.concepto}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600">${p.referencia}</td>
                    <td class="px-6 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${p.empresa === 'UDC' ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}">
                            ${p.empresa}
                        </span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm text-red-600 font-semibold">${formatCurrency(p.monto)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <a href="#" class="text-blue-600 hover:text-blue-900 transition-colors">Ver</a>
                        <!-- Por simplicidad, solo mostramos el enlace si hay URL de comprobante -->
                        ${p.comprobanteUrl ? `<a href="#" class="text-emerald-600 hover:text-emerald-900 transition-colors">Comprobante</a>` : ''}
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profesor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Referencia</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                </table>
            `;
        };
        

        // --- RENDERING DE NÓMINA ---
        
        let payrollChart = null;

        /**
         * Renderiza la gráfica de pastel del estado de pagos de nómina para la quincena actual.
         */
        const renderPayrollChart = () => {
            const { year, month } = getCurrentPeriod();
            const currentQuincena = `Q${getCurrentQuincena()}`;
            const currentPeriodCode = `${year}-${String(month).padStart(2, '0')}`; // YYYY-MM
            
            // 1. Identificar pagos realizados para el periodo y quincena actual
            const paidEmployeeIds = new Set();
            transactions
                .filter(t => t.payroll_period === currentPeriodCode && t.payroll_quincena === currentQuincena)
                .forEach(t => paidEmployeeIds.add(t.payroll_employeeId));
                
            let totalNomina = 0;
            let totalPagado = 0;
            let totalPendiente = 0;
            
            employees.forEach(emp => {
                totalNomina += emp.salarioQuincenal;
                if (paidEmployeeIds.has(emp.id)) {
                    totalPagado += emp.salarioQuincenal;
                } else {
                    totalPendiente += emp.salarioQuincenal;
                }
            });
            
            // Actualizar resumen
            document.getElementById('nomina-total-mensual').textContent = formatCurrency(totalNomina * 2);

            const data = {
                labels: ['Pagado', 'Pendiente'],
                datasets: [{
                    data: [totalPagado, totalPendiente],
                    backgroundColor: [
                        '#10B981', // green-500
                        '#F87171'  // red-400
                    ],
                    hoverBackgroundColor: [
                        '#059669', 
                        '#EF4444'
                    ]
                }]
            };

            const legendHtml = `
                <p class="text-sm text-gray-700">Quincena a Analizar: **${currentQuincena}** del ${currentPeriodCode}</p>
                <div class="flex items-center mt-2"><span class="w-3 h-3 rounded-full bg-emerald-500 mr-2"></span> Pagado: **${formatCurrency(totalPagado)}** (${((totalPagado / totalNomina) * 100 || 0).toFixed(1)}%)</div>
                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-400 mr-2"></span> Pendiente: **${formatCurrency(totalPendiente)}** (${((totalPendiente / totalNomina) * 100 || 0).toFixed(1)}%)</div>
            `;
            document.getElementById('payroll-status-legend').innerHTML = legendHtml;


            // Destruir gráfico anterior si existe
            if (payrollChart) {
                payrollChart.destroy();
            }

            const ctx = document.getElementById('payrollChart');
            if (ctx) {
                 payrollChart = new Chart(ctx, {
                    type: 'doughnut', // Pastel para el porcentaje progresivo
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%', // Estilo de donut para ver el centro
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const percentage = (value / totalNomina) * 100;
                                        return `${label}: ${formatCurrency(value)} (${percentage.toFixed(1)}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };

        /**
         * Renderiza la tabla maestra de empleados.
         */
        const renderEmployeeList = () => {
            const container = document.getElementById('employees-list-container');
            if (employees.length === 0) {
                 container.innerHTML = `<p class="p-4 text-center text-gray-500">No hay empleados registrados. Usa el botón **+ Nuevo Empleado**.</p>`;
                 return;
            }

            const tableRows = employees.map(e => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${e.nombre}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600">${formatCurrency(e.salarioMensual)}</td>
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-blue-600 font-semibold">${formatCurrency(e.salarioQuincenal)}</td>
                    <td class="px-6 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${e.empresa === 'UDC' ? 'bg-indigo-100 text-indigo-800' : e.empresa === 'IESM' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">
                            ${e.empresa}
                        </span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="editEmployee('${e.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                        <button onclick="deleteEmployee('${e.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empleado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salario Mensual</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salario Quincenal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                </table>
            `;
        };
        
        /**
         * Renderiza la lista de empleados con botones para registrar pagos quincenales.
         */
        const renderPayrollPaymentTracker = () => {
            const listContainer = document.getElementById('payroll-payment-list');
            if (employees.length === 0) {
                 listContainer.innerHTML = `<p class="p-4 text-center text-gray-500">No hay empleados para rastrear pagos.</p>`;
                 return;
            }

            const { year, month } = getCurrentPeriod();
            const currentPeriodCode = `${year}-${String(month).padStart(2, '0')}`; // YYYY-MM
            
            // Obtener pagos realizados en el PERIODO ACTUAL (Mes y Año)
            const payments = transactions
                .filter(t => t.payroll_period === currentPeriodCode)
                .reduce((acc, t) => {
                    const key = `${t.payroll_employeeId}-${t.payroll_quincena}`;
                    acc[key] = {
                        date: t.date,
                        isPaid: true
                    };
                    return acc;
                }, {});

            const quincenaActual = getCurrentQuincena();
            
            const paymentListHtml = employees.map(emp => {
                const isPaidQ1 = payments[`${emp.id}-Q1`];
                const isPaidQ2 = payments[`${emp.id}-Q2`];
                
                // Determinar el estado para la quincena actual (Q1 o Q2)
                const isCurrentQ1 = (quincenaActual === 1);
                const isCurrentQ2 = (quincenaActual === 2);
                
                const getStatusBadge = (isPaid) => {
                    if (isPaid) {
                        return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Pagado (${isPaid.date})</span>`;
                    } else {
                        return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">PENDIENTE</span>`;
                    }
                };
                
                // Botones para Pagar (Solo si está pendiente)
                const payButton = (quincena, isPaid, isCurrent) => {
                    if (isPaid) {
                        return `<button class="text-gray-400 cursor-default" disabled>✔ Registrado</button>`;
                    } else {
                         return `<button onclick="showPayModal(employees.find(e => e.id === '${emp.id}'))" class="text-emerald-600 hover:text-emerald-800 font-semibold transition-colors">${isCurrent ? 'PAGAR AHORA' : 'PAGAR ATRASADO'}</button>`;
                    }
                };

                return `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex-1 min-w-0 mb-2 sm:mb-0">
                            <p class="text-lg font-semibold text-gray-900">${emp.nombre} <span class="text-sm text-gray-500 ml-2">(${emp.empresa})</span></p>
                            <p class="text-sm text-gray-600">${formatCurrency(emp.salarioQuincenal)} Quincenal</p>
                        </div>
                        <div class="flex space-x-4 flex-wrap">
                            <!-- Estado Q1 -->
                            <div class="flex flex-col items-start w-32 mb-2 sm:mb-0">
                                <span class="text-xs font-medium text-gray-500 mb-1">Q1:</span>
                                ${getStatusBadge(isPaidQ1)}
                                ${payButton('Q1', isPaidQ1, isCurrentQ1)}
                            </div>
                            <!-- Estado Q2 -->
                            <div class="flex flex-col items-start w-32">
                                <span class="text-xs font-medium text-gray-500 mb-1">Q2:</span>
                                ${getStatusBadge(isPaidQ2)}
                                ${payButton('Q2', isPaidQ2, isCurrentQ2)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            listContainer.innerHTML = paymentListHtml;
            renderPayrollChart(); // Asegurar que el gráfico se actualice con la lista de pagos
        };


        // --- RENDERING GENERAL ---

        window.showTransactionModal = (isEditing = false) => {
             /* ... (Logic remains the same) ... */
             const transactionTypeSelect = document.getElementById('transaction-type');
            const egresoStandardDiv = document.getElementById('egreso-standard-fields');
            const egresoGasolinaDiv = document.getElementById('egreso-gasolina-fields');
            const transactionAmountInput = document.getElementById('transaction-amount');
            
            // Limpiar formulario y reiniciar campos obligatorios si no estamos editando
            if (!isEditing) {
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-id').value = '';
                document.getElementById('transaction-date').valueAsDate = new Date(); 
                document.getElementById('modal-title').textContent = "Nueva Transacción";
                document.getElementById('transaction-message').classList.add('hidden'); 
                calculateGasolinaTotals(); // Reiniciar cálculos de Gasolina
            }
            
            // 1. Determinar el tipo inicial basado en la pestaña activa
            let determinedType = transactionTypeSelect.value;
            const currentTab = document.getElementById('current-transaction-tab').value;

            if (!isEditing) {
                if (currentTab === 'ingresos') {
                    determinedType = 'Ingreso';
                } else if (currentTab === 'egresos' || currentTab === 'gasolina') {
                    determinedType = 'Egreso';
                }
                transactionTypeSelect.value = determinedType;
            }

            // 2. Toggle visibility and set required status
            const toggleFields = (type) => {
                const isEgreso = type === 'Egreso';
                // La pestaña activa determina si debe verse el formulario detallado de Gasolina
                const isGasolinaTab = isEgreso && currentTab === 'gasolina'; 
                
                // --- Configuración de campos generales ---
                transactionAmountInput.disabled = isGasolinaTab; // Deshabilitar monto si es Gasolina
                transactionAmountInput.required = !isGasolinaTab; // Requerir monto si es Ingreso o Egreso Estándar
                
                // --- Toggle bloques ---
                if (isGasolinaTab) {
                    // Mostrar Gasolina, Ocultar Estándar
                    egresoGasolinaDiv.classList.remove('hidden-manual');
                    egresoGasolinaDiv.classList.add('active-fields');
                    egresoStandardDiv.classList.add('hidden-manual');
                    egresoStandardDiv.classList.remove('active-fields');
                    
                    // Solo requerimos el Subtotal
                    document.getElementById('gasolina-subtotal').required = true;

                    // Remover obligatoriedad de campos de Egreso Estándar
                    document.getElementById('transaction-proveedor').required = false;
                    document.getElementById('transaction-concepto').required = false;

                } else if (isEgreso) {
                    // Mostrar Estándar, Ocultar Gasolina
                    egresoStandardDiv.classList.remove('hidden-manual');
                    egresoStandardDiv.classList.add('active-fields');
                    egresoGasolinaDiv.classList.add('hidden-manual');
                    egresoGasolinaDiv.classList.remove('active-fields');
                    
                    // Hacer obligatorios los campos clave de Egreso Estándar
                    document.getElementById('transaction-proveedor').required = true;
                    document.getElementById('transaction-concepto').required = true;
                    
                    // Remover obligatoriedad de Gasolina
                    document.getElementById('gasolina-subtotal').required = false;

                } else { // Ingreso
                    // Ocultar ambos
                    egresoStandardDiv.classList.add('hidden-manual');
                    egresoStandardDiv.classList.remove('active-fields');
                    egresoGasolinaDiv.classList.add('hidden-manual');
                    egresoGasolinaDiv.classList.remove('active-fields');
                    
                    // Remover obligatoriedad de campos de egreso
                    document.getElementById('transaction-proveedor').required = false;
                    document.getElementById('transaction-concepto').required = false;
                    document.getElementById('gasolina-subtotal').required = false;
                }
            };
            
            toggleFields(determinedType);
            
            // 3. Listener para cambios manuales en el select
            transactionTypeSelect.onchange = () => {
                if (transactionTypeSelect.value === 'Egreso') {
                    document.getElementById('current-transaction-tab').value = 'egresos'; 
                } else {
                    document.getElementById('current-transaction-tab').value = 'ingresos';
                }
                toggleFields(transactionTypeSelect.value);
            };

            // 4. Agregar listeners de cálculo para Subtotal de Gasolina
            document.querySelectorAll('.calc-subtotal').forEach(input => {
                input.oninput = calculateGasolinaTotals;
            });
            
            // 5. Agregar listeners de autocompletado (solo si es la pestaña de gasolina)
            if (currentTab === 'gasolina') {
                 autoCompleteGasolinaFields(); 
                 document.getElementById('gasolina-nombre').onchange = autoCompleteGasolinaFields;
                 document.getElementById('gasolina-auto').onchange = autoCompleteGasolinaFields;
            }
            
            document.getElementById('transaction-modal').classList.remove('hidden');
        };

        window.hideTransactionModal = () => { /* ... (Logic remains the same) ... */
            document.getElementById('transaction-modal').classList.add('hidden');
        };

        const calculateGasolinaTotals = () => { /* ... (Logic remains the same) ... */
            const subtotalInput = document.getElementById('gasolina-subtotal').value;
            const subtotal = parseFloat(subtotalInput) || 0;
            
            if (subtotal <= 0) {
                 document.getElementById('gasolina-iva').value = formatCurrency(0);
                 document.getElementById('gasolina-total').value = formatCurrency(0);
                 document.getElementById('transaction-amount').value = 0;
                 return;
            }

            const iva = subtotal * IVA_RATE;
            const total = subtotal + iva;

            document.getElementById('gasolina-iva').value = formatCurrency(iva);
            document.getElementById('gasolina-total').value = formatCurrency(total);
            
            document.getElementById('transaction-amount').value = total.toFixed(2);
        };
        
        window.autoCompleteGasolinaFields = () => { /* ... (Logic remains the same) ... */
            const nombre = document.getElementById('gasolina-nombre').value;
            const auto = document.getElementById('gasolina-auto').value;
            
            const tarjeta = gasolinaDataMap.nombres[nombre] || '';
            document.getElementById('gasolina-tarjeta').value = tarjeta;

            const marca = gasolinaDataMap.autos[auto] || '';
            document.getElementById('gasolina-marca').value = marca;
        };
        
        const renderTransactionsList = (tabName) => { /* ... (Logic remains the same) ... */
             const contentId = `content-${tabName}`;
            const content = document.getElementById(contentId);
            if (!content) return;

            let title, requiredType, requiredClassification = null;

            if (tabName === 'ingresos') {
                title = 'Listado de Ingresos';
                requiredType = 'Ingreso';
            } else if (tabName === 'egresos') {
                title = 'Listado de Egresos Estándar';
                requiredType = 'Egreso';
                requiredClassification = '!Gasolina'; 
            } else if (tabName === 'gasolina') {
                title = 'Gastos de Gasolina (Egreso Detallado)';
                requiredType = 'Egreso';
                requiredClassification = 'Gasolina';
            } else {
                return;
            }

            let filteredTransactions = transactions.filter(t => t.type === requiredType);

            if (requiredClassification) {
                if (requiredClassification === '!Gasolina') {
                    filteredTransactions = filteredTransactions.filter(t => t.clasificacion !== 'Gasolina' || !t.clasificacion);
                } else {
                    filteredTransactions = filteredTransactions.filter(t => t.clasificacion === requiredClassification);
                }
            }
            
            let tableHeaders, tableBodyMapper;

            if (requiredType === 'Ingreso') {
                tableHeaders = `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.detalle || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-green-600 font-semibold">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            } else if (tabName === 'gasolina') { // Egreso Gasolina
                tableHeaders = `
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Conductor / Auto</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cant.</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">FP</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                 tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900">${t.nombre || 'N/A'} / ${t.auto || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${(t.cantidad || 0).toFixed(2)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${formatCurrency(t.subtotal || 0)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-gray-700">${formatCurrency(t.iva || 0)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm text-red-600 font-semibold">
                            ${formatCurrency(t.total || t.amount)}
                        </td>
                         <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-600">${t.formaPago || 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            } else { // Egreso Estándar
                tableHeaders = `
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor/Solicitante</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clasificación</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                `;
                tableBodyMapper = (t) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.proveedor || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${t.concepto || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                ${t.clasificacion || 'N/A'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-red-600 font-semibold">
                            ${formatCurrency(t.amount)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="editTransaction('${t.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">Editar</button>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                        </td>
                    </tr>
                `;
            }
            
            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 overflow-x-auto">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">${title}</h3>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>${tableHeaders}</tr>
                        </thead>
                        <tbody id="transactions-table-body-${tabName}" class="bg-white divide-y divide-gray-200">
                            <!-- Filas inyectadas por JS -->
                        </tbody>
                    </table>
                    ${filteredTransactions.length === 0 ? `<p class="px-6 py-4 text-center text-gray-500">No hay ${title.toLowerCase().split('de ')[1] || 'transacciones'} registradas.</p>` : ''}
                </div>
            `;
            
            const tbody = document.getElementById(`transactions-table-body-${tabName}`);
            if (!tbody) return;

            const sortedTransactions = filteredTransactions.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB - dateA; 
                }
                return b.timestamp - a.timestamp;
            });

            tbody.innerHTML = sortedTransactions.map(tableBodyMapper).join('');
        };

        const updateDashboardSummary = () => { /* --- MODIFICADO: AÑADIMOS RESUMEN DETALLADO --- */
            let totalIncome = 0;
            let totalExpense = 0;
            let totalPayroll = 0;
            let totalProfessors = 0;
            let totalGasolina = 0;

            transactions.forEach(t => {
                if (t.type === 'Ingreso') {
                    totalIncome += t.amount;
                } else if (t.type === 'Egreso') {
                    totalExpense += t.amount;
                    
                    if (t.concepto === 'Sueldos y Salarios') {
                        totalPayroll += t.amount;
                    } else if (t.concepto === 'Pagos a Profesores') {
                        totalProfessors += t.amount;
                    } else if (t.clasificacion === 'Gasolina') {
                        totalGasolina += t.amount;
                    }
                }
            });

            const currentBalance = totalIncome - totalExpense;

            const balanceClass = currentBalance >= 0 ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';

            const dashboardContent = document.getElementById('content-dashboard');
            dashboardContent.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Resumen General</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                    <!-- Tarjeta de Saldo Actual -->
                    <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Saldo General (Neto)</p>
                        <p class="${balanceClass} mt-1">${formatCurrency(currentBalance)}</p>
                    </div>
                    <!-- Tarjeta de Ingresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-2xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <!-- Tarjeta de Egresos Totales -->
                    <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-2xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-800 mb-6 mt-8">Gastos Operacionales Clave</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <!-- Tarjeta de Nómina -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                        <p class="text-sm font-medium text-gray-500">Gasto de Nómina (Sueldos)</p>
                        <p class="text-xl font-bold text-purple-600 mt-1">${formatCurrency(totalPayroll)}</p>
                    </div>
                     <!-- Tarjeta de Pagos a Profesores -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm font-medium text-gray-500">Pagos a Profesores</p>
                        <p class="text-xl font-bold text-indigo-600 mt-1">${formatCurrency(totalProfessors)}</p>
                    </div>
                    <!-- Tarjeta de Gasolina -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500">
                        <p class="text-sm font-medium text-gray-500">Gasto Total de Gasolina</p>
                        <p class="text-xl font-bold text-orange-600 mt-1">${formatCurrency(totalGasolina)}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Actividad</h3>
                    <p class="text-gray-600">Total de transacciones registradas: <span class="font-bold text-lg text-emerald-600">${transactions.length}</span></p>
                </div>
            `;
        };
        
        const renderReports = () => { /* ... (Logic remains the same) ... */
             const monthlyData = transactions.reduce((acc, t) => {
                const monthYear = t.date.substring(0, 7); 
                const amount = t.amount;
                const type = t.type;

                if (!acc[monthYear]) {
                    acc[monthYear] = { Ingreso: 0, Egreso: 0 };
                }

                acc[monthYear][type] += amount;
                return acc;
            }, {});

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                return `${monthNames[parseInt(month) - 1]}-${year.substring(2)}`;
            });

            const incomeData = sortedMonths.map(my => monthlyData[my].Ingreso);
            const expenseData = sortedMonths.map(my => monthlyData[my].Egreso);

            let totalIncome = 0;
            let totalExpense = 0;
            transactions.forEach(t => {
                if (t.type === 'Ingreso') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            const netProfit = totalIncome - totalExpense;
            const netProfitClass = netProfit >= 0 ? 'text-green-600' : 'text-red-600';


            const content = document.getElementById('content-reports');
            content.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-6">Reporte de Flujo de Efectivo y P&G</h3>
                
                <div id="pg-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Ingresos Totales</p>
                        <p class="text-xl font-bold text-green-600 mt-1">${formatCurrency(totalIncome)}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Egresos Totales</p>
                        <p class="text-xl font-bold text-red-600 mt-1">${formatCurrency(totalExpense)}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Utilidad Neta</p>
                        <p class="text-xl font-bold ${netProfitClass} mt-1">${formatCurrency(netProfit)}</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4">Ingresos vs Egresos Mensuales</h4>
                    <div class="relative h-96">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    ${transactions.length === 0 ? '<p class="text-center text-gray-500 mt-4">Agrega transacciones para ver el gráfico.</p>' : ''}
                </div>
            `;

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            if (transactions.length > 0) {
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: incomeData,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)', 
                                borderColor: 'rgba(5, 150, 105, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Egresos',
                                data: expenseData,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)', 
                                borderColor: 'rgba(220, 38, 38, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Flujo de Efectivo' }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: function(value) { return formatCurrency(value); } } }
                        }
                    }
                });
            }
        };


        // --- LÓGICA DE CONCILIACIÓN BANCARIA (NUEVO) ---
        
        let selectedFiles = []; // Almacena los archivos seleccionados por el usuario

        /**
         * Maneja la selección de archivos y actualiza el botón de procesamiento.
         */
        window.handleFileSelection = (event) => {
            selectedFiles = Array.from(event.target.files);
            const fileListContainer = document.getElementById('file-list');
            const processButton = document.getElementById('process-conciliation-button');
            const buttonText = document.getElementById('process-button-text');
            
            fileListContainer.innerHTML = '';

            if (selectedFiles.length > 0) {
                selectedFiles.forEach(file => {
                    fileListContainer.innerHTML += `<p class="text-xs text-gray-700">- ${file.name}</p>`;
                });
                processButton.disabled = false;
                buttonText.textContent = `Procesar Archivos (${selectedFiles.length})`;
            } else {
                processButton.disabled = true;
                buttonText.textContent = `Procesar Archivos (0)`;
            }
            document.getElementById('conciliation-output').classList.add('hidden');
            document.getElementById('conciliation-message').classList.add('hidden');
        };

        /**
         * Lee un archivo CSV y devuelve los datos como un array de objetos.
         * @param {File} file - El archivo a leer.
         * @returns {Promise<Array>} Un array de objetos con los datos del CSV.
         */
        const readCSVFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        if (lines.length === 0) {
                            resolve([]);
                            return;
                        }
                        
                        // Limpieza de encabezados: quitar espacios y pasar a minúsculas
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
                        const results = [];

                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.trim());
                            if (values.length !== headers.length) continue; // Saltar filas mal formadas

                            let row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index];
                            });
                            results.push(row);
                        }
                        resolve(results);
                    } catch (error) {
                        reject(`Error al parsear el archivo ${file.name}: ${error.message}`);
                    }
                };
                reader.onerror = () => reject(`Error al leer el archivo: ${file.name}`);
                reader.readAsText(file);
            });
        };
        
        // Funciones de Clasificación (Adaptadas del Python a JS)
        
        const detectarCategoria = (desc) => {
            desc = (desc || '').toLowerCase();
            if (desc.includes("reinscripción")) return "Reinscripción";
            if (desc.includes("inscripción")) return "Inscripción";
            if (desc.includes("titulación")) return "Titulación";
            if (desc.includes("diplomado")) return "Diplomado";
            if (desc.includes("extra") || desc.includes("extraordinario")) return "Extras";
            if (desc.includes("semestre")) return "Semestre";
            if (desc.includes("cx")) return "Cursos CX";
            if (desc.includes("generación") || desc.includes("gen")) return "Generación";
            return "Otro";
        };
        
        const detectarTipoPago = (desc) => {
            desc = (desc || '').toLowerCase();
            const keywords = ["mensualidad", "inscripción", "reinscripción", "extra", "extraordinario", "titulación", "diplomado", "anticipo", "matrícula", "registro", "colegiatura", "examen", "seminario", "capacitación"];
            for (const palabra of keywords) {
                if (desc.includes(palabra)) {
                    return palabra.charAt(0).toUpperCase() + palabra.slice(1);
                }
            }
            return "Otro";
        };
        
        const detectarPrograma = (desc) => {
            desc = (desc || '').toLowerCase();
            if (desc.includes("medicina estética") || desc.includes("estética y longevidad")) return "MEyL";
            if (desc.includes("cirugía estética")) return "MxCE";
            if (desc.includes("conacon") || desc.includes("conductas antisociales")) return "TSU";
            if (desc.includes("eco")) return "ECO548";
            if (desc.includes("derecho")) return "DER";
            if (desc.includes("pedagogía")) return "PED";
            if (desc.includes("contaduría")) return "LCP";
            if (desc.includes("administración pública") && desc.includes("doctorado")) return "DOCPUB";
            if (desc.includes("educación") && desc.includes("doctorado")) return "DOCEDU";
            if (desc.includes("criminología")) return "MACRI";
            if (desc.includes("educación") && desc.includes("maestría")) return "MAEDU";
            if (desc.includes("derecho procesal")) return "MADPROC";
            if (desc.includes("maestría en administración")) return "MAADMON";
            return "Otro";
        };

        const carreraNombre = (programa) => {
            const map = {
                "TSU": "Técnico Superior Universitario",
                "ECO548": "Certificación ECO548",
                "DER": "Licenciatura en Derecho",
                "PED": "Licenciatura en Pedagogía",
                "LCP": "Licenciatura en Contaduría Pública",
                "MEyL": "Maestría en Medicina Estética y Longevidad",
                "MxCE": "Maestría en Cirugía Estética",
                "DOCEDU": "Doctorado en Educación",
                "DOCPUB": "Doctorado en Administración Pública",
                "MACRI": "Maestría en Criminología",
                "MAEDU": "Maestría en Educación",
                "MADPROC": "Maestría en Derecho Procesal Penal",
                "MAADMON": "Maestría en Administración y Dirección de Empresas",
                "Otro": "Otro"
            };
            return map[programa] || "Otro";
        };
        
        const separarNombre = (nombre) => {
             if (!nombre) return "";
             let name = nombre.trim();
             // Simulación de re.sub(r'(?<=[A-Z])(?=[A-Z][a-z])', ' ', name) en JS
             name = name.replace(/([A-Z])([A-Z][a-z])/g, '$1 $2');
             return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        };
        
        const getDayOfWeek = (dateString) => {
            const date = new Date(dateString);
            if (isNaN(date)) return "N/A";
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            return days[date.getDay()];
        };

        /**
         * Función principal para procesar los archivos CSV.
         */
        window.processFiles = async () => {
            document.getElementById('process-conciliation-button').disabled = true;
            document.getElementById('conciliation-output').classList.add('hidden');
            showConciliationMessage("Procesando archivos... Esto puede tardar unos segundos.", false);
            
            const allData = [];
            
            try {
                // 1. Leer y Unir Archivos
                for (const file of selectedFiles) {
                    const fileData = await readCSVFile(file);
                    
                    // Detectar empresa desde el nombre del archivo
                    let empresa = "DESCONOCIDO";
                    const fileNameLower = file.name.toLowerCase();
                    if (fileNameLower.includes("udc")) empresa = "UDC";
                    else if (fileNameLower.includes("iesm")) empresa = "IESM";
                    else if (fileNameLower.includes("conacon")) empresa = "CONACON";
                    
                    fileData.forEach(row => {
                        row.empresa = empresa;
                        allData.push(row);
                    });
                }
                
                let datosLimpios = allData;
                
                // 2. FILTRAR PAGOS (Estatus 'paid' y descripción no vacía)
                datosLimpios = datosLimpios.filter(row => 
                    (row.estatus && row.estatus.toLowerCase() === 'paid') && 
                    (row.descripcion && row.descripcion.trim() !== '')
                );
                
                // 3. LIMPIAR Y CALCULAR MONTOS
                datosLimpios.forEach(row => {
                    const cleanNumber = (val) => parseFloat(String(val || '0').replace(/[\$,]/g, '')) || 0;
                    
                    const montoCargo = cleanNumber(row.monto_cargo);
                    const comision = cleanNumber(row.comision);
                    
                    row.monto_cargo = montoCargo;
                    row.comision = comision;
                    row.monto_deposito = montoCargo - comision;
                    
                    // Asegurar que las columnas clave no sean null/NaN después de la limpieza
                    row.isValid = row.monto_cargo !== 0; 
                });
                datosLimpios = datosLimpios.filter(row => row.isValid);
                
                // 4. FECHAS (No es necesario eliminar TZ, pero se formatea)
                datosLimpios.forEach(row => {
                    row.fecha_pago_obj = new Date(row.fecha_pago);
                    row.fecha_deposito_obj = new Date(row.fecha_deposito);
                    
                    row['día semana'] = getDayOfWeek(row.fecha_pago);
                });
                
                // 5. LIMPIAR tipo_transaccion
                datosLimpios.forEach(row => {
                    const tt = (row.tipo_transaccion || '').trim().toLowerCase();
                    if (tt === 'cargo') row.tipo_transaccion = 'Cargo';
                    else if (tt === 'contracargo') row.tipo_transaccion = 'Contracargo';
                    else row.tipo_transaccion = tt;
                });
                
                // 6. APLICAR CLASIFICACIONES
                datosLimpios.forEach(row => {
                    const desc = row.descripcion;
                    row['categoría general'] = detectarCategoria(desc);
                    row['tipo de pago'] = detectarTipoPago(desc);
                    row['programa académico'] = detectarPrograma(desc);
                    
                    // Simular detección de generación (simplificado en JS)
                    const genMatch = desc.match(/gen\s?(\d+)|generación\s?(\d+)/i);
                    row['generación'] = genMatch ? (genMatch[1] || genMatch[2] || '') : '';
                    
                    row['carrera general'] = carreraNombre(row['programa académico']);
                    row['nombre'] = separarNombre(row.nombre);
                    row['referencia_deposito'] = (row.referencia_deposito || '').trim() || 'PENDIENTE';
                    row['id_orden'] = (row.id_orden || '').toString();
                    
                    // Formatear fechas para la visualización
                    row['Fecha de Pago'] = row.fecha_pago_obj.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
                    row['Fecha de Depósito'] = row.fecha_deposito_obj.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
                });
                
                // 7. Renderizar resultados
                renderConciliationResults(datosLimpios);
                showConciliationMessage(`¡Procesamiento completado! Se analizaron ${allData.length} registros, de los cuales ${datosLimpios.length} son pagos limpios.`, false);


            } catch (error) {
                console.error("Error durante el procesamiento de conciliación:", error);
                showConciliationMessage(`Error en el procesamiento: ${error.message}. Asegúrate de que los archivos sean CSV válidos y tengan las columnas esperadas (estatus, descripcion, monto_cargo, comision, fecha_pago, fecha_deposito, id_orden, nombre, moneda, metodo_pago).`);
            } finally {
                document.getElementById('process-conciliation-button').disabled = false;
                document.getElementById('process-button-text').textContent = `Procesar Archivos (${selectedFiles.length})`;
            }
        };

        /**
         * Renderiza la tabla final de resultados limpios.
         */
        const renderConciliationResults = (data) => {
            const outputDiv = document.getElementById('conciliation-output');
            const tableContainer = document.getElementById('conciliation-results-table');
            
            if (data.length === 0) {
                outputDiv.classList.add('hidden');
                return;
            }
            
            outputDiv.classList.remove('hidden');

            const headers = [
                'Empresa', 'Referencia', 'Fecha de Pago', 'Fecha de Depósito', 'Tipo de Transacción', 'Día Semana',
                'Monto Cargo', 'Comisión', 'Monto Depósito', 'Moneda',
                'Método de Pago', 'Nombre',
                'Categoría General', 'Generación', 'Tipo de Pago', 'Programa Académico', 'Carrera General',
                'ID Orden'
            ];
            
            const originalKeys = [
                'empresa', 'referencia_deposito', 'Fecha de Pago', 'Fecha de Depósito', 'tipo_transaccion', 'día semana',
                'monto_cargo', 'comision', 'monto_deposito', 'moneda',
                'metodo_pago', 'nombre',
                'categoría general', 'generación', 'tipo de pago', 'programa académico', 'carrera general',
                'id_orden'
            ];

            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>${headers.map(h => `<th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}</tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            data.forEach(row => {
                tableHtml += `<tr class="hover:bg-green-50">`;
                originalKeys.forEach(key => {
                    let value = row[key] !== undefined ? row[key] : 'N/A';
                    let classList = 'px-3 py-2 whitespace-nowrap text-sm text-gray-700';

                    if (key.includes('monto') || key.includes('comision')) {
                         classList += ' text-right font-semibold';
                         value = formatCurrency(value);
                    } else if (key === 'Tipo de Transacción') {
                         classList += (value === 'Contracargo' ? ' text-red-600' : ' text-green-600');
                    }
                    
                    tableHtml += `<td class="${classList}">${value}</td>`;
                });
                tableHtml += `</tr>`;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        };


        // --- LÓGICA DE INICIALIZACIÓN Y NAVEGACIÓN ---

        const showConfirmModal = (title, message, onConfirm) => { /* ... (Logic remains the same) ... */
             document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const modal = document.getElementById('confirm-modal');
            const btnProceed = document.getElementById('confirm-proceed');
            const btnCancel = document.getElementById('confirm-cancel');

            btnProceed.replaceWith(btnProceed.cloneNode(true));
            btnCancel.replaceWith(btnCancel.cloneNode(true));
            
            const newBtnProceed = document.getElementById('confirm-proceed');
            const newBtnCancel = document.getElementById('confirm-cancel');

            newBtnProceed.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };

            newBtnCancel.onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        };

        const initApp = async () => {
            console.log("Inicializando Firebase...");
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configuración de Firebase no disponible. Usando valores predeterminados.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const authReady = document.getElementById('auth-ready');
                    const userIdDisplay = document.getElementById('user-id-display');
                    const loginModal = document.getElementById('login-modal');

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;

                        loadingState.classList.add('hidden');
                        authReady.classList.remove('hidden');
                        
                        if (document.getElementById('app-container').classList.contains('hidden')) {
                             loginModal.classList.remove('hidden');
                        } else {
                            // Iniciar listeners de Transacciones y Empleados una vez logueado
                            setupTransactionsListener();
                            setupEmployeesListener(); // NUEVO
                            setupProfessorPaymentsListener(); // NUEVO
                        }

                        console.log(`Usuario Firebase autenticado. UID: ${userId}`);

                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'No autenticado';
                        loadingState.textContent = 'Intentando autenticación anónima...';
                        authReady.classList.add('hidden');
                        loadingState.classList.remove('hidden');
                        loginModal.classList.remove('hidden'); 
                        console.warn("Usuario no autenticado, intentando sign-in.");
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                document.getElementById('transaction-form').addEventListener('submit', window.saveTransaction);
                document.getElementById('professor-pay-form').addEventListener('submit', window.saveProfessorPayment); // NUEVO

            } catch (error) {
                console.error("Error al inicializar o autenticar Firebase:", error);
                document.getElementById('loading-state').textContent = `Error crítico: ${error.message}. Verifica la configuración.`;
            }
        };

        // Función global para cambiar de pestaña/vista
        window.switchTab = (tabName) => {
            const tabs = ['dashboard', 'ingresos', 'egresos', 'gasolina', 'reports', 'nomina', 'profesores', 'conciliacion', 'proyecciones'];
            activeTab = tabName; 

            const addButton = document.getElementById('add-transaction-button');
            const transactionTabField = document.getElementById('current-transaction-tab');
            
            if (tabName === 'ingresos' || tabName === 'egresos' || tabName === 'gasolina') {
                addButton.classList.remove('hidden');
                transactionTabField.value = tabName; 
            } else {
                addButton.classList.add('hidden');
            }

            tabs.forEach(tab => {
                document.getElementById(`content-${tab}`).classList.add('hidden');
                document.getElementById(`tab-${tab}`).classList.remove('tab-active');
            });

            const contentElement = document.getElementById(`content-${tabName}`);
            const buttonElement = document.getElementById(`tab-${tabName}`);
            const titleElement = document.getElementById('current-tab-title');

            if (contentElement && buttonElement) {
                contentElement.classList.remove('hidden');
                buttonElement.classList.add('tab-active');
                titleElement.textContent = buttonElement.textContent.trim();
                
                // Llama al renderizado específico si es necesario
                if (tabName === 'ingresos') {
                    renderTransactionsList('ingresos');
                } else if (tabName === 'egresos') {
                    renderTransactionsList('egresos');
                } else if (tabName === 'gasolina') {
                    renderTransactionsList('gasolina');
                } else if (tabName === 'reports' && transactions.length > 0) {
                    renderReports();
                } else if (tabName === 'nomina') { // Nómina
                    renderEmployeeList();
                    if (employees.length > 0) {
                        renderPayrollPaymentTracker();
                        renderPayrollChart();
                    } else {
                         document.getElementById('payroll-payment-list').innerHTML = `<p class="p-4 text-center text-gray-500">Registra empleados para gestionar pagos.</p>`;
                         document.getElementById('nomina-total-mensual').textContent = formatCurrency(0);
                    }
                } else if (tabName === 'profesores') { // NUEVO: Pagos a Profesores
                    renderProfessorPaymentsList();
                }
            }
        };


        window.addEventListener('load', initApp);

        window.showAppUI = () => {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            if (userId) {
                setupTransactionsListener();
                setupEmployeesListener(); // NUEVO
                setupProfessorPaymentsListener(); // NUEVO
            }
        };
        
    </script>
</body>
</html>
